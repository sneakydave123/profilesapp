import { Construct } from 'constructs';
import { NodejsFunction, OutputFormat } from 'aws-cdk-lib/aws-lambda-nodejs';
import * as path from 'path';
import { getCallerDirectory } from './get_caller_directory.js';
import { Duration, Stack, Tags } from 'aws-cdk-lib';
import { Runtime } from 'aws-cdk-lib/aws-lambda';
import { createRequire } from 'module';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { readFileSync } from 'fs';
import { EOL } from 'os';
import { functionOutputKey, } from '@aws-amplify/backend-output-schemas';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { AttributionMetadataStorage } from '@aws-amplify/backend-output-storage';
import { fileURLToPath } from 'node:url';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
import { convertFunctionSchedulesToRuleSchedules } from './schedule_parser.js';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import { Rule } from 'aws-cdk-lib/aws-events';
const functionStackType = 'function-Lambda';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
export const defineFunction = (props = {}) => new FunctionFactory(props, new Error().stack);
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            environment: this.props.environment ?? {},
            runtime: this.resolveRuntime(),
            schedule: this.resolveSchedule(),
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(getCallerDirectory(this.callerStack));
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(getCallerDirectory(this.callerStack), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(getCallerDirectory(this.callerStack), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new Error(`timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`);
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new Error(`memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`);
        }
        return this.props.memoryMB;
    };
    resolveRuntime = () => {
        const runtimeDefault = 18;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new Error(`runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`);
        }
        return this.props.runtime;
    };
    resolveSchedule = () => {
        if (!this.props.schedule) {
            return [];
        }
        return this.props.schedule;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName = 'function';
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        return new AmplifyFunction(scope, this.props.name, this.props, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends Construct {
    resources;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                runtime: nodeVersionMap[props.runtime],
                bundling: {
                    format: OutputFormat.ESM,
                    banner: bannerCode,
                    bundleAwsSDK: true,
                    inject: shims,
                    loader: {
                        '.node': 'file',
                    },
                    minify: true,
                    sourceMap: true,
                },
            });
        }
        catch (error) {
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        try {
            const schedules = convertFunctionSchedulesToRuleSchedules(functionLambda, props.schedule);
            const lambdaTarget = new targets.LambdaFunction(functionLambda);
            schedules.forEach((schedule, index) => {
                // Lambda name will be prepended to rule id, so only using index here for uniqueness
                const rule = new Rule(functionLambda, `schedule${index}`, {
                    schedule,
                });
                rule.addTarget(lambdaTarget);
            });
        }
        catch (error) {
            throw new AmplifyUserError('FunctionScheduleInitializationError', {
                message: 'Failed to instantiate schedule for nodejs function',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput(outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), functionStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    addEnvironment = (key, value) => {
        this.functionEnvironmentTranslator.addEnvironmentEntry(key, value);
    };
    getResourceAccessAcceptor = () => ({
        identifier: `${this.node.id}LambdaResourceAccessAcceptor`,
        acceptResourceAccess: (policy, ssmEnvironmentEntries) => {
            const role = this.resources.lambda.role;
            if (!role) {
                // This should never happen since we are using the Function L2 construct
                throw new Error('No execution role found to attach lambda permissions to');
            }
            policy.attachToRole(role);
            ssmEnvironmentEntries.forEach(({ name, path }) => {
                this.functionEnvironmentTranslator.addSsmEnvironmentEntry(name, path);
            });
        },
    });
    /**
     * Store storage outputs using provided strategy
     */
    storeOutput = (outputStorageStrategy) => {
        outputStorageStrategy.appendToBackendOutputList(functionOutputKey, {
            version: '1',
            payload: {
                definedFunctions: this.resources.lambda.functionName,
            },
        });
    };
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdkMsT0FBTyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUM3RSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEQsT0FBTyxFQUFlLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzlELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDdkMsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFFN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQztBQUNsQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sRUFFTCxpQkFBaUIsR0FDbEIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNwRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNqRixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN2RSxPQUFPLEVBQUUsdUNBQXVDLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRSxPQUFPLEtBQUssT0FBTyxNQUFNLGdDQUFnQyxDQUFDO0FBQzFELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSx3QkFB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RUFDWixHQUFXLEVBQ1gsR0FBVyxFQUNYLEVBQUUsQ0FBQyxHQUFHLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLElBQUksSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7QUFJbEQsTUFBTSxjQUFjLEdBQWlDO0lBQ25ELEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztJQUN2QixFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7SUFDdkIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0NBQ3hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBCYWNrZW5kU2VjcmV0LFxuICBCYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yLFxuICBDb25zdHJ1Y3RGYWN0b3J5LFxuICBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyxcbiAgRnVuY3Rpb25SZXNvdXJjZXMsXG4gIEdlbmVyYXRlQ29udGFpbmVyRW50cnlQcm9wcyxcbiAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnksXG4gIFJlc291cmNlTmFtZVZhbGlkYXRvcixcbiAgUmVzb3VyY2VQcm92aWRlcixcbiAgU3NtRW52aXJvbm1lbnRFbnRyeSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IE5vZGVqc0Z1bmN0aW9uLCBPdXRwdXRGb3JtYXQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLW5vZGVqcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZ2V0Q2FsbGVyRGlyZWN0b3J5IH0gZnJvbSAnLi9nZXRfY2FsbGVyX2RpcmVjdG9yeS5qcyc7XG5pbXBvcnQgeyBEdXJhdGlvbiwgU3RhY2ssIFRhZ3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDZm5GdW5jdGlvbiwgUnVudGltZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgY3JlYXRlUmVxdWlyZSB9IGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgeyBGdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvciB9IGZyb20gJy4vZnVuY3Rpb25fZW52X3RyYW5zbGF0b3IuanMnO1xuaW1wb3J0IHsgUG9saWN5IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyByZWFkRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQge1xuICBGdW5jdGlvbk91dHB1dCxcbiAgZnVuY3Rpb25PdXRwdXRLZXksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHlwZV9nZW5lcmF0b3IuanMnO1xuaW1wb3J0IHsgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc3RvcmFnZSc7XG5pbXBvcnQgeyBmaWxlVVJMVG9QYXRoIH0gZnJvbSAnbm9kZTp1cmwnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciwgVGFnTmFtZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IGNvbnZlcnRGdW5jdGlvblNjaGVkdWxlc1RvUnVsZVNjaGVkdWxlcyB9IGZyb20gJy4vc2NoZWR1bGVfcGFyc2VyLmpzJztcbmltcG9ydCAqIGFzIHRhcmdldHMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWV2ZW50cy10YXJnZXRzJztcbmltcG9ydCB7IFJ1bGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZXZlbnRzJztcblxuY29uc3QgZnVuY3Rpb25TdGFja1R5cGUgPSAnZnVuY3Rpb24tTGFtYmRhJztcblxuZXhwb3J0IHR5cGUgQWRkRW52aXJvbm1lbnRGYWN0b3J5ID0ge1xuICBhZGRFbnZpcm9ubWVudDogKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIHwgQmFja2VuZFNlY3JldCkgPT4gdm9pZDtcbn07XG5cbmV4cG9ydCB0eXBlIENyb25TY2hlZHVsZSA9XG4gIHwgYCR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ31gXG4gIHwgYCR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9ICR7c3RyaW5nfSAke3N0cmluZ30gJHtzdHJpbmd9YDtcbmV4cG9ydCB0eXBlIFRpbWVJbnRlcnZhbCA9XG4gIHwgYGV2ZXJ5ICR7bnVtYmVyfW1gXG4gIHwgYGV2ZXJ5ICR7bnVtYmVyfWhgXG4gIHwgYGV2ZXJ5IGRheWBcbiAgfCBgZXZlcnkgd2Vla2BcbiAgfCBgZXZlcnkgbW9udGhgXG4gIHwgYGV2ZXJ5IHllYXJgO1xuZXhwb3J0IHR5cGUgRnVuY3Rpb25TY2hlZHVsZSA9IFRpbWVJbnRlcnZhbCB8IENyb25TY2hlZHVsZTtcblxuLyoqXG4gKiBFbnRyeSBwb2ludCBmb3IgZGVmaW5pbmcgYSBmdW5jdGlvbiBpbiB0aGUgQW1wbGlmeSBlY29zeXN0ZW1cbiAqL1xuZXhwb3J0IGNvbnN0IGRlZmluZUZ1bmN0aW9uID0gKFxuICBwcm9wczogRnVuY3Rpb25Qcm9wcyA9IHt9XG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnkgJlxuICAgIEFkZEVudmlyb25tZW50RmFjdG9yeVxuPiA9PiBuZXcgRnVuY3Rpb25GYWN0b3J5KHByb3BzLCBuZXcgRXJyb3IoKS5zdGFjayk7XG5cbmV4cG9ydCB0eXBlIEZ1bmN0aW9uUHJvcHMgPSB7XG4gIC8qKlxuICAgKiBBIG5hbWUgZm9yIHRoZSBmdW5jdGlvbi5cbiAgICogRGVmYXVsdHMgdG8gdGhlIGJhc2VuYW1lIG9mIHRoZSBlbnRyeSBwYXRoIGlmIHNwZWNpZmllZC5cbiAgICogSWYgbm8gZW50cnkgaXMgc3BlY2lmaWVkLCBkZWZhdWx0cyB0byB0aGUgZGlyZWN0b3J5IG5hbWUgaW4gd2hpY2ggdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkLlxuICAgKlxuICAgKiBFeGFtcGxlOlxuICAgKiBJZiBlbnRyeSBpcyBgLi9zY2hlZHVsZWQtZGItYmFja3VwLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJzY2hlZHVsZWQtZGItYmFja3VwXCJcbiAgICogSWYgZW50cnkgaXMgbm90IHNldCBhbmQgdGhlIGZ1bmN0aW9uIGlzIGRlZmluZWQgaW4gYGFtcGxpZnkvZnVuY3Rpb25zL2RiLWJhY2t1cC9yZXNvdXJjZS50c2AgdGhlIG5hbWUgd2lsbCBkZWZhdWx0IHRvIFwiZGItYmFja3VwXCJcbiAgICovXG4gIG5hbWU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgZmlsZSB0aGF0IGNvbnRhaW5zIHRoZSBmdW5jdGlvbiBlbnRyeSBwb2ludC5cbiAgICogSWYgdGhpcyBpcyBhIHJlbGF0aXZlIHBhdGgsIGl0IGlzIGNvbXB1dGVkIHJlbGF0aXZlIHRvIHRoZSBmaWxlIHdoZXJlIHRoaXMgZnVuY3Rpb24gaXMgZGVmaW5lZFxuICAgKlxuICAgKiBEZWZhdWx0cyB0byAnLi9oYW5kbGVyLnRzJ1xuICAgKi9cbiAgZW50cnk/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFuIGFtb3VudCBvZiB0aW1lIGluIHNlY29uZHMgYmV0d2VlbiAxIHNlY29uZCBhbmQgMTUgbWludXRlcy5cbiAgICogTXVzdCBiZSBhIHdob2xlIG51bWJlci5cbiAgICogRGVmYXVsdCBpcyAzIHNlY29uZHMuXG4gICAqL1xuICB0aW1lb3V0U2Vjb25kcz86IG51bWJlcjtcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIG1lbW9yeSAoUkFNKSB0byBhbGxvY2F0ZSB0byB0aGUgZnVuY3Rpb24gYmV0d2VlbiAxMjggYW5kIDEwMjQwIE1CLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDEyOE1CLlxuICAgKi9cbiAgbWVtb3J5TUI/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEVudmlyb25tZW50IHZhcmlhYmxlcyB0aGF0IHdpbGwgYmUgYXZhaWxhYmxlIGR1cmluZyBmdW5jdGlvbiBleGVjdXRpb25cbiAgICovXG4gIGVudmlyb25tZW50PzogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgQmFja2VuZFNlY3JldD47XG5cbiAgLyoqXG4gICAqIE5vZGUgcnVudGltZSB2ZXJzaW9uIGZvciB0aGUgbGFtYmRhIGVudmlyb25tZW50LlxuICAgKlxuICAgKiBEZWZhdWx0cyB0byB0aGUgb2xkZXN0IE5vZGVKUyBMVFMgdmVyc2lvbi4gU2VlIGh0dHBzOi8vbm9kZWpzLm9yZy9lbi9hYm91dC9wcmV2aW91cy1yZWxlYXNlc1xuICAgKi9cbiAgcnVudGltZT86IE5vZGVWZXJzaW9uO1xuXG4gIC8qKlxuICAgKiBBIHRpbWUgaW50ZXJ2YWwgc3RyaW5nIHRvIHBlcmlvZGljYWxseSBydW4gdGhlIGZ1bmN0aW9uLlxuICAgKiBUaGlzIGNhbiBiZSBlaXRoZXIgYSBzdHJpbmcgb2YgYFwiZXZlcnkgPHBvc2l0aXZlIHdob2xlIG51bWJlcj48bSAobWludXRlKSBvciBoIChob3VyKT5cImAsIGBcImV2ZXJ5IGRheXx3ZWVrfG1vbnRofHllYXJcImAgb3IgY3JvbiBleHByZXNzaW9uLlxuICAgKiBEZWZhdWx0cyB0byBubyBzY2hlZHVsaW5nIGZvciB0aGUgZnVuY3Rpb24uXG4gICAqIEBleGFtcGxlXG4gICAqIHNjaGVkdWxlOiBcImV2ZXJ5IDVtXCJcbiAgICogQGV4YW1wbGVcbiAgICogc2NoZWR1bGU6IFwiZXZlcnkgd2Vla1wiXG4gICAqIEBleGFtcGxlXG4gICAqIHNjaGVkdWxlOiBcIjAgOSAqICogMlwiIC8vIGV2ZXJ5IE1vbmRheSBhdCA5YW1cbiAgICovXG4gIHNjaGVkdWxlPzogRnVuY3Rpb25TY2hlZHVsZSB8IEZ1bmN0aW9uU2NoZWR1bGVbXTtcbn07XG5cbi8qKlxuICogQ3JlYXRlIExhbWJkYSBmdW5jdGlvbnMgaW4gdGhlIGNvbnRleHQgb2YgYW4gQW1wbGlmeSBiYWNrZW5kIGRlZmluaXRpb25cbiAqL1xuY2xhc3MgRnVuY3Rpb25GYWN0b3J5IGltcGxlbWVudHMgQ29uc3RydWN0RmFjdG9yeTxBbXBsaWZ5RnVuY3Rpb24+IHtcbiAgcHJpdmF0ZSBnZW5lcmF0b3I6IENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yO1xuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEFtcGxpZnlGdW5jdGlvbkZhY3RvcnlcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEZ1bmN0aW9uUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjYWxsZXJTdGFjaz86IHN0cmluZ1xuICApIHt9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgQW1wbGlmeUZ1bmN0aW9uIHdpdGhpbiB0aGUgcHJvdmlkZWQgQW1wbGlmeSBjb250ZXh0XG4gICAqL1xuICBnZXRJbnN0YW5jZSA9ICh7XG4gICAgY29uc3RydWN0Q29udGFpbmVyLFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3IsXG4gIH06IENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzKTogQW1wbGlmeUZ1bmN0aW9uID0+IHtcbiAgICBpZiAoIXRoaXMuZ2VuZXJhdG9yKSB7XG4gICAgICB0aGlzLmdlbmVyYXRvciA9IG5ldyBGdW5jdGlvbkdlbmVyYXRvcihcbiAgICAgICAgdGhpcy5oeWRyYXRlRGVmYXVsdHMocmVzb3VyY2VOYW1lVmFsaWRhdG9yKSxcbiAgICAgICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5XG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gY29uc3RydWN0Q29udGFpbmVyLmdldE9yQ29tcHV0ZSh0aGlzLmdlbmVyYXRvcikgYXMgQW1wbGlmeUZ1bmN0aW9uO1xuICB9O1xuXG4gIHByaXZhdGUgaHlkcmF0ZURlZmF1bHRzID0gKFxuICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcj86IFJlc291cmNlTmFtZVZhbGlkYXRvclxuICApOiBIeWRyYXRlZEZ1bmN0aW9uUHJvcHMgPT4ge1xuICAgIGNvbnN0IG5hbWUgPSB0aGlzLnJlc29sdmVOYW1lKCk7XG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yPy52YWxpZGF0ZShuYW1lKTtcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZSxcbiAgICAgIGVudHJ5OiB0aGlzLnJlc29sdmVFbnRyeSgpLFxuICAgICAgdGltZW91dFNlY29uZHM6IHRoaXMucmVzb2x2ZVRpbWVvdXQoKSxcbiAgICAgIG1lbW9yeU1COiB0aGlzLnJlc29sdmVNZW1vcnkoKSxcbiAgICAgIGVudmlyb25tZW50OiB0aGlzLnByb3BzLmVudmlyb25tZW50ID8/IHt9LFxuICAgICAgcnVudGltZTogdGhpcy5yZXNvbHZlUnVudGltZSgpLFxuICAgICAgc2NoZWR1bGU6IHRoaXMucmVzb2x2ZVNjaGVkdWxlKCksXG4gICAgfTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVOYW1lID0gKCkgPT4ge1xuICAgIC8vIElmIG5hbWUgaXMgc2V0IGV4cGxpY2l0bHksIHVzZSB0aGF0XG4gICAgaWYgKHRoaXMucHJvcHMubmFtZSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMubmFtZTtcbiAgICB9XG4gICAgLy8gSWYgZW50cnkgaXMgc2V0LCB1c2UgdGhlIGJhc2VuYW1lIG9mIHRoZSBlbnRyeSBwYXRoXG4gICAgaWYgKHRoaXMucHJvcHMuZW50cnkpIHtcbiAgICAgIHJldHVybiBwYXRoLnBhcnNlKHRoaXMucHJvcHMuZW50cnkpLm5hbWU7XG4gICAgfVxuXG4gICAgLy8gT3RoZXJ3aXNlLCB1c2UgdGhlIGRpcmVjdG9yeSBuYW1lIHdoZXJlIHRoZSBmdW5jdGlvbiBpcyBkZWZpbmVkXG4gICAgcmV0dXJuIHBhdGguYmFzZW5hbWUoZ2V0Q2FsbGVyRGlyZWN0b3J5KHRoaXMuY2FsbGVyU3RhY2spKTtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVFbnRyeSA9ICgpID0+IHtcbiAgICAvLyBpZiBlbnRyeSBpcyBub3Qgc2V0LCBkZWZhdWx0IHRvIGhhbmRsZXIudHNcbiAgICBpZiAoIXRoaXMucHJvcHMuZW50cnkpIHtcbiAgICAgIHJldHVybiBwYXRoLmpvaW4oZ2V0Q2FsbGVyRGlyZWN0b3J5KHRoaXMuY2FsbGVyU3RhY2spLCAnaGFuZGxlci50cycpO1xuICAgIH1cblxuICAgIC8vIGlmIGVudHJ5IGlzIGFic29sdXRlIHVzZSB0aGF0XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZSh0aGlzLnByb3BzLmVudHJ5KSkge1xuICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZW50cnk7XG4gICAgfVxuXG4gICAgLy8gaWYgZW50cnkgaXMgcmVsYXRpdmUsIGNvbXB1dGUgd2l0aCByZXNwZWN0IHRvIHRoZSBjYWxsZXIgZGlyZWN0b3J5XG4gICAgcmV0dXJuIHBhdGguam9pbihnZXRDYWxsZXJEaXJlY3RvcnkodGhpcy5jYWxsZXJTdGFjayksIHRoaXMucHJvcHMuZW50cnkpO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVRpbWVvdXQgPSAoKSA9PiB7XG4gICAgY29uc3QgdGltZW91dE1pbiA9IDE7XG4gICAgY29uc3QgdGltZW91dE1heCA9IDYwICogMTU7IC8vIDE1IG1pbnV0ZXMgaW4gc2Vjb25kc1xuICAgIGNvbnN0IHRpbWVvdXREZWZhdWx0ID0gMztcbiAgICBpZiAodGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdGltZW91dERlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKFxuICAgICAgICB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzLFxuICAgICAgICB0aW1lb3V0TWluLFxuICAgICAgICB0aW1lb3V0TWF4XG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGB0aW1lb3V0U2Vjb25kcyBtdXN0IGJlIGEgd2hvbGUgbnVtYmVyIGJldHdlZW4gJHt0aW1lb3V0TWlufSBhbmQgJHt0aW1lb3V0TWF4fSBpbmNsdXNpdmVgXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9wcy50aW1lb3V0U2Vjb25kcztcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVNZW1vcnkgPSAoKSA9PiB7XG4gICAgY29uc3QgbWVtb3J5TWluID0gMTI4O1xuICAgIGNvbnN0IG1lbW9yeU1heCA9IDEwMjQwO1xuICAgIGNvbnN0IG1lbW9yeURlZmF1bHQgPSA1MTI7XG4gICAgaWYgKHRoaXMucHJvcHMubWVtb3J5TUIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIG1lbW9yeURlZmF1bHQ7XG4gICAgfVxuICAgIGlmIChcbiAgICAgICFpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZSh0aGlzLnByb3BzLm1lbW9yeU1CLCBtZW1vcnlNaW4sIG1lbW9yeU1heClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYG1lbW9yeU1CIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke21lbW9yeU1pbn0gYW5kICR7bWVtb3J5TWF4fSBpbmNsdXNpdmVgXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5tZW1vcnlNQjtcbiAgfTtcblxuICBwcml2YXRlIHJlc29sdmVSdW50aW1lID0gKCkgPT4ge1xuICAgIGNvbnN0IHJ1bnRpbWVEZWZhdWx0ID0gMTg7XG5cbiAgICAvLyBpZiBydW50aW1lIGlzIG5vdCBzZXQsIGRlZmF1bHQgdG8gdGhlIG9sZGVzdCBMVFNcbiAgICBpZiAoIXRoaXMucHJvcHMucnVudGltZSkge1xuICAgICAgcmV0dXJuIHJ1bnRpbWVEZWZhdWx0O1xuICAgIH1cblxuICAgIGlmICghKHRoaXMucHJvcHMucnVudGltZSBpbiBub2RlVmVyc2lvbk1hcCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHJ1bnRpbWUgbXVzdCBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZzogJHtPYmplY3Qua2V5cyhcbiAgICAgICAgICBub2RlVmVyc2lvbk1hcFxuICAgICAgICApLmpvaW4oJywgJyl9YFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5ydW50aW1lO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVNjaGVkdWxlID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5wcm9wcy5zY2hlZHVsZSkge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb3BzLnNjaGVkdWxlO1xuICB9O1xufVxuXG50eXBlIEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyA9IFJlcXVpcmVkPEZ1bmN0aW9uUHJvcHM+O1xuXG5jbGFzcyBGdW5jdGlvbkdlbmVyYXRvciBpbXBsZW1lbnRzIENvbnN0cnVjdENvbnRhaW5lckVudHJ5R2VuZXJhdG9yIHtcbiAgcmVhZG9ubHkgcmVzb3VyY2VHcm91cE5hbWUgPSAnZnVuY3Rpb24nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxGdW5jdGlvbk91dHB1dD5cbiAgKSB7fVxuXG4gIGdlbmVyYXRlQ29udGFpbmVyRW50cnkgPSAoe1xuICAgIHNjb3BlLFxuICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgfTogR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzKSA9PiB7XG4gICAgcmV0dXJuIG5ldyBBbXBsaWZ5RnVuY3Rpb24oXG4gICAgICBzY29wZSxcbiAgICAgIHRoaXMucHJvcHMubmFtZSxcbiAgICAgIHRoaXMucHJvcHMsXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICB0aGlzLm91dHB1dFN0b3JhZ2VTdHJhdGVneVxuICAgICk7XG4gIH07XG59XG5cbmNsYXNzIEFtcGxpZnlGdW5jdGlvblxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzXG4gICAgUmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4sXG4gICAgUmVzb3VyY2VBY2Nlc3NBY2NlcHRvckZhY3RvcnksXG4gICAgQWRkRW52aXJvbm1lbnRGYWN0b3J5XG57XG4gIHJlYWRvbmx5IHJlc291cmNlczogRnVuY3Rpb25SZXNvdXJjZXM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I6IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyxcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+XG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBydW50aW1lID0gbm9kZVZlcnNpb25NYXBbcHJvcHMucnVudGltZV07XG5cbiAgICBjb25zdCByZXF1aXJlID0gY3JlYXRlUmVxdWlyZShpbXBvcnQubWV0YS51cmwpO1xuXG4gICAgY29uc3Qgc2hpbXMgPVxuICAgICAgcnVudGltZSA9PT0gUnVudGltZS5OT0RFSlNfMTZfWFxuICAgICAgICA/IFtdXG4gICAgICAgIDogW3JlcXVpcmUucmVzb2x2ZSgnLi9sYW1iZGEtc2hpbXMvY2pzX3NoaW0nKV07XG5cbiAgICBjb25zdCBzc21SZXNvbHZlckZpbGUgPVxuICAgICAgcnVudGltZSA9PT0gUnVudGltZS5OT0RFSlNfMTZfWFxuICAgICAgICA/IHJlcXVpcmUucmVzb2x2ZSgnLi9sYW1iZGEtc2hpbXMvcmVzb2x2ZV9zc21fcGFyYW1zX3Nka192MicpIC8vIHVzZSBhd3MgY2RrIHYyIGluIG5vZGUgMTZcbiAgICAgICAgOiByZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL3Jlc29sdmVfc3NtX3BhcmFtcycpO1xuXG4gICAgY29uc3QgaW52b2tlU3NtUmVzb2x2ZXJGaWxlID0gcmVxdWlyZS5yZXNvbHZlKFxuICAgICAgJy4vbGFtYmRhLXNoaW1zL2ludm9rZV9zc21fc2hpbSdcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBjb2RlIGNvbmNhdGVuYXRlcyB0aGUgY29udGVudHMgb2YgdGhlIHNzbSByZXNvbHZlciBhbmQgaW52b2tlciBpbnRvIGEgc2luZ2xlIGxpbmUgdGhhdCBjYW4gYmUgdXNlZCBhcyB0aGUgZXNidWlsZCBiYW5uZXIgY29udGVudFxuICAgICAqIFRoaXMgYmFubmVyIGlzIHJlc3BvbnNpYmxlIGZvciByZXNvbHZpbmcgdGhlIGN1c3RvbWVyJ3MgU1NNIHBhcmFtZXRlcnMgYXQgcnVudGltZVxuICAgICAqL1xuICAgIGNvbnN0IGJhbm5lckNvZGUgPSByZWFkRmlsZVN5bmMoc3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKVxuICAgICAgLmNvbmNhdChyZWFkRmlsZVN5bmMoaW52b2tlU3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKSlcbiAgICAgIC5zcGxpdChuZXcgUmVnRXhwKGAke0VPTH18XFxufFxccmAsICdnJykpXG4gICAgICAubWFwKChsaW5lKSA9PiBsaW5lLnJlcGxhY2UoL1xcL1xcLy4qJC8sICcnKSkgLy8gc3RyaXAgb3V0IGlubGluZSBjb21tZW50cyBiZWNhdXNlIHRoZSBiYW5uZXIgaXMgZ29pbmcgdG8gYmUgZmxhdHRlbmVkIGludG8gYSBzaW5nbGUgbGluZVxuICAgICAgLmpvaW4oJycpO1xuXG4gICAgY29uc3QgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IgPVxuICAgICAgbmV3IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yKGlkKTtcblxuICAgIC8vIGVzYnVpbGQgcnVucyBhcyBwYXJ0IG9mIHRoZSBOb2RlanNGdW5jdGlvbiBjb25zdHJ1Y3Rvciwgc28gd2UgZWFnZXJseSBnZW5lcmF0ZSB0aGUgcHJvY2VzcyBlbnYgc2hpbSB3aXRob3V0IHR5cGVzIHNvIGl0IGNhbiBiZSBpbmNsdWRlZCBpbiB0aGUgZnVuY3Rpb24gYnVuZGxlLlxuICAgIC8vIFRoaXMgd2lsbCBiZSBvdmVyd3JpdHRlbiB3aXRoIHRoZSB0eXBlZCBmaWxlIGF0IHRoZSBlbmQgb2Ygc3ludGhlc2lzXG4gICAgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IuZ2VuZXJhdGVQcm9jZXNzRW52U2hpbSgpO1xuXG4gICAgbGV0IGZ1bmN0aW9uTGFtYmRhOiBOb2RlanNGdW5jdGlvbjtcbiAgICB0cnkge1xuICAgICAgZnVuY3Rpb25MYW1iZGEgPSBuZXcgTm9kZWpzRnVuY3Rpb24oc2NvcGUsIGAke2lkfS1sYW1iZGFgLCB7XG4gICAgICAgIGVudHJ5OiBwcm9wcy5lbnRyeSxcbiAgICAgICAgdGltZW91dDogRHVyYXRpb24uc2Vjb25kcyhwcm9wcy50aW1lb3V0U2Vjb25kcyksXG4gICAgICAgIG1lbW9yeVNpemU6IHByb3BzLm1lbW9yeU1CLFxuICAgICAgICBydW50aW1lOiBub2RlVmVyc2lvbk1hcFtwcm9wcy5ydW50aW1lXSxcbiAgICAgICAgYnVuZGxpbmc6IHtcbiAgICAgICAgICBmb3JtYXQ6IE91dHB1dEZvcm1hdC5FU00sXG4gICAgICAgICAgYmFubmVyOiBiYW5uZXJDb2RlLFxuICAgICAgICAgIGJ1bmRsZUF3c1NESzogdHJ1ZSxcbiAgICAgICAgICBpbmplY3Q6IHNoaW1zLFxuICAgICAgICAgIGxvYWRlcjoge1xuICAgICAgICAgICAgJy5ub2RlJzogJ2ZpbGUnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbWluaWZ5OiB0cnVlLFxuICAgICAgICAgIHNvdXJjZU1hcDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ05vZGVKU0Z1bmN0aW9uQ29uc3RydWN0SW5pdGlhbGl6YXRpb25FcnJvcicsXG4gICAgICAgIHtcbiAgICAgICAgICBtZXNzYWdlOiAnRmFpbGVkIHRvIGluc3RhbnRpYXRlIG5vZGVqcyBmdW5jdGlvbiBjb25zdHJ1Y3QnLFxuICAgICAgICAgIHJlc29sdXRpb246ICdTZWUgdGhlIHVuZGVybHlpbmcgZXJyb3IgbWVzc2FnZSBmb3IgbW9yZSBkZXRhaWxzLicsXG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yIGFzIEVycm9yXG4gICAgICApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzY2hlZHVsZXMgPSBjb252ZXJ0RnVuY3Rpb25TY2hlZHVsZXNUb1J1bGVTY2hlZHVsZXMoXG4gICAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgICBwcm9wcy5zY2hlZHVsZVxuICAgICAgKTtcbiAgICAgIGNvbnN0IGxhbWJkYVRhcmdldCA9IG5ldyB0YXJnZXRzLkxhbWJkYUZ1bmN0aW9uKGZ1bmN0aW9uTGFtYmRhKTtcblxuICAgICAgc2NoZWR1bGVzLmZvckVhY2goKHNjaGVkdWxlLCBpbmRleCkgPT4ge1xuICAgICAgICAvLyBMYW1iZGEgbmFtZSB3aWxsIGJlIHByZXBlbmRlZCB0byBydWxlIGlkLCBzbyBvbmx5IHVzaW5nIGluZGV4IGhlcmUgZm9yIHVuaXF1ZW5lc3NcbiAgICAgICAgY29uc3QgcnVsZSA9IG5ldyBSdWxlKGZ1bmN0aW9uTGFtYmRhLCBgc2NoZWR1bGUke2luZGV4fWAsIHtcbiAgICAgICAgICBzY2hlZHVsZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcnVsZS5hZGRUYXJnZXQobGFtYmRhVGFyZ2V0KTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0Z1bmN0aW9uU2NoZWR1bGVJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgc2NoZWR1bGUgZm9yIG5vZGVqcyBmdW5jdGlvbicsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgVGFncy5vZihmdW5jdGlvbkxhbWJkYSkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgaWQpO1xuXG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvciA9IG5ldyBGdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcihcbiAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgcHJvcHMuZW52aXJvbm1lbnQsXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvclxuICAgICk7XG5cbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIGxhbWJkYTogZnVuY3Rpb25MYW1iZGEsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuRnVuY3Rpb246IGZ1bmN0aW9uTGFtYmRhLm5vZGUuZmluZENoaWxkKCdSZXNvdXJjZScpIGFzIENmbkZ1bmN0aW9uLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dChvdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgbmV3IEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlKCkuc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhKFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgICBmdW5jdGlvblN0YWNrVHlwZSxcbiAgICAgIGZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLi4vcGFja2FnZS5qc29uJywgaW1wb3J0Lm1ldGEudXJsKSlcbiAgICApO1xuICB9XG5cbiAgYWRkRW52aXJvbm1lbnQgPSAoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0KSA9PiB7XG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvci5hZGRFbnZpcm9ubWVudEVudHJ5KGtleSwgdmFsdWUpO1xuICB9O1xuXG4gIGdldFJlc291cmNlQWNjZXNzQWNjZXB0b3IgPSAoKSA9PiAoe1xuICAgIGlkZW50aWZpZXI6IGAke3RoaXMubm9kZS5pZH1MYW1iZGFSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yYCxcbiAgICBhY2NlcHRSZXNvdXJjZUFjY2VzczogKFxuICAgICAgcG9saWN5OiBQb2xpY3ksXG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXM6IFNzbUVudmlyb25tZW50RW50cnlbXVxuICAgICkgPT4ge1xuICAgICAgY29uc3Qgcm9sZSA9IHRoaXMucmVzb3VyY2VzLmxhbWJkYS5yb2xlO1xuICAgICAgaWYgKCFyb2xlKSB7XG4gICAgICAgIC8vIFRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbiBzaW5jZSB3ZSBhcmUgdXNpbmcgdGhlIEZ1bmN0aW9uIEwyIGNvbnN0cnVjdFxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgJ05vIGV4ZWN1dGlvbiByb2xlIGZvdW5kIHRvIGF0dGFjaCBsYW1iZGEgcGVybWlzc2lvbnMgdG8nXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBwb2xpY3kuYXR0YWNoVG9Sb2xlKHJvbGUpO1xuICAgICAgc3NtRW52aXJvbm1lbnRFbnRyaWVzLmZvckVhY2goKHsgbmFtZSwgcGF0aCB9KSA9PiB7XG4gICAgICAgIHRoaXMuZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3IuYWRkU3NtRW52aXJvbm1lbnRFbnRyeShuYW1lLCBwYXRoKTtcbiAgICAgIH0pO1xuICAgIH0sXG4gIH0pO1xuXG4gIC8qKlxuICAgKiBTdG9yZSBzdG9yYWdlIG91dHB1dHMgdXNpbmcgcHJvdmlkZWQgc3RyYXRlZ3lcbiAgICovXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PlxuICApOiB2b2lkID0+IHtcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYXBwZW5kVG9CYWNrZW5kT3V0cHV0TGlzdChmdW5jdGlvbk91dHB1dEtleSwge1xuICAgICAgdmVyc2lvbjogJzEnLFxuICAgICAgcGF5bG9hZDoge1xuICAgICAgICBkZWZpbmVkRnVuY3Rpb25zOiB0aGlzLnJlc291cmNlcy5sYW1iZGEuZnVuY3Rpb25OYW1lLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfTtcbn1cblxuY29uc3QgaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUgPSAoXG4gIHRlc3Q6IG51bWJlcixcbiAgbWluOiBudW1iZXIsXG4gIG1heDogbnVtYmVyXG4pID0+IG1pbiA8PSB0ZXN0ICYmIHRlc3QgPD0gbWF4ICYmIHRlc3QgJSAxID09PSAwO1xuXG5leHBvcnQgdHlwZSBOb2RlVmVyc2lvbiA9IDE2IHwgMTggfCAyMDtcblxuY29uc3Qgbm9kZVZlcnNpb25NYXA6IFJlY29yZDxOb2RlVmVyc2lvbiwgUnVudGltZT4gPSB7XG4gIDE2OiBSdW50aW1lLk5PREVKU18xNl9YLFxuICAxODogUnVudGltZS5OT0RFSlNfMThfWCxcbiAgMjA6IFJ1bnRpbWUuTk9ERUpTXzIwX1gsXG59O1xuIl19