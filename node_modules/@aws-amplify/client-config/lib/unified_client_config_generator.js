import { unifiedBackendOutputSchema } from '@aws-amplify/backend-output-schemas';
import { AmplifyUserError, ObjectAccumulator, ObjectAccumulatorPropertyAlreadyExistsError, ObjectAccumulatorVersionMismatchError, } from '@aws-amplify/platform-core';
import { BackendOutputClientError, BackendOutputClientErrorType, } from '@aws-amplify/deployed-backend-client';
/**
 * Right now this is mostly a stub. This will become a translation layer between backend output and frontend config
 *
 * There may be multiple implementations of this for different frontends
 */
export class UnifiedClientConfigGenerator {
    fetchOutput;
    clientConfigContributors;
    /**
     * Provide a reference to how this config generator should retrieve backend output
     */
    constructor(fetchOutput, clientConfigContributors) {
        this.fetchOutput = fetchOutput;
        this.clientConfigContributors = clientConfigContributors;
    }
    /**
     * Fetch all backend output, invoke each ClientConfigContributor on the result and merge into a single config object
     */
    generateClientConfig = async () => {
        let output;
        try {
            output = await this.fetchOutput();
        }
        catch (error) {
            if (error instanceof BackendOutputClientError &&
                error.code === BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS) {
                throw new AmplifyUserError('DeploymentInProgressError', {
                    message: 'Deployment is currently in progress.',
                    resolution: 'Re-run this command once the deployment completes.',
                }, error);
            }
            if (error instanceof BackendOutputClientError &&
                error.code === BackendOutputClientErrorType.NO_STACK_FOUND) {
                throw new AmplifyUserError('StackDoesNotExistError', {
                    message: 'Stack does not exist.',
                    resolution: 'Ensure the CloudFormation stack ID or Amplify App ID and branch specified are correct and exists, then re-run this command.',
                }, error);
            }
            throw error;
        }
        const backendOutput = unifiedBackendOutputSchema.parse(output);
        const accumulator = new ObjectAccumulator({});
        for (const contributor of this.clientConfigContributors) {
            const clientConfigContribution = await contributor.contribute(backendOutput);
            try {
                // Partial to DeepPartialAmplifyGeneratedConfigs is always a safe case since it's up-casting
                accumulator.accumulate(clientConfigContribution);
            }
            catch (error) {
                if (error instanceof ObjectAccumulatorPropertyAlreadyExistsError) {
                    throw new AmplifyUserError('OutputEntryAlreadyExistsError', {
                        message: `Duplicated entry with key ${error.key} detected in deployment outputs`,
                        resolution: "Check if 'backend.addOutput' is called multiple times with overlapping inputs or" +
                            " if 'backend.addOutput' is called with values overlapping Amplify managed keys",
                    }, error);
                }
                if (error instanceof ObjectAccumulatorVersionMismatchError) {
                    throw new AmplifyUserError('VersionMismatchError', {
                        message: `Conflicting versions of client configuration found. `,
                        resolution: "Ensure that the version specified in 'backend.addOutput' is consistent" +
                            ' and is same as the one used for generating the client config',
                    }, error);
                }
                throw error;
            }
        }
        return accumulator.getAccumulatedObject();
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pZmllZF9jbGllbnRfY29uZmlnX2dlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91bmlmaWVkX2NsaWVudF9jb25maWdfZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBSWpGLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLDJDQUEyQyxFQUMzQyxxQ0FBcUMsR0FDdEMsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLHNDQUFzQyxDQUFDO0FBRTlDOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sNEJBQTRCO0lBS3BCO0lBQ0E7SUFMbkI7O09BRUc7SUFDSCxZQUNtQixXQUF5QyxFQUN6Qyx3QkFBbUQ7UUFEbkQsZ0JBQVcsR0FBWCxXQUFXLENBQThCO1FBQ3pDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMkI7SUFDbkUsQ0FBQztJQUVKOztPQUVHO0lBQ0gsb0JBQW9CLEdBQUcsS0FBSyxJQUEyQixFQUFFO1FBQ3ZELElBQUksTUFBTSxDQUFDO1FBQ1gsSUFBSTtZQUNGLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNuQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsSUFDRSxLQUFLLFlBQVksd0JBQXdCO2dCQUN6QyxLQUFLLENBQUMsSUFBSSxLQUFLLDRCQUE0QixDQUFDLHNCQUFzQixFQUNsRTtnQkFDQSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLDJCQUEyQixFQUMzQjtvQkFDRSxPQUFPLEVBQUUsc0NBQXNDO29CQUMvQyxVQUFVLEVBQUUsb0RBQW9EO2lCQUNqRSxFQUNELEtBQUssQ0FDTixDQUFDO2FBQ0g7WUFDRCxJQUNFLEtBQUssWUFBWSx3QkFBd0I7Z0JBQ3pDLEtBQUssQ0FBQyxJQUFJLEtBQUssNEJBQTRCLENBQUMsY0FBYyxFQUMxRDtnQkFDQSxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLHdCQUF3QixFQUN4QjtvQkFDRSxPQUFPLEVBQUUsdUJBQXVCO29CQUNoQyxVQUFVLEVBQ1IsNkhBQTZIO2lCQUNoSSxFQUNELEtBQUssQ0FDTixDQUFDO2FBQ0g7WUFDRCxNQUFNLEtBQUssQ0FBQztTQUNiO1FBQ0QsTUFBTSxhQUFhLEdBQUcsMEJBQTBCLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRS9ELE1BQU0sV0FBVyxHQUFHLElBQUksaUJBQWlCLENBQWUsRUFBRSxDQUFDLENBQUM7UUFFNUQsS0FBSyxNQUFNLFdBQVcsSUFBSSxJQUFJLENBQUMsd0JBQXdCLEVBQUU7WUFDdkQsTUFBTSx3QkFBd0IsR0FBRyxNQUFNLFdBQVcsQ0FBQyxVQUFVLENBQzNELGFBQWEsQ0FDZCxDQUFDO1lBQ0YsSUFBSTtnQkFDRiw0RkFBNEY7Z0JBQzVGLFdBQVcsQ0FBQyxVQUFVLENBQ3BCLHdCQUE0RSxDQUM3RSxDQUFDO2FBQ0g7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDZCxJQUFJLEtBQUssWUFBWSwyQ0FBMkMsRUFBRTtvQkFDaEUsTUFBTSxJQUFJLGdCQUFnQixDQUN4QiwrQkFBK0IsRUFDL0I7d0JBQ0UsT0FBTyxFQUFFLDZCQUE2QixLQUFLLENBQUMsR0FBRyxpQ0FBaUM7d0JBQ2hGLFVBQVUsRUFDUixrRkFBa0Y7NEJBQ2xGLGdGQUFnRjtxQkFDbkYsRUFDRCxLQUFLLENBQ04sQ0FBQztpQkFDSDtnQkFDRCxJQUFJLEtBQUssWUFBWSxxQ0FBcUMsRUFBRTtvQkFDMUQsTUFBTSxJQUFJLGdCQUFnQixDQUN4QixzQkFBc0IsRUFDdEI7d0JBQ0UsT0FBTyxFQUFFLHNEQUFzRDt3QkFDL0QsVUFBVSxFQUNSLHdFQUF3RTs0QkFDeEUsK0RBQStEO3FCQUNsRSxFQUNELEtBQUssQ0FDTixDQUFDO2lCQUNIO2dCQUNELE1BQU0sS0FBSyxDQUFDO2FBQ2I7U0FDRjtRQUNELE9BQXFCLFdBQVcsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0lBQzFELENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dCxcbiAgRGVlcFBhcnRpYWxBbXBsaWZ5R2VuZXJhdGVkQ29uZmlncyxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyB1bmlmaWVkQmFja2VuZE91dHB1dFNjaGVtYSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7IENsaWVudENvbmZpZyB9IGZyb20gJy4vY2xpZW50LWNvbmZpZy10eXBlcy9jbGllbnRfY29uZmlnLmpzJztcbmltcG9ydCB7IENsaWVudENvbmZpZ0NvbnRyaWJ1dG9yIH0gZnJvbSAnLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWdfY29udHJpYnV0b3IuanMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnR2VuZXJhdG9yIH0gZnJvbSAnLi9jbGllbnRfY29uZmlnX2dlbmVyYXRvci5qcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5VXNlckVycm9yLFxuICBPYmplY3RBY2N1bXVsYXRvcixcbiAgT2JqZWN0QWNjdW11bGF0b3JQcm9wZXJ0eUFscmVhZHlFeGlzdHNFcnJvcixcbiAgT2JqZWN0QWNjdW11bGF0b3JWZXJzaW9uTWlzbWF0Y2hFcnJvcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLFxuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvZGVwbG95ZWQtYmFja2VuZC1jbGllbnQnO1xuXG4vKipcbiAqIFJpZ2h0IG5vdyB0aGlzIGlzIG1vc3RseSBhIHN0dWIuIFRoaXMgd2lsbCBiZWNvbWUgYSB0cmFuc2xhdGlvbiBsYXllciBiZXR3ZWVuIGJhY2tlbmQgb3V0cHV0IGFuZCBmcm9udGVuZCBjb25maWdcbiAqXG4gKiBUaGVyZSBtYXkgYmUgbXVsdGlwbGUgaW1wbGVtZW50YXRpb25zIG9mIHRoaXMgZm9yIGRpZmZlcmVudCBmcm9udGVuZHNcbiAqL1xuZXhwb3J0IGNsYXNzIFVuaWZpZWRDbGllbnRDb25maWdHZW5lcmF0b3IgaW1wbGVtZW50cyBDbGllbnRDb25maWdHZW5lcmF0b3Ige1xuICAvKipcbiAgICogUHJvdmlkZSBhIHJlZmVyZW5jZSB0byBob3cgdGhpcyBjb25maWcgZ2VuZXJhdG9yIHNob3VsZCByZXRyaWV2ZSBiYWNrZW5kIG91dHB1dFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBmZXRjaE91dHB1dDogKCkgPT4gUHJvbWlzZTxCYWNrZW5kT3V0cHV0PixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNsaWVudENvbmZpZ0NvbnRyaWJ1dG9yczogQ2xpZW50Q29uZmlnQ29udHJpYnV0b3JbXVxuICApIHt9XG5cbiAgLyoqXG4gICAqIEZldGNoIGFsbCBiYWNrZW5kIG91dHB1dCwgaW52b2tlIGVhY2ggQ2xpZW50Q29uZmlnQ29udHJpYnV0b3Igb24gdGhlIHJlc3VsdCBhbmQgbWVyZ2UgaW50byBhIHNpbmdsZSBjb25maWcgb2JqZWN0XG4gICAqL1xuICBnZW5lcmF0ZUNsaWVudENvbmZpZyA9IGFzeW5jICgpOiBQcm9taXNlPENsaWVudENvbmZpZz4gPT4ge1xuICAgIGxldCBvdXRwdXQ7XG4gICAgdHJ5IHtcbiAgICAgIG91dHB1dCA9IGF3YWl0IHRoaXMuZmV0Y2hPdXRwdXQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvciAmJlxuICAgICAgICBlcnJvci5jb2RlID09PSBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLkRFUExPWU1FTlRfSU5fUFJPR1JFU1NcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnRGVwbG95bWVudEluUHJvZ3Jlc3NFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogJ0RlcGxveW1lbnQgaXMgY3VycmVudGx5IGluIHByb2dyZXNzLicsXG4gICAgICAgICAgICByZXNvbHV0aW9uOiAnUmUtcnVuIHRoaXMgY29tbWFuZCBvbmNlIHRoZSBkZXBsb3ltZW50IGNvbXBsZXRlcy4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IgJiZcbiAgICAgICAgZXJyb3IuY29kZSA9PT0gQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19TVEFDS19GT1VORFxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICdTdGFja0RvZXNOb3RFeGlzdEVycm9yJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBtZXNzYWdlOiAnU3RhY2sgZG9lcyBub3QgZXhpc3QuJyxcbiAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICdFbnN1cmUgdGhlIENsb3VkRm9ybWF0aW9uIHN0YWNrIElEIG9yIEFtcGxpZnkgQXBwIElEIGFuZCBicmFuY2ggc3BlY2lmaWVkIGFyZSBjb3JyZWN0IGFuZCBleGlzdHMsIHRoZW4gcmUtcnVuIHRoaXMgY29tbWFuZC4nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3JcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgICBjb25zdCBiYWNrZW5kT3V0cHV0ID0gdW5pZmllZEJhY2tlbmRPdXRwdXRTY2hlbWEucGFyc2Uob3V0cHV0KTtcblxuICAgIGNvbnN0IGFjY3VtdWxhdG9yID0gbmV3IE9iamVjdEFjY3VtdWxhdG9yPENsaWVudENvbmZpZz4oe30pO1xuXG4gICAgZm9yIChjb25zdCBjb250cmlidXRvciBvZiB0aGlzLmNsaWVudENvbmZpZ0NvbnRyaWJ1dG9ycykge1xuICAgICAgY29uc3QgY2xpZW50Q29uZmlnQ29udHJpYnV0aW9uID0gYXdhaXQgY29udHJpYnV0b3IuY29udHJpYnV0ZShcbiAgICAgICAgYmFja2VuZE91dHB1dFxuICAgICAgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIFBhcnRpYWwgdG8gRGVlcFBhcnRpYWxBbXBsaWZ5R2VuZXJhdGVkQ29uZmlncyBpcyBhbHdheXMgYSBzYWZlIGNhc2Ugc2luY2UgaXQncyB1cC1jYXN0aW5nXG4gICAgICAgIGFjY3VtdWxhdG9yLmFjY3VtdWxhdGUoXG4gICAgICAgICAgY2xpZW50Q29uZmlnQ29udHJpYnV0aW9uIGFzIERlZXBQYXJ0aWFsQW1wbGlmeUdlbmVyYXRlZENvbmZpZ3M8Q2xpZW50Q29uZmlnPlxuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgT2JqZWN0QWNjdW11bGF0b3JQcm9wZXJ0eUFscmVhZHlFeGlzdHNFcnJvcikge1xuICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAgICAgJ091dHB1dEVudHJ5QWxyZWFkeUV4aXN0c0Vycm9yJyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgbWVzc2FnZTogYER1cGxpY2F0ZWQgZW50cnkgd2l0aCBrZXkgJHtlcnJvci5rZXl9IGRldGVjdGVkIGluIGRlcGxveW1lbnQgb3V0cHV0c2AsXG4gICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgXCJDaGVjayBpZiAnYmFja2VuZC5hZGRPdXRwdXQnIGlzIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyB3aXRoIG92ZXJsYXBwaW5nIGlucHV0cyBvclwiICtcbiAgICAgICAgICAgICAgICBcIiBpZiAnYmFja2VuZC5hZGRPdXRwdXQnIGlzIGNhbGxlZCB3aXRoIHZhbHVlcyBvdmVybGFwcGluZyBBbXBsaWZ5IG1hbmFnZWQga2V5c1wiLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBPYmplY3RBY2N1bXVsYXRvclZlcnNpb25NaXNtYXRjaEVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlVc2VyRXJyb3IoXG4gICAgICAgICAgICAnVmVyc2lvbk1pc21hdGNoRXJyb3InLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgQ29uZmxpY3RpbmcgdmVyc2lvbnMgb2YgY2xpZW50IGNvbmZpZ3VyYXRpb24gZm91bmQuIGAsXG4gICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgXCJFbnN1cmUgdGhhdCB0aGUgdmVyc2lvbiBzcGVjaWZpZWQgaW4gJ2JhY2tlbmQuYWRkT3V0cHV0JyBpcyBjb25zaXN0ZW50XCIgK1xuICAgICAgICAgICAgICAgICcgYW5kIGlzIHNhbWUgYXMgdGhlIG9uZSB1c2VkIGZvciBnZW5lcmF0aW5nIHRoZSBjbGllbnQgY29uZmlnJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvclxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiA8Q2xpZW50Q29uZmlnPmFjY3VtdWxhdG9yLmdldEFjY3VtdWxhdGVkT2JqZWN0KCk7XG4gIH07XG59XG4iXX0=