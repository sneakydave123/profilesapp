import { AmplifyFault } from '@aws-amplify/platform-core';
/**
 * Converts unified client config to the legacy format.
 */
export class ClientConfigLegacyConverter {
    /**
     * Converts client config to a shape consumable by legacy libraries.
     */
    convertToLegacyConfig = (clientConfig) => {
        // We can only convert from V1 of ClientConfig. For everything else, throw
        if (!this.isClientConfigV1(clientConfig)) {
            throw new AmplifyFault('UnsupportedClientConfigVersion', {
                message: 'Only version 1 of ClientConfig is supported.',
            });
        }
        let legacyConfig = {};
        // Gen2 backend constructs use the Stack's region and is identical. We use these to
        // populate the root level aws_project_region in legacy config.
        if (clientConfig.auth || clientConfig.data || clientConfig.storage) {
            legacyConfig.aws_project_region =
                clientConfig.auth?.aws_region ??
                    clientConfig.data?.aws_region ??
                    clientConfig.storage?.aws_region;
        }
        // Auth
        if (clientConfig.auth) {
            const authClientConfig = {
                aws_user_pools_id: clientConfig.auth.user_pool_id,
                aws_cognito_region: clientConfig.auth.aws_region,
                aws_user_pools_web_client_id: clientConfig.auth.user_pool_client_id,
                aws_cognito_identity_pool_id: clientConfig.auth.identity_pool_id,
            };
            if (clientConfig.auth.unauthenticated_identities_enabled) {
                authClientConfig.allowUnauthenticatedIdentities = clientConfig.auth
                    .unauthenticated_identities_enabled
                    ? 'true'
                    : 'false';
            }
            if (clientConfig.auth.mfa_methods) {
                authClientConfig.aws_cognito_mfa_types = clientConfig.auth.mfa_methods;
            }
            if (clientConfig.auth.mfa_configuration) {
                switch (clientConfig.auth.mfa_configuration) {
                    case 'NONE': {
                        authClientConfig.aws_cognito_mfa_configuration = 'OFF';
                        break;
                    }
                    case 'OPTIONAL': {
                        authClientConfig.aws_cognito_mfa_configuration = 'OPTIONAL';
                        break;
                    }
                    case 'REQUIRED': {
                        authClientConfig.aws_cognito_mfa_configuration = 'ON';
                    }
                }
            }
            if (clientConfig.auth.standard_required_attributes) {
                authClientConfig.aws_cognito_signup_attributes =
                    clientConfig.auth.standard_required_attributes?.map((attribute) => attribute.toUpperCase());
            }
            if (clientConfig.auth.username_attributes) {
                authClientConfig.aws_cognito_username_attributes =
                    clientConfig.auth.username_attributes?.map((attribute) => attribute.toUpperCase());
            }
            authClientConfig.aws_cognito_verification_mechanisms =
                clientConfig.auth.user_verification_types?.map((attribute) => attribute.toUpperCase());
            if (clientConfig.auth.password_policy) {
                authClientConfig.aws_cognito_password_protection_settings = {};
                if (clientConfig.auth.password_policy.min_length) {
                    authClientConfig.aws_cognito_password_protection_settings = {
                        passwordPolicyMinLength: clientConfig.auth.password_policy.min_length,
                    };
                }
                const requirements = [];
                if (clientConfig.auth.password_policy.require_numbers) {
                    requirements.push('REQUIRES_NUMBERS');
                }
                if (clientConfig.auth.password_policy.require_lowercase) {
                    requirements.push('REQUIRES_LOWERCASE');
                }
                if (clientConfig.auth.password_policy.require_uppercase) {
                    requirements.push('REQUIRES_UPPERCASE');
                }
                if (clientConfig.auth.password_policy.require_symbols) {
                    requirements.push('REQUIRES_SYMBOLS');
                }
                authClientConfig.aws_cognito_password_protection_settings.passwordPolicyCharacters =
                    requirements;
            }
            if (clientConfig.auth.oauth) {
                authClientConfig.oauth = {};
                authClientConfig.aws_cognito_social_providers =
                    clientConfig.auth.oauth.identity_providers.map((provider) => {
                        if (provider === 'SIGN_IN_WITH_APPLE') {
                            return 'APPLE';
                        }
                        if (provider === 'LOGIN_WITH_AMAZON') {
                            return 'AMAZON';
                        }
                        return provider;
                    });
                authClientConfig.oauth.domain = clientConfig.auth.oauth.domain;
                authClientConfig.oauth.scope = clientConfig.auth.oauth.scopes;
                authClientConfig.oauth.redirectSignIn =
                    clientConfig.auth.oauth.redirect_sign_in_uri.join(',');
                authClientConfig.oauth.redirectSignOut =
                    clientConfig.auth.oauth.redirect_sign_out_uri.join(',');
                authClientConfig.oauth.responseType =
                    clientConfig.auth.oauth.response_type;
            }
            legacyConfig = { ...legacyConfig, ...authClientConfig };
        }
        // Data category
        if (clientConfig.data) {
            const dataConfig = {
                aws_appsync_authenticationType: clientConfig.data.default_authorization_type,
                aws_appsync_region: clientConfig.data.aws_region,
                aws_appsync_graphqlEndpoint: clientConfig.data.url,
                modelIntrospection: clientConfig.data.model_introspection,
            };
            if (clientConfig.data.api_key) {
                dataConfig.aws_appsync_apiKey = clientConfig.data.api_key;
            }
            if (clientConfig.data.authorization_types) {
                dataConfig.aws_appsync_additionalAuthenticationTypes =
                    clientConfig.data.authorization_types.join(',');
            }
            legacyConfig = { ...legacyConfig, ...dataConfig };
        }
        // Storage category
        if (clientConfig.storage) {
            const storageConfig = {
                aws_user_files_s3_bucket: clientConfig.storage.bucket_name,
                aws_user_files_s3_bucket_region: clientConfig.storage.aws_region,
            };
            legacyConfig = { ...legacyConfig, ...storageConfig };
        }
        // Analytics category
        if (clientConfig.analytics && clientConfig.analytics.amazon_pinpoint) {
            const analyticsConfig = {
                Analytics: {
                    Pinpoint: {
                        appId: clientConfig.analytics.amazon_pinpoint.app_id,
                        region: clientConfig.analytics.amazon_pinpoint.aws_region,
                    },
                },
            };
            legacyConfig = { ...legacyConfig, ...analyticsConfig };
            legacyConfig.aws_mobile_analytics_app_id =
                clientConfig.analytics.amazon_pinpoint.app_id;
            legacyConfig.aws_mobile_analytics_app_region =
                clientConfig.analytics.amazon_pinpoint.aws_region;
        }
        // Geo category
        if (clientConfig.geo) {
            const geoConfig = {
                geo: {
                    amazon_location_service: {
                        region: clientConfig.geo.aws_region,
                    },
                },
            };
            if (clientConfig.geo.maps) {
                const mapsLegacyConfig = {};
                for (const mapName in clientConfig.geo.maps.items) {
                    if (clientConfig.geo.maps.items[mapName].style) {
                        mapsLegacyConfig[mapName] = {
                            style: clientConfig.geo.maps.items[mapName].style,
                        };
                    }
                }
                geoConfig.geo.amazon_location_service.maps = {
                    default: clientConfig.geo.maps.default,
                    items: mapsLegacyConfig,
                };
            }
            if (clientConfig.geo.search_indices) {
                geoConfig.geo.amazon_location_service.search_indices =
                    clientConfig.geo.search_indices;
            }
            if (clientConfig.geo.geofence_collections) {
                geoConfig.geo.amazon_location_service.geofenceCollections =
                    clientConfig.geo.geofence_collections;
            }
            legacyConfig = { ...legacyConfig, ...geoConfig };
        }
        // Notifications
        if (clientConfig.notifications) {
            const pinPointConfig = {
                AWSPinpoint: {
                    appId: clientConfig.notifications.amazon_pinpoint_app_id,
                    region: clientConfig.notifications.aws_region,
                },
            };
            const notificationConfig = {};
            notificationConfig.Notifications = {};
            for (const notificationChannel of clientConfig.notifications.channels) {
                switch (notificationChannel) {
                    case 'IN_APP_MESSAGING':
                        notificationConfig.Notifications.InAppMessaging = pinPointConfig;
                        break;
                    case 'FCM':
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'APNS':
                        // It's fine to overwrite APNS over FCM since they are the exact same config.
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'EMAIL':
                        notificationConfig.Notifications.EMAIL = pinPointConfig;
                        break;
                    case 'SMS':
                        notificationConfig.Notifications.SMS = pinPointConfig;
                        break;
                }
            }
            legacyConfig = { ...legacyConfig, ...notificationConfig };
        }
        // Custom
        if (clientConfig.custom) {
            legacyConfig.custom = clientConfig.custom;
        }
        return legacyConfig;
    };
    isClientConfigV1 = (clientConfig) => {
        return clientConfig.version === '1';
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50X2NvbmZpZ190b19sZWdhY3lfY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsaWVudC1jb25maWctd3JpdGVyL2NsaWVudF9jb25maWdfdG9fbGVnYWN5X2NvbnZlcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFnQjFEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJCQUEyQjtJQUN0Qzs7T0FFRztJQUNILHFCQUFxQixHQUFHLENBQUMsWUFBMEIsRUFBc0IsRUFBRTtRQUN6RSwwRUFBMEU7UUFDMUUsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUN4QyxNQUFNLElBQUksWUFBWSxDQUFDLGdDQUFnQyxFQUFFO2dCQUN2RCxPQUFPLEVBQUUsOENBQThDO2FBQ3hELENBQUMsQ0FBQztTQUNKO1FBRUQsSUFBSSxZQUFZLEdBQXVCLEVBQUUsQ0FBQztRQUUxQyxtRkFBbUY7UUFDbkYsK0RBQStEO1FBQy9ELElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUU7WUFDbEUsWUFBWSxDQUFDLGtCQUFrQjtnQkFDN0IsWUFBWSxDQUFDLElBQUksRUFBRSxVQUFVO29CQUM3QixZQUFZLENBQUMsSUFBSSxFQUFFLFVBQVU7b0JBQzdCLFlBQVksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO1NBQ3BDO1FBRUQsT0FBTztRQUNQLElBQUksWUFBWSxDQUFDLElBQUksRUFBRTtZQUNyQixNQUFNLGdCQUFnQixHQUFxQjtnQkFDekMsaUJBQWlCLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZO2dCQUNqRCxrQkFBa0IsRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVU7Z0JBQ2hELDRCQUE0QixFQUFFLFlBQVksQ0FBQyxJQUFJ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akUsTUFBTTtvQkFDUixLQUFLLEtBQUs7d0JBQ1Isa0JBQWtCLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxjQUFjLENBQUM7d0JBQ3ZELE1BQU07b0JBQ1IsS0FBSyxNQUFNO3dCQUNULDZFQUE2RTt3QkFDN0Usa0JBQWtCLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxjQUFjLENBQUM7d0JBQ3ZELE1BQU07b0JBQ1IsS0FBSyxPQUFPO3dCQUNWLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxLQUFLLEdBQUcsY0FBYyxDQUFDO3dCQUN4RCxNQUFNO29CQUNSLEtBQUssS0FBSzt3QkFDUixrQkFBa0IsQ0FBQyxhQUFhLENBQUMsR0FBRyxHQUFHLGNBQWMsQ0FBQzt3QkFDdEQsTUFBTTtpQkFDVDthQUNGO1lBRUQsWUFBWSxHQUFHLEVBQUUsR0FBRyxZQUFZLEVBQUUsR0FBRyxrQkFBa0IsRUFBRSxDQUFDO1NBQzNEO1FBRUQsU0FBUztRQUNULElBQUksWUFBWSxDQUFDLE1BQU0sRUFBRTtZQUN2QixZQUFZLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUM7U0FDM0M7UUFFRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDLENBQUM7SUFFRixnQkFBZ0IsR0FBRyxDQUNqQixZQUEwQixFQUNvQyxFQUFFO1FBQ2hFLE9BQU8sWUFBWSxDQUFDLE9BQU8sS0FBSyxHQUFHLENBQUM7SUFDdEMsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbXBsaWZ5RmF1bHQgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBDbGllbnRDb25maWcsXG4gIENsaWVudENvbmZpZ0xlZ2FjeSxcbiAgY2xpZW50Q29uZmlnVHlwZXNWMSxcbn0gZnJvbSAnLi4vY2xpZW50LWNvbmZpZy10eXBlcy9jbGllbnRfY29uZmlnLmpzJztcblxuaW1wb3J0IHtcbiAgQW5hbHl0aWNzQ2xpZW50Q29uZmlnLFxuICBBdXRoQ2xpZW50Q29uZmlnLFxuICBHZW9DbGllbnRDb25maWcsXG4gIEdyYXBocWxDbGllbnRDb25maWcsXG4gIE5vdGlmaWNhdGlvbnNDbGllbnRDb25maWcsXG4gIFN0b3JhZ2VDbGllbnRDb25maWcsXG59IGZyb20gJy4uL2luZGV4LmpzJztcblxuLyoqXG4gKiBDb252ZXJ0cyB1bmlmaWVkIGNsaWVudCBjb25maWcgdG8gdGhlIGxlZ2FjeSBmb3JtYXQuXG4gKi9cbmV4cG9ydCBjbGFzcyBDbGllbnRDb25maWdMZWdhY3lDb252ZXJ0ZXIge1xuICAvKipcbiAgICogQ29udmVydHMgY2xpZW50IGNvbmZpZyB0byBhIHNoYXBlIGNvbnN1bWFibGUgYnkgbGVnYWN5IGxpYnJhcmllcy5cbiAgICovXG4gIGNvbnZlcnRUb0xlZ2FjeUNvbmZpZyA9IChjbGllbnRDb25maWc6IENsaWVudENvbmZpZyk6IENsaWVudENvbmZpZ0xlZ2FjeSA9PiB7XG4gICAgLy8gV2UgY2FuIG9ubHkgY29udmVydCBmcm9tIFYxIG9mIENsaWVudENvbmZpZy4gRm9yIGV2ZXJ5dGhpbmcgZWxzZSwgdGhyb3dcbiAgICBpZiAoIXRoaXMuaXNDbGllbnRDb25maWdWMShjbGllbnRDb25maWcpKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeUZhdWx0KCdVbnN1cHBvcnRlZENsaWVudENvbmZpZ1ZlcnNpb24nLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdPbmx5IHZlcnNpb24gMSBvZiBDbGllbnRDb25maWcgaXMgc3VwcG9ydGVkLicsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBsZXQgbGVnYWN5Q29uZmlnOiBDbGllbnRDb25maWdMZWdhY3kgPSB7fTtcblxuICAgIC8vIEdlbjIgYmFja2VuZCBjb25zdHJ1Y3RzIHVzZSB0aGUgU3RhY2sncyByZWdpb24gYW5kIGlzIGlkZW50aWNhbC4gV2UgdXNlIHRoZXNlIHRvXG4gICAgLy8gcG9wdWxhdGUgdGhlIHJvb3QgbGV2ZWwgYXdzX3Byb2plY3RfcmVnaW9uIGluIGxlZ2FjeSBjb25maWcuXG4gICAgaWYgKGNsaWVudENvbmZpZy5hdXRoIHx8IGNsaWVudENvbmZpZy5kYXRhIHx8IGNsaWVudENvbmZpZy5zdG9yYWdlKSB7XG4gICAgICBsZWdhY3lDb25maWcuYXdzX3Byb2plY3RfcmVnaW9uID1cbiAgICAgICAgY2xpZW50Q29uZmlnLmF1dGg/LmF3c19yZWdpb24gPz9cbiAgICAgICAgY2xpZW50Q29uZmlnLmRhdGE/LmF3c19yZWdpb24gPz9cbiAgICAgICAgY2xpZW50Q29uZmlnLnN0b3JhZ2U/LmF3c19yZWdpb247XG4gICAgfVxuXG4gICAgLy8gQXV0aFxuICAgIGlmIChjbGllbnRDb25maWcuYXV0aCkge1xuICAgICAgY29uc3QgYXV0aENsaWVudENvbmZpZzogQXV0aENsaWVudENvbmZpZyA9IHtcbiAgICAgICAgYXdzX3VzZXJfcG9vbHNfaWQ6IGNsaWVudENvbmZpZy5hdXRoLnVzZXJfcG9vbF9pZCxcbiAgICAgICAgYXdzX2NvZ25pdG9fcmVnaW9uOiBjbGllbnRDb25maWcuYXV0aC5hd3NfcmVnaW9uLFxuICAgICAgICBhd3NfdXNlcl9wb29sc193ZWJfY2xpZW50X2lkOiBjbGllbnRDb25maWcuYXV0aC51c2VyX3Bvb2xfY2xpZW50X2lkLFxuICAgICAgICBhd3NfY29nbml0b19pZGVudGl0eV9wb29sX2lkOiBjbGllbnRDb25maWcuYXV0aC5pZGVudGl0eV9wb29sX2lkLFxuICAgICAgfTtcblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnVuYXV0aGVudGljYXRlZF9pZGVudGl0aWVzX2VuYWJsZWQpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMgPSBjbGllbnRDb25maWcuYXV0aFxuICAgICAgICAgIC51bmF1dGhlbnRpY2F0ZWRfaWRlbnRpdGllc19lbmFibGVkXG4gICAgICAgICAgPyAndHJ1ZSdcbiAgICAgICAgICA6ICdmYWxzZSc7XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5tZmFfbWV0aG9kcykge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX21mYV90eXBlcyA9IGNsaWVudENvbmZpZy5hdXRoLm1mYV9tZXRob2RzO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgubWZhX2NvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgc3dpdGNoIChjbGllbnRDb25maWcuYXV0aC5tZmFfY29uZmlndXJhdGlvbikge1xuICAgICAgICAgIGNhc2UgJ05PTkUnOiB7XG4gICAgICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX21mYV9jb25maWd1cmF0aW9uID0gJ09GRic7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgY2FzZSAnT1BUSU9OQUwnOiB7XG4gICAgICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX21mYV9jb25maWd1cmF0aW9uID0gJ09QVElPTkFMJztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlICdSRVFVSVJFRCc6IHtcbiAgICAgICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fbWZhX2NvbmZpZ3VyYXRpb24gPSAnT04nO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGguc3RhbmRhcmRfcmVxdWlyZWRfYXR0cmlidXRlcykge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3NpZ251cF9hdHRyaWJ1dGVzID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5zdGFuZGFyZF9yZXF1aXJlZF9hdHRyaWJ1dGVzPy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICAgIGF0dHJpYnV0ZS50b1VwcGVyQ2FzZSgpXG4gICAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnVzZXJuYW1lX2F0dHJpYnV0ZXMpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b191c2VybmFtZV9hdHRyaWJ1dGVzID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC51c2VybmFtZV9hdHRyaWJ1dGVzPy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICAgIGF0dHJpYnV0ZS50b1VwcGVyQ2FzZSgpXG4gICAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b192ZXJpZmljYXRpb25fbWVjaGFuaXNtcyA9XG4gICAgICAgIGNsaWVudENvbmZpZy5hdXRoLnVzZXJfdmVyaWZpY2F0aW9uX3R5cGVzPy5tYXAoKGF0dHJpYnV0ZSkgPT5cbiAgICAgICAgICBhdHRyaWJ1dGUudG9VcHBlckNhc2UoKVxuICAgICAgICApO1xuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5KSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fcGFzc3dvcmRfcHJvdGVjdGlvbl9zZXR0aW5ncyA9IHt9O1xuICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5Lm1pbl9sZW5ndGgpIHtcbiAgICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3Bhc3N3b3JkX3Byb3RlY3Rpb25fc2V0dGluZ3MgPSB7XG4gICAgICAgICAgICBwYXNzd29yZFBvbGljeU1pbkxlbmd0aDpcbiAgICAgICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5Lm1pbl9sZW5ndGgsXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZXF1aXJlbWVudHMgPSBbXTtcbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5yZXF1aXJlX251bWJlcnMpIHtcbiAgICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTlVNQkVSUycpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV9sb3dlcmNhc2UpIHtcbiAgICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTE9XRVJDQVNFJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5yZXF1aXJlX3VwcGVyY2FzZSkge1xuICAgICAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19VUFBFUkNBU0UnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5LnJlcXVpcmVfc3ltYm9scykge1xuICAgICAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19TWU1CT0xTJyk7XG4gICAgICAgIH1cbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19wYXNzd29yZF9wcm90ZWN0aW9uX3NldHRpbmdzLnBhc3N3b3JkUG9saWN5Q2hhcmFjdGVycyA9XG4gICAgICAgICAgcmVxdWlyZW1lbnRzO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgub2F1dGgpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5vYXV0aCA9IHt9O1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3NvY2lhbF9wcm92aWRlcnMgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLm9hdXRoLmlkZW50aXR5X3Byb3ZpZGVycy5tYXAoKHByb3ZpZGVyKSA9PiB7XG4gICAgICAgICAgICBpZiAocHJvdmlkZXIgPT09ICdTSUdOX0lOX1dJVEhfQVBQTEUnKSB7XG4gICAgICAgICAgICAgIHJldHVybiAnQVBQTEUnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb3ZpZGVyID09PSAnTE9HSU5fV0lUSF9BTUFaT04nKSB7XG4gICAgICAgICAgICAgIHJldHVybiAnQU1BWk9OJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcm92aWRlcjtcbiAgICAgICAgICB9KTtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5vYXV0aC5kb21haW4gPSBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5kb21haW47XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGguc2NvcGUgPSBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5zY29wZXM7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGgucmVkaXJlY3RTaWduSW4gPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLm9hdXRoLnJlZGlyZWN0X3NpZ25faW5fdXJpLmpvaW4oJywnKTtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5vYXV0aC5yZWRpcmVjdFNpZ25PdXQgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLm9hdXRoLnJlZGlyZWN0X3NpZ25fb3V0X3VyaS5qb2luKCcsJyk7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcub2F1dGgucmVzcG9uc2VUeXBlID1cbiAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5vYXV0aC5yZXNwb25zZV90eXBlO1xuICAgICAgfVxuXG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4uYXV0aENsaWVudENvbmZpZyB9O1xuICAgIH1cblxuICAgIC8vIERhdGEgY2F0ZWdvcnlcbiAgICBpZiAoY2xpZW50Q29uZmlnLmRhdGEpIHtcbiAgICAgIGNvbnN0IGRhdGFDb25maWc6IEdyYXBocWxDbGllbnRDb25maWcgPSB7XG4gICAgICAgIGF3c19hcHBzeW5jX2F1dGhlbnRpY2F0aW9uVHlwZTpcbiAgICAgICAgICBjbGllbnRDb25maWcuZGF0YS5kZWZhdWx0X2F1dGhvcml6YXRpb25fdHlwZSxcbiAgICAgICAgYXdzX2FwcHN5bmNfcmVnaW9uOiBjbGllbnRDb25maWcuZGF0YS5hd3NfcmVnaW9uLFxuICAgICAgICBhd3NfYXBwc3luY19ncmFwaHFsRW5kcG9pbnQ6IGNsaWVudENvbmZpZy5kYXRhLnVybCxcbiAgICAgICAgbW9kZWxJbnRyb3NwZWN0aW9uOiBjbGllbnRDb25maWcuZGF0YS5tb2RlbF9pbnRyb3NwZWN0aW9uLFxuICAgICAgfTtcblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5kYXRhLmFwaV9rZXkpIHtcbiAgICAgICAgZGF0YUNvbmZpZy5hd3NfYXBwc3luY19hcGlLZXkgPSBjbGllbnRDb25maWcuZGF0YS5hcGlfa2V5O1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmRhdGEuYXV0aG9yaXphdGlvbl90eXBlcykge1xuICAgICAgICBkYXRhQ29uZmlnLmF3c19hcHBzeW5jX2FkZGl0aW9uYWxBdXRoZW50aWNhdGlvblR5cGVzID1cbiAgICAgICAgICBjbGllbnRDb25maWcuZGF0YS5hdXRob3JpemF0aW9uX3R5cGVzLmpvaW4oJywnKTtcbiAgICAgIH1cblxuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLmRhdGFDb25maWcgfTtcbiAgICB9XG5cbiAgICAvLyBTdG9yYWdlIGNhdGVnb3J5XG4gICAgaWYgKGNsaWVudENvbmZpZy5zdG9yYWdlKSB7XG4gICAgICBjb25zdCBzdG9yYWdlQ29uZmlnOiBTdG9yYWdlQ2xpZW50Q29uZmlnID0ge1xuICAgICAgICBhd3NfdXNlcl9maWxlc19zM19idWNrZXQ6IGNsaWVudENvbmZpZy5zdG9yYWdlLmJ1Y2tldF9uYW1lLFxuICAgICAgICBhd3NfdXNlcl9maWxlc19zM19idWNrZXRfcmVnaW9uOiBjbGllbnRDb25maWcuc3RvcmFnZS5hd3NfcmVnaW9uLFxuICAgICAgfTtcbiAgICAgIGxlZ2FjeUNvbmZpZyA9IHsgLi4ubGVnYWN5Q29uZmlnLCAuLi5zdG9yYWdlQ29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8gQW5hbHl0aWNzIGNhdGVnb3J5XG4gICAgaWYgKGNsaWVudENvbmZpZy5hbmFseXRpY3MgJiYgY2xpZW50Q29uZmlnLmFuYWx5dGljcy5hbWF6b25fcGlucG9pbnQpIHtcbiAgICAgIGNvbnN0IGFuYWx5dGljc0NvbmZpZzogQW5hbHl0aWNzQ2xpZW50Q29uZmlnID0ge1xuICAgICAgICBBbmFseXRpY3M6IHtcbiAgICAgICAgICBQaW5wb2ludDoge1xuICAgICAgICAgICAgYXBwSWQ6IGNsaWVudENvbmZpZy5hbmFseXRpY3MuYW1hem9uX3BpbnBvaW50LmFwcF9pZCxcbiAgICAgICAgICAgIHJlZ2lvbjogY2xpZW50Q29uZmlnLmFuYWx5dGljcy5hbWF6b25fcGlucG9pbnQuYXdzX3JlZ2lvbixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIGxlZ2FjeUNvbmZpZyA9IHsgLi4ubGVnYWN5Q29uZmlnLCAuLi5hbmFseXRpY3NDb25maWcgfTtcbiAgICAgIGxlZ2FjeUNvbmZpZy5hd3NfbW9iaWxlX2FuYWx5dGljc19hcHBfaWQgPVxuICAgICAgICBjbGllbnRDb25maWcuYW5hbHl0aWNzLmFtYXpvbl9waW5wb2ludC5hcHBfaWQ7XG4gICAgICBsZWdhY3lDb25maWcuYXdzX21vYmlsZV9hbmFseXRpY3NfYXBwX3JlZ2lvbiA9XG4gICAgICAgIGNsaWVudENvbmZpZy5hbmFseXRpY3MuYW1hem9uX3BpbnBvaW50LmF3c19yZWdpb247XG4gICAgfVxuXG4gICAgLy8gR2VvIGNhdGVnb3J5XG4gICAgaWYgKGNsaWVudENvbmZpZy5nZW8pIHtcbiAgICAgIGNvbnN0IGdlb0NvbmZpZzogR2VvQ2xpZW50Q29uZmlnID0ge1xuICAgICAgICBnZW86IHtcbiAgICAgICAgICBhbWF6b25fbG9jYXRpb25fc2VydmljZToge1xuICAgICAgICAgICAgcmVnaW9uOiBjbGllbnRDb25maWcuZ2VvLmF3c19yZWdpb24sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuZ2VvLm1hcHMpIHtcbiAgICAgICAgY29uc3QgbWFwc0xlZ2FjeUNvbmZpZzogUmVjb3JkPHN0cmluZywgeyBzdHlsZTogc3RyaW5nIH0+ID0ge307XG4gICAgICAgIGZvciAoY29uc3QgbWFwTmFtZSBpbiBjbGllbnRDb25maWcuZ2VvLm1hcHMuaXRlbXMpIHtcbiAgICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmdlby5tYXBzLml0ZW1zW21hcE5hbWVdLnN0eWxlKSB7XG4gICAgICAgICAgICBtYXBzTGVnYWN5Q29uZmlnW21hcE5hbWVdID0ge1xuICAgICAgICAgICAgICBzdHlsZTogY2xpZW50Q29uZmlnLmdlby5tYXBzLml0ZW1zW21hcE5hbWVdLnN0eWxlISxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGdlb0NvbmZpZy5nZW8hLmFtYXpvbl9sb2NhdGlvbl9zZXJ2aWNlLm1hcHMgPSB7XG4gICAgICAgICAgZGVmYXVsdDogY2xpZW50Q29uZmlnLmdlby5tYXBzLmRlZmF1bHQsXG4gICAgICAgICAgaXRlbXM6IG1hcHNMZWdhY3lDb25maWcsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuZ2VvLnNlYXJjaF9pbmRpY2VzKSB7XG4gICAgICAgIGdlb0NvbmZpZy5nZW8hLmFtYXpvbl9sb2NhdGlvbl9zZXJ2aWNlLnNlYXJjaF9pbmRpY2VzID1cbiAgICAgICAgICBjbGllbnRDb25maWcuZ2VvLnNlYXJjaF9pbmRpY2VzO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmdlby5nZW9mZW5jZV9jb2xsZWN0aW9ucykge1xuICAgICAgICBnZW9Db25maWcuZ2VvIS5hbWF6b25fbG9jYXRpb25fc2VydmljZS5nZW9mZW5jZUNvbGxlY3Rpb25zID1cbiAgICAgICAgICBjbGllbnRDb25maWcuZ2VvLmdlb2ZlbmNlX2NvbGxlY3Rpb25zO1xuICAgICAgfVxuXG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4uZ2VvQ29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8gTm90aWZpY2F0aW9uc1xuICAgIGlmIChjbGllbnRDb25maWcubm90aWZpY2F0aW9ucykge1xuICAgICAgY29uc3QgcGluUG9pbnRDb25maWcgPSB7XG4gICAgICAgIEFXU1BpbnBvaW50OiB7XG4gICAgICAgICAgYXBwSWQ6IGNsaWVudENvbmZpZy5ub3RpZmljYXRpb25zLmFtYXpvbl9waW5wb2ludF9hcHBfaWQsXG4gICAgICAgICAgcmVnaW9uOiBjbGllbnRDb25maWcubm90aWZpY2F0aW9ucy5hd3NfcmVnaW9uLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbkNvbmZpZzogTm90aWZpY2F0aW9uc0NsaWVudENvbmZpZyA9IHt9O1xuICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLk5vdGlmaWNhdGlvbnMgPSB7fTtcbiAgICAgIGZvciAoY29uc3Qgbm90aWZpY2F0aW9uQ2hhbm5lbCBvZiBjbGllbnRDb25maWcubm90aWZpY2F0aW9ucy5jaGFubmVscykge1xuICAgICAgICBzd2l0Y2ggKG5vdGlmaWNhdGlvbkNoYW5uZWwpIHtcbiAgICAgICAgICBjYXNlICdJTl9BUFBfTUVTU0FHSU5HJzpcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLkluQXBwTWVzc2FnaW5nID0gcGluUG9pbnRDb25maWc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdGQ00nOlxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLk5vdGlmaWNhdGlvbnMuUHVzaCA9IHBpblBvaW50Q29uZmlnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnQVBOUyc6XG4gICAgICAgICAgICAvLyBJdCdzIGZpbmUgdG8gb3ZlcndyaXRlIEFQTlMgb3ZlciBGQ00gc2luY2UgdGhleSBhcmUgdGhlIGV4YWN0IHNhbWUgY29uZmlnLlxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLk5vdGlmaWNhdGlvbnMuUHVzaCA9IHBpblBvaW50Q29uZmlnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnRU1BSUwnOlxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLk5vdGlmaWNhdGlvbnMuRU1BSUwgPSBwaW5Qb2ludENvbmZpZztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ1NNUyc6XG4gICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcuTm90aWZpY2F0aW9ucy5TTVMgPSBwaW5Qb2ludENvbmZpZztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGxlZ2FjeUNvbmZpZyA9IHsgLi4ubGVnYWN5Q29uZmlnLCAuLi5ub3RpZmljYXRpb25Db25maWcgfTtcbiAgICB9XG5cbiAgICAvLyBDdXN0b21cbiAgICBpZiAoY2xpZW50Q29uZmlnLmN1c3RvbSkge1xuICAgICAgbGVnYWN5Q29uZmlnLmN1c3RvbSA9IGNsaWVudENvbmZpZy5jdXN0b207XG4gICAgfVxuXG4gICAgcmV0dXJuIGxlZ2FjeUNvbmZpZztcbiAgfTtcblxuICBpc0NsaWVudENvbmZpZ1YxID0gKFxuICAgIGNsaWVudENvbmZpZzogQ2xpZW50Q29uZmlnXG4gICk6IGNsaWVudENvbmZpZyBpcyBjbGllbnRDb25maWdUeXBlc1YxLkFXU0FtcGxpZnlCYWNrZW5kT3V0cHV0cyA9PiB7XG4gICAgcmV0dXJuIGNsaWVudENvbmZpZy52ZXJzaW9uID09PSAnMSc7XG4gIH07XG59XG4iXX0=