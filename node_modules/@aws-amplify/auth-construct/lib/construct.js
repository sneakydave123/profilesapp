"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmplifyAuth = void 0;
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const backend_output_schemas_1 = require("@aws-amplify/backend-output-schemas");
const defaults_js_1 = require("./defaults.js");
const backend_output_storage_1 = require("@aws-amplify/backend-output-storage");
const path = __importStar(require("path"));
const oauthProviderToProviderDomainMap = {
    facebook: 'graph.facebook.com',
    google: 'accounts.google.com',
    amazon: 'www.amazon.com',
    apple: 'appleid.apple.com',
};
const INVITATION_PLACEHOLDERS = {
    CODE: '{####}',
    USERNAME: '{username}',
};
const VERIFICATION_EMAIL_PLACEHOLDERS = {
    CODE: '{####}',
    LINK: '{##Verify Email##}',
};
const VERIFICATION_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const MFA_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const DEFAULT_OAUTH_SCOPES = [
    aws_cognito_1.OAuthScope.PHONE,
    aws_cognito_1.OAuthScope.EMAIL,
    aws_cognito_1.OAuthScope.OPENID,
    aws_cognito_1.OAuthScope.PROFILE,
    aws_cognito_1.OAuthScope.COGNITO_ADMIN,
];
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Auth in BI metrics
const authStackType = 'auth-Cognito';
/**
 * Amplify Auth CDK Construct
 */
class AmplifyAuth extends constructs_1.Construct {
    /**
     * Create a new Auth construct with AuthProps.
     * If no props are provided, email login and defaults will be used.
     */
    constructor(scope, id, props = defaults_js_1.DEFAULTS.IF_NO_PROPS_PROVIDED) {
        var _a, _b;
        super(scope, id);
        this.groups = {};
        /**
         * Create Auth/UnAuth Roles
         * @returns DefaultRoles
         */
        this.setupAuthAndUnAuthRoles = (identityPoolId) => {
            const result = {
                auth: new aws_iam_1.Role(this, `${this.name}authenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
                unAuth: new aws_iam_1.Role(this, `${this.name}unauthenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'unauthenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
            };
            return result;
        };
        /**
         * Auto generate the user pool groups and group roles
         */
        this.setupUserPoolGroups = (groups, identityPool) => {
            (groups || []).forEach((groupName, index) => {
                const groupRole = new aws_iam_1.Role(this, `${this.name}${groupName}GroupRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPool.ref,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                });
                const currentGroup = new aws_cognito_1.CfnUserPoolGroup(this, `${this.name}${groupName}Group`, {
                    userPoolId: this.userPool.userPoolId,
                    groupName: groupName,
                    roleArn: groupRole.roleArn,
                    precedence: index,
                });
                this.groups[groupName] = {
                    cfnUserGroup: currentGroup,
                    role: groupRole,
                };
            });
        };
        /**
         * Setup Identity Pool with default roles/role mappings, and register providers
         */
        this.setupIdentityPool = (userPool, userPoolClient, providerSetupResult) => {
            // setup identity pool
            const region = aws_cdk_lib_1.Stack.of(this).region;
            const identityPool = new aws_cdk_lib_1.aws_cognito.CfnIdentityPool(this, `${this.name}IdentityPool`, {
                allowUnauthenticatedIdentities: defaults_js_1.DEFAULTS.ALLOW_UNAUTHENTICATED_IDENTITIES,
            });
            const roles = this.setupAuthAndUnAuthRoles(identityPool.ref);
            const identityPoolRoleAttachment = new aws_cdk_lib_1.aws_cognito.CfnIdentityPoolRoleAttachment(this, `${this.name}IdentityPoolRoleAttachment`, {
                identityPoolId: identityPool.ref,
                roles: {
                    unauthenticated: roles.unAuth.roleArn,
                    authenticated: roles.auth.roleArn,
                },
                roleMappings: {
                    UserPoolWebClientRoleMapping: {
                        type: 'Token',
                        ambiguousRoleResolution: 'AuthenticatedRole',
                        identityProvider: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}:${userPoolClient.userPoolClientId}`,
                    },
                },
            });
            identityPoolRoleAttachment.addDependency(identityPool);
            identityPoolRoleAttachment.node.addDependency(userPoolClient);
            // add cognito provider
            identityPool.cognitoIdentityProviders = [
                {
                    clientId: userPoolClient.userPoolClientId,
                    providerName: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}`,
                },
            ];
            // add other providers
            identityPool.supportedLoginProviders = providerSetupResult.oAuthMappings;
            return {
                identityPool,
                identityPoolRoleAttachment,
                roles,
            };
        };
        /**
         * Define bindCustomAttribute to meet requirements of the Cognito API to call the bind method
         */
        this.bindCustomAttribute = (key, attribute) => {
            var _a;
            const baseConfig = {
                dataType: attribute.dataType,
                mutable: (_a = attribute.mutable) !== null && _a !== void 0 ? _a : true,
            };
            let constraints = {};
            // Conditionally add constraint properties based on dataType.
            if (attribute.dataType === 'String') {
                constraints = {
                    stringConstraints: {
                        minLen: attribute.minLen,
                        maxLen: attribute.maxLen,
                    },
                };
            }
            else if (attribute.dataType === 'Number') {
                constraints = {
                    numberConstraints: {
                        min: attribute.min,
                        max: attribute.max,
                    },
                };
            }
            //The final config object includes baseConfig and conditionally added constraint properties.
            const config = {
                ...baseConfig,
                ...constraints,
            };
            return {
                ...config,
                bind: () => config,
            };
        };
        /**
         * Process props into UserPoolProps (set defaults if needed)
         */
        this.getUserPoolProps = (props) => {
            var _a, _b;
            const emailEnabled = props.loginWith.email ? true : false;
            const phoneEnabled = props.loginWith.phone ? true : false;
            const oneOfEmailOrPhone = emailEnabled || phoneEnabled;
            if (!oneOfEmailOrPhone) {
                throw Error('At least one of email or phone must be enabled.');
            }
            let userVerificationSettings = {};
            // extract email settings if settings object is defined
            if (typeof props.loginWith.email === 'object') {
                const emailSettings = props.loginWith.email;
                // verify email body and inject the actual template values which cognito uses
                const emailBody = this.verifyEmailBody(emailSettings);
                userVerificationSettings = {
                    emailBody: emailBody,
                    emailStyle: this.getEmailVerificationStyle(emailSettings.verificationEmailStyle),
                    emailSubject: emailSettings.verificationEmailSubject,
                };
            }
            // extract phone settings if settings object is defined
            if (typeof props.loginWith.phone === 'object') {
                const phoneSettings = props.loginWith.phone;
                let smsMessage;
                if (phoneSettings.verificationMessage &&
                    typeof phoneSettings.verificationMessage === 'function') {
                    // validate sms message structure
                    smsMessage = phoneSettings.verificationMessage(() => VERIFICATION_SMS_PLACEHOLDERS.CODE);
                    if (!smsMessage.includes(VERIFICATION_SMS_PLACEHOLDERS.CODE)) {
                        throw Error("Invalid phone settings. Property 'verificationMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                    }
                }
                userVerificationSettings = {
                    ...userVerificationSettings,
                    smsMessage: smsMessage,
                };
            }
            const mfaType = this.getMFAType(props.multifactor);
            const mfaMode = this.getMFAMode(props.multifactor);
            // If phone login is enabled along with MFA, cognito requires that mfa SMS type to be enabled.
            if (phoneEnabled && mfaMode && mfaMode !== 'OFF' && !(mfaType === null || mfaType === void 0 ? void 0 : mfaType.sms)) {
                throw Error('Invalid MFA settings. SMS must be enabled in multiFactor if loginWith phone is enabled');
            }
            const { standardAttributes, customAttributes } = Object.entries((_a = props.userAttributes) !== null && _a !== void 0 ? _a : {}).reduce((acc, [key, value]) => {
                if (key.startsWith('custom:')) {
                    const attributeKey = key.replace(/^custom:/i, '');
                    acc.customAttributes[attributeKey] = this.bindCustomAttribute(attributeKey, value);
                }
                else {
                    acc.standardAttributes[key] = value;
                }
                return acc;
            }, { standardAttributes: {}, customAttributes: {} });
            const userPoolProps = {
                signInCaseSensitive: defaults_js_1.DEFAULTS.SIGN_IN_CASE_SENSITIVE,
                signInAliases: {
                    phone: phoneEnabled,
                    email: emailEnabled,
                },
                keepOriginal: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                autoVerify: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                userVerification: userVerificationSettings,
                passwordPolicy: defaults_js_1.DEFAULTS.PASSWORD_POLICY,
                standardAttributes: {
                    email: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.email(emailEnabled),
                    phoneNumber: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.phoneNumber(phoneEnabled),
                    ...standardAttributes,
                },
                customAttributes: {
                    ...customAttributes,
                },
                selfSignUpEnabled: defaults_js_1.DEFAULTS.ALLOW_SELF_SIGN_UP,
                mfa: mfaMode,
                mfaMessage: this.getMFAMessage(props.multifactor),
                mfaSecondFactor: mfaType,
                accountRecovery: this.getAccountRecoverySetting(emailEnabled, phoneEnabled, props.accountRecovery),
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                userInvitation: typeof props.loginWith.email !== 'boolean'
                    ? this.getUserInvitationSettings((_b = props.loginWith.email) === null || _b === void 0 ? void 0 : _b.userInvitation)
                    : undefined,
            };
            return userPoolProps;
        };
        /**
         * Get email verification style from user props
         * @param verificationEmailStyle - string value
         * @returns verificationEmailStyle - enum value
         */
        this.getEmailVerificationStyle = (verificationEmailStyle) => {
            if (verificationEmailStyle === 'CODE') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.CODE;
            }
            else if (verificationEmailStyle === 'LINK') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.LINK;
            }
            return undefined;
        };
        /**
         * Determine the account recovery option based on enabled login methods.
         * @param emailEnabled - is email enabled
         * @param phoneEnabled - is phone enabled
         * @param accountRecoveryMethodAsString - the user provided account recovery setting
         * @returns account recovery setting enum value
         */
        this.getAccountRecoverySetting = (emailEnabled, phoneEnabled, accountRecoveryMethodAsString) => {
            const accountRecovery = this.convertAccountRecoveryStringToEnum(accountRecoveryMethodAsString);
            if (accountRecovery !== undefined) {
                return accountRecovery;
            }
            // set default based on enabled login methods
            if (phoneEnabled && emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            if (phoneEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.PHONE_ONLY_WITHOUT_MFA;
            }
            if (emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa mode to cognito Mfa Mode.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA enforcement mode
         */
        this.getMFAMode = (mfa) => {
            if (mfa) {
                switch (mfa.mode) {
                    case 'OFF':
                        return aws_cognito_1.Mfa.OFF;
                    case 'OPTIONAL':
                        return aws_cognito_1.Mfa.OPTIONAL;
                    case 'REQUIRED':
                        return aws_cognito_1.Mfa.REQUIRED;
                }
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa type to cognito Mfa type.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA type (sms or totp)
         */
        this.getMFAType = (mfa) => {
            return typeof mfa === 'object' && mfa.mode !== 'OFF'
                ? {
                    sms: mfa.sms ? true : false,
                    otp: mfa.totp ? true : false,
                }
                : undefined;
        };
        /**
         * Convert user friendly account recovery method to cognito AccountRecover enum.
         * This eliminates the need for users to import cognito.AccountRecovery.
         * @param method - account recovery method as a string value
         * @returns cognito.AccountRecovery enum value
         */
        this.convertAccountRecoveryStringToEnum = (method) => {
            if (method !== undefined) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery[method];
            }
            return undefined;
        };
        /**
         * Extract the MFA message settings and perform validation.
         * @param mfa - MFA settings
         * @returns mfa message
         */
        this.getMFAMessage = (mfa) => {
            if (mfa && mfa.mode !== 'OFF' && typeof mfa.sms === 'object') {
                const message = mfa.sms.smsMessage(() => MFA_SMS_PLACEHOLDERS.CODE);
                if (!message.includes(MFA_SMS_PLACEHOLDERS.CODE)) {
                    throw Error("Invalid MFA settings. Property 'smsMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                }
                return message;
            }
            return undefined;
        };
        /**
         * Setup External Providers (OAuth/OIDC/SAML) and related settings
         * such as OAuth settings and User Pool Domains
         */
        this.setupExternalProviders = (userPool, loginOptions) => {
            /**
             * If email is enabled, and is the only required attribute, we are able to
             * automatically map the email attribute from external providers, excluding SAML.
             */
            const shouldMapEmailAttributes = loginOptions.email && !loginOptions.phone;
            const result = {
                oAuthMappings: {},
                oAuthSettings: {
                    flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
                },
            };
            // external providers
            const external = loginOptions.externalProviders;
            if (!external) {
                return result;
            }
            // make sure logout/callback urls are not empty
            if (external.logoutUrls && external.logoutUrls.length === 0) {
                throw Error('You must define logoutUrls when configuring external login providers.');
            }
            if (external.callbackUrls && external.callbackUrls.length === 0) {
                throw Error('You must define callbackUrls when configuring external login providers.');
            }
            if (external.google) {
                const googleProps = external.google;
                result.google = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderGoogle(this, `${this.name}GoogleIdP`, {
                    userPool,
                    clientId: googleProps.clientId,
                    clientSecretValue: googleProps.clientSecret,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.GOOGLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(googleProps.attributeMapping),
                    },
                    scopes: googleProps.scopes,
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.google] =
                    external.google.clientId;
            }
            if (external.facebook) {
                result.facebook = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderFacebook(this, `${this.name}FacebookIDP`, {
                    userPool,
                    ...external.facebook,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.FACEBOOK_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.facebook.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.facebook] =
                    external.facebook.clientId;
            }
            if (external.loginWithAmazon) {
                result.amazon = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderAmazon(this, `${this.name}AmazonIDP`, {
                    userPool,
                    ...external.loginWithAmazon,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.AMAZON_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.loginWithAmazon.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.amazon] =
                    external.loginWithAmazon.clientId;
            }
            if (external.signInWithApple) {
                result.apple = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderApple(this, `${this.name}AppleIDP`, {
                    userPool,
                    ...external.signInWithApple,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.APPLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.signInWithApple.attributeMapping),
                    },
                });
                result.oAuthMappings[oauthProviderToProviderDomainMap.apple] =
                    external.signInWithApple.clientId;
            }
            if (external.oidc && external.oidc.length > 0) {
                result.oidc = [];
                external.oidc.forEach((provider, index) => {
                    var _a, _b;
                    const requestMethod = provider.attributeRequestMethod === undefined
                        ? 'GET' // default if not defined
                        : provider.attributeRequestMethod;
                    const generatedProvider = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderOidc(this, `${this.name}${(_a = provider.name) !== null && _a !== void 0 ? _a : index}OidcIDP`, {
                        userPool,
                        attributeRequestMethod: requestMethod === 'GET'
                            ? aws_cognito_1.OidcAttributeRequestMethod.GET
                            : aws_cognito_1.OidcAttributeRequestMethod.POST,
                        clientId: provider.clientId,
                        clientSecret: provider.clientSecret,
                        endpoints: provider.endpoints,
                        identifiers: provider.identifiers,
                        issuerUrl: provider.issuerUrl,
                        name: provider.name,
                        scopes: provider.scopes,
                        attributeMapping: {
                            ...(shouldMapEmailAttributes
                                ? {
                                    email: {
                                        attributeName: 'email',
                                    },
                                }
                                : undefined),
                            ...this.convertToCognitoAttributeMapping(provider.attributeMapping),
                        },
                    });
                    (_b = result.oidc) === null || _b === void 0 ? void 0 : _b.push(generatedProvider);
                });
            }
            if (external.saml) {
                const saml = external.saml;
                result.saml = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderSaml(this, `${this.name}SamlIDP`, {
                    userPool,
                    attributeMapping: this.convertToCognitoAttributeMapping(saml.attributeMapping),
                    identifiers: saml.identifiers,
                    idpSignout: saml.idpSignout,
                    metadata: {
                        metadataContent: saml.metadata.metadataContent,
                        metadataType: saml.metadata.metadataType === 'FILE'
                            ? aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.FILE
                            : aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.URL,
                    },
                    name: saml.name,
                });
            }
            // Always generate a domain prefix if external provider is configured
            if (this.domainPrefix) {
                this.userPool.addDomain(`${this.name}UserPoolDomain`, {
                    cognitoDomain: { domainPrefix: this.domainPrefix },
                });
            }
            else {
                throw new Error('Cognito Domain Prefix is missing when external providers are configured.');
            }
            // oauth settings for the UserPool client
            result.oAuthSettings = {
                callbackUrls: external.callbackUrls,
                logoutUrls: external.logoutUrls,
                scopes: external.scopes
                    ? this.getOAuthScopes(external.scopes)
                    : DEFAULT_OAUTH_SCOPES,
                flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
            };
            return result;
        };
        /**
         * Converts the simplified mapping type to cognito.AttributeMapping.
         * @param mapping the AttributeMapping to convert to a cognito.AttributeMapping
         * @returns cognito.AttributeMapping
         */
        this.convertToCognitoAttributeMapping = (mapping) => {
            if (!mapping) {
                return undefined;
            }
            const result = {};
            for (const [attrName, value] of Object.entries(mapping)) {
                if (typeof value === 'string') {
                    result[attrName] = {
                        attributeName: value,
                    };
                }
                if (typeof value === 'object' && attrName === 'custom') {
                    // dealing with custom attributes
                    const customAttributes = {};
                    for (const [customKey, attrName] of Object.entries(value)) {
                        customAttributes[customKey] = {
                            attributeName: attrName,
                        };
                    }
                    result[attrName] = customAttributes;
                }
            }
            return result;
        };
        /**
         * Convert scopes from string list to OAuthScopes.
         * @param scopes - scope list
         * @returns cognito OAuthScopes
         */
        this.getOAuthScopes = (scopes) => {
            if (scopes === undefined) {
                return [];
            }
            const result = [];
            for (const scope of scopes) {
                result.push(aws_cdk_lib_1.aws_cognito.OAuthScope[scope]);
            }
            return result;
        };
        /**
         * Stores auth output using the provided strategy
         */
        this.storeOutput = (outputStorageStrategy = new backend_output_storage_1.StackMetadataBackendOutputStorageStrategy(aws_cdk_lib_1.Stack.of(this))) => {
            const cfnUserPool = this.resources.cfnResources.cfnUserPool;
            const cfnUserPoolClient = this.resources.cfnResources.cfnUserPoolClient;
            const cfnIdentityPool = this.resources.cfnResources.cfnIdentityPool;
            // these properties cannot be overwritten
            const output = {
                userPoolId: this.resources.userPool.userPoolId,
                webClientId: this.resources.userPoolClient.userPoolClientId,
                identityPoolId: cfnIdentityPool.ref,
                authRegion: aws_cdk_lib_1.Stack.of(this).region,
            };
            // the properties below this line can be overwritten, so they are exposed via cdk LAZY
            output.allowUnauthenticatedIdentities = aws_cdk_lib_1.Lazy.string({
                produce: () => cfnIdentityPool.allowUnauthenticatedIdentities === true
                    ? 'true'
                    : 'false',
            });
            // extract signupAttributes from UserPool schema's required attributes
            output.signupAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.schema) {
                        return '[]';
                    }
                    return JSON.stringify(cfnUserPool.schema
                        .filter((attribute) => attribute.required && attribute.name)
                        .map((attribute) => { var _a; return (_a = attribute.name) === null || _a === void 0 ? void 0 : _a.toLowerCase(); }));
                },
            });
            // extract usernameAttributes from UserPool's usernameAttributes
            output.usernameAttributes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify(((_a = cfnUserPool.usernameAttributes) === null || _a === void 0 ? void 0 : _a.map((attr) => attr.toLowerCase())) ||
                        []);
                },
            });
            // extract verificationMechanisms from UserPool's autoVerifiedAttributes
            output.verificationMechanisms = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPool.autoVerifiedAttributes) !== null && _a !== void 0 ? _a : []);
                },
            });
            // extract the passwordPolicy from the UserPool policies
            output.passwordPolicyMinLength = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    return (_a = policy.minimumLength) === null || _a === void 0 ? void 0 : _a.toString();
                },
            });
            output.passwordPolicyRequirements = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    if (!cfnUserPool.policies) {
                        return '';
                    }
                    const policy = cfnUserPool.policies
                        .passwordPolicy;
                    const requirements = [];
                    policy.requireNumbers && requirements.push('REQUIRES_NUMBERS');
                    policy.requireLowercase && requirements.push('REQUIRES_LOWERCASE');
                    policy.requireUppercase && requirements.push('REQUIRES_UPPERCASE');
                    policy.requireSymbols && requirements.push('REQUIRES_SYMBOLS');
                    return JSON.stringify(requirements);
                },
            });
            // extract the MFA configuration setting from the UserPool resource
            output.mfaConfiguration = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return (_a = cfnUserPool.mfaConfiguration) !== null && _a !== void 0 ? _a : 'OFF';
                },
            });
            // extract the MFA types from the UserPool resource
            output.mfaTypes = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    const mfaTypes = [];
                    ((_a = cfnUserPool.enabledMfas) !== null && _a !== void 0 ? _a : []).forEach((type) => {
                        if (type === 'SMS_MFA') {
                            mfaTypes.push('SMS');
                        }
                        if (type === 'SOFTWARE_TOKEN_MFA') {
                            mfaTypes.push('TOTP');
                        }
                    });
                    return JSON.stringify(mfaTypes);
                },
            });
            // extract social providers from UserPool resource
            output.socialProviders = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const outputProviders = [];
                    const userPoolProviders = this.resources.userPool.identityProviders;
                    if (!userPoolProviders || userPoolProviders.length === 0) {
                        return '';
                    }
                    for (const provider of userPoolProviders) {
                        const providerResource = provider.node.findChild('Resource');
                        if (!(providerResource instanceof aws_cognito_1.CfnUserPoolIdentityProvider)) {
                            throw Error('Could not find the CfnUserPoolIdentityProvider resource in the stack.');
                        }
                        const providerType = providerResource.providerType;
                        const providerName = providerResource.providerName;
                        if (providerType === 'Google') {
                            outputProviders.push('GOOGLE');
                        }
                        if (providerType === 'Facebook') {
                            outputProviders.push('FACEBOOK');
                        }
                        if (providerType === 'SignInWithApple') {
                            outputProviders.push('SIGN_IN_WITH_APPLE');
                        }
                        if (providerType === 'LoginWithAmazon') {
                            outputProviders.push('LOGIN_WITH_AMAZON');
                        }
                        if (providerType === 'OIDC') {
                            outputProviders.push(providerName);
                        }
                        if (providerType === 'SAML') {
                            outputProviders.push(providerName);
                        }
                    }
                    return JSON.stringify(outputProviders);
                },
            });
            output.oauthCognitoDomain = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    const userPoolDomain = this.resources.userPool.node.tryFindChild(`${this.name}UserPoolDomain`);
                    if (!userPoolDomain) {
                        return '';
                    }
                    if (!(userPoolDomain instanceof aws_cognito_1.UserPoolDomain)) {
                        throw Error('Could not find UserPoolDomain resource in the stack.');
                    }
                    return `${userPoolDomain.domainName}.auth.${aws_cdk_lib_1.Stack.of(this).region}.amazoncognito.com`;
                },
            });
            output.oauthScope = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    var _a;
                    return JSON.stringify((_a = cfnUserPoolClient.allowedOAuthScopes) !== null && _a !== void 0 ? _a : []);
                },
            });
            output.oauthRedirectSignIn = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.callbackUrLs
                        ? cfnUserPoolClient.callbackUrLs.join(',')
                        : '';
                },
            });
            output.oauthRedirectSignOut = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.logoutUrLs
                        ? cfnUserPoolClient.logoutUrLs.join(',')
                        : '';
                },
            });
            output.oauthResponseType = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.allowedOAuthFlows
                        ? cfnUserPoolClient.allowedOAuthFlows.join(',')
                        : '';
                },
            });
            output.oauthClientId = aws_cdk_lib_1.Lazy.string({
                produce: () => {
                    return cfnUserPoolClient.ref;
                },
            });
            outputStorageStrategy.addBackendOutputEntry(backend_output_schemas_1.authOutputKey, {
                version: '1',
                payload: output,
            });
        };
        this.name = (_a = props.name) !== null && _a !== void 0 ? _a : '';
        this.domainPrefix = (_b = props.loginWith.externalProviders) === null || _b === void 0 ? void 0 : _b.domainPrefix;
        // UserPool
        this.computedUserPoolProps = this.getUserPoolProps(props);
        this.userPool = new aws_cdk_lib_1.aws_cognito.UserPool(this, `${this.name}UserPool`, this.computedUserPoolProps);
        // UserPool - External Providers (Oauth, SAML, OIDC) and User Pool Domain
        this.providerSetupResult = this.setupExternalProviders(this.userPool, props.loginWith);
        // UserPool Client
        const userPoolClient = new aws_cdk_lib_1.aws_cognito.UserPoolClient(this, `${this.name}UserPoolAppClient`, {
            userPool: this.userPool,
            authFlows: defaults_js_1.DEFAULTS.AUTH_FLOWS,
            preventUserExistenceErrors: defaults_js_1.DEFAULTS.PREVENT_USER_EXISTENCE_ERRORS,
            oAuth: this.providerSetupResult.oAuthSettings,
        });
        // Identity Pool
        const { identityPool, identityPoolRoleAttachment, roles: { auth, unAuth }, } = this.setupIdentityPool(this.userPool, userPoolClient, this.providerSetupResult);
        // Setup UserPool groups
        this.setupUserPoolGroups(props.groups, identityPool);
        const cfnUserPool = this.userPool.node.findChild('Resource');
        if (!(cfnUserPool instanceof aws_cognito_1.CfnUserPool)) {
            throw Error('Could not find CfnUserPool resource in stack.');
        }
        const cfnUserPoolClient = userPoolClient.node.findChild('Resource');
        if (!(cfnUserPoolClient instanceof aws_cognito_1.CfnUserPoolClient)) {
            throw Error('Could not find CfnUserPoolClient resource in stack.');
        }
        // expose resources
        this.resources = {
            userPool: this.userPool,
            userPoolClient,
            authenticatedUserIamRole: auth,
            unauthenticatedUserIamRole: unAuth,
            cfnResources: {
                cfnUserPool,
                cfnUserPoolClient,
                cfnIdentityPool: identityPool,
                cfnIdentityPoolRoleAttachment: identityPoolRoleAttachment,
            },
            groups: this.groups,
        };
        this.storeOutput(props.outputStorageStrategy);
        new backend_output_storage_1.AttributionMetadataStorage().storeAttributionMetadata(aws_cdk_lib_1.Stack.of(this), authStackType, path.resolve(__dirname, '..', 'package.json'));
    }
    /**
     * Parses the user invitation settings and inserts codes/usernames where necessary.
     * @param settings the invitation settings
     * @returns cognito.UserInvitationConfig | undefined
     */
    getUserInvitationSettings(settings) {
        if (!settings) {
            return undefined;
        }
        return {
            emailSubject: settings.emailSubject,
            emailBody: settings.emailBody
                ? settings.emailBody(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
            smsMessage: settings.smsMessage
                ? settings.smsMessage(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
        };
    }
    /**
     * Verify the email body depending on if 'CODE' or 'LINK' style is used.
     * This ensures that the template contains the necessary placeholders for Cognito to insert verification codes or links.
     * @param emailSettings the provided email settings
     * @returns emailBody
     */
    verifyEmailBody(emailSettings) {
        let emailBody;
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle !== 'LINK') {
            emailBody = emailSettings.verificationEmailBody(() => VERIFICATION_EMAIL_PLACEHOLDERS.CODE);
            if (!emailBody.includes(VERIFICATION_EMAIL_PLACEHOLDERS.CODE)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
            }
        }
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle === 'LINK') {
            let linkText = '';
            emailBody = emailSettings.verificationEmailBody((text) => {
                linkText = text
                    ? `{##${text}##}`
                    : VERIFICATION_EMAIL_PLACEHOLDERS.LINK;
                return linkText;
            });
            if (linkText === '' || !emailBody.includes(linkText)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'link' parameter at least once as a placeholder for the verification link.");
            }
        }
        return emailBody;
    }
}
exports.AmplifyAuth = AmplifyAuth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyw2Q0FLcUI7QUFNckIseURBeUJpQztBQUNqQyxpREFBK0Q7QUFDL0QsZ0ZBQWdGO0FBUWhGLCtDQUF5QztBQUN6QyxnRkFHNkM7QUFDN0MsMkNBQTZCO0FBbUI3QixNQUFNLGdDQUFnQyxHQUF5QjtJQUM3RCxRQUFRLEVBQUUsb0JBQW9CO0lBQzlCLE1BQU0sRUFBRSxxQkFBcUI7SUFDN0IsTUFBTSxFQUFFLGdCQUFnQjtJQUN4QixLQUFLLEVBQUUsbUJBQW1CO0NBQzNCLENBQUM7QUFDRixNQUFNLHVCQUF1QixHQUFHO0lBQzlCLElBQUksRUFBRSxRQUFRO0lBQ2QsUUFBUSxFQUFFLFlBQVk7Q0FDdkIsQ0FBQztBQUNGLE1BQU0sK0JBQStCLEdBQUc7SUFDdEMsSUFBSSxFQUFFLFFBQVE7SUFDZCxJQUFJLEVBQUUsb0JBQW9CO0NBQzNCLENBQUM7QUFDRixNQUFNLDZCQUE2QixHQUFHO0lBQ3BDLElBQUksRUFBRSxRQUFRO0NBQ2YsQ0FBQztBQUNGLE1BQU0sb0JBQW9CLEdBQUc7SUFDM0IsSUFBSSxFQUFFLFFBQVE7Q0FDZixDQUFDO0FBQ0YsTUFBTSxvQkFBb0IsR0FBRztJQUMzQix3QkFBVSxDQUFDLEtBQUs7SUFDaEIsd0JBQVUsQ0FBQyxLQUFLO0lBQ2hCLHdCQUFVLENBQUMsTUFBTTtJQUNqQix3QkFBVSxDQUFDLE9BQU87SUFDbEIsd0JBQVUsQ0FBQyxhQUFhO0NBQ3pCLENBQUM7QUFFRixzSEFBc0g7QUFDdEgsTUFBTSxhQUFhLEdBQUcsY0FBYyxDQUFDO0FBRXJDOztHQUVHO0FBQ0gsTUFBYSxXQUNYLFNBQVEsc0JBQVM7SUEyQmpCOzs7T0FHRztJQUNILFlBQ0UsS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLFFBQW1CLHNC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Q2pCLENBQUMsQ0FBQywrQkFBK0IsQ0FBQyxJQUFJLENBQUM7Z0JBQ3pDLE9BQU8sUUFBUSxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxRQUFRLEtBQUssRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDcEQsTUFBTSxLQUFLLENBQ1Qsc0pBQXNKLENBQ3ZKLENBQUM7YUFDSDtTQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQXNsQkY7QUFoa0NELGtDQWdrQ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7XG4gIExhenksXG4gIFJlbW92YWxQb2xpY3ksXG4gIFN0YWNrLFxuICBhd3NfY29nbml0byBhcyBjb2duaXRvLFxufSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQge1xuICBBdXRoUmVzb3VyY2VzLFxuICBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5LFxuICBSZXNvdXJjZVByb3ZpZGVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIENmbklkZW50aXR5UG9vbCxcbiAgQ2ZuVXNlclBvb2wsXG4gIENmblVzZXJQb29sQ2xpZW50LFxuICBDZm5Vc2VyUG9vbEdyb3VwLFxuICBDZm5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXIsXG4gIEN1c3RvbUF0dHJpYnV0ZUNvbmZpZyxcbiAgSUN1c3RvbUF0dHJpYnV0ZSxcbiAgTWZhLFxuICBNZmFTZWNvbmRGYWN0b3IsXG4gIE9BdXRoU2NvcGUsXG4gIE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLFxuICBQcm92aWRlckF0dHJpYnV0ZSxcbiAgU3RhbmRhcmRBdHRyaWJ1dGUsXG4gIFVzZXJQb29sLFxuICBVc2VyUG9vbENsaWVudCxcbiAgVXNlclBvb2xEb21haW4sXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFtYXpvbixcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGUsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rLFxuICBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJHb29nbGUsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlck9pZGMsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWwsXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWxNZXRhZGF0YVR5cGUsXG4gIFVzZXJQb29sUHJvcHMsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1jb2duaXRvJztcbmltcG9ydCB7IEZlZGVyYXRlZFByaW5jaXBhbCwgUm9sZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgQXV0aE91dHB1dCwgYXV0aE91dHB1dEtleSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zY2hlbWFzJztcbmltcG9ydCB7XG4gIEF0dHJpYnV0ZU1hcHBpbmcsXG4gIEF1dGhQcm9wcyxcbiAgQ3VzdG9tQXR0cmlidXRlLFxuICBFbWFpbExvZ2luU2V0dGluZ3MsXG4gIEV4dGVybmFsUHJvdmlkZXJPcHRpb25zLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IERFRkFVTFRTIH0gZnJvbSAnLi9kZWZhdWx0cy5qcyc7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSxcbiAgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5cbnR5cGUgRGVmYXVsdFJvbGVzID0geyBhdXRoOiBSb2xlOyB1bkF1dGg6IFJvbGUgfTtcbnR5cGUgSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0ID0ge1xuICBvQXV0aE1hcHBpbmdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICBvQXV0aFNldHRpbmdzOiBjb2duaXRvLk9BdXRoU2V0dGluZ3MgfCB1bmRlZmluZWQ7XG4gIGdvb2dsZT86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckdvb2dsZTtcbiAgZmFjZWJvb2s/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJGYWNlYm9vaztcbiAgYW1hem9uPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uO1xuICBhcHBsZT86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFwcGxlO1xuICBvaWRjPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyT2lkY1tdO1xuICBzYW1sPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbDtcbn07XG50eXBlIE9BdXRoUHJvdmlkZXJNYXBwaW5nID0ge1xuICBmYWNlYm9vazogc3RyaW5nO1xuICBnb29nbGU6IHN0cmluZztcbiAgYW1hem9uOiBzdHJpbmc7XG4gIGFwcGxlOiBzdHJpbmc7XG59O1xuY29uc3Qgb2F1dGhQcm92aWRlclRvUHJvdmlkZXJEb21haW5NYXA6IE9BdXRoUHJvdmlkZXJNYXBwaW5nID0ge1xuICBmYWNlYm9vazogJ2dyYXBoLmZhY2Vib29rLmNvbScsXG4gIGdvb2dsZTogJ2FjY291bnRzLmdvb2dsZS5jb20nLFxuICBhbWF6b246ICd3d3cuYW1hem9uLmNvbScsXG4gIGFwcGxlOiAnYXBwbGVpZC5hcHBsZS5jb20nLFxufTtcbmNvbnN0IElOVklUQVRJT05fUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9JyxcbiAgVVNFUk5BTUU6ICd7dXNlcm5hbWV9Jyxcbn07XG5jb25zdCBWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9JyxcbiAgTElOSzogJ3sjI1ZlcmlmeSBFbWFpbCMjfScsXG59O1xuY29uc3QgVkVSSUZJQ0FUSU9OX1NNU19QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxufTtcbmNvbnN0IE1GQV9TTVNfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9Jyxcbn07XG5jb25zdCBERUZBVUxUX09BVVRIX1NDT1BFUyA9IFtcbiAgT0F1dGhTY29wZS5QSE9ORSxcbiAgT0F1dGhTY29wZS5FTUFJTCxcbiAgT0F1dGhTY29wZS5PUEVOSUQsXG4gIE9BdXRoU2NvcGUuUFJPRklMRSxcbiAgT0F1dGhTY29wZS5DT0dOSVRPX0FETUlOLFxuXTtcblxuLy8gQmUgdmVyeSBjYXJlZnVsIGVkaXRpbmcgdGhpcyB2YWx1ZS4gSXQgaXMgdGhlIHN0cmluZyB0aGF0IGlzIHVzZWQgdG8gYXR0cmlidXRlIHN0YWNrcyB0byBBbXBsaWZ5IEF1dGggaW4gQkkgbWV0cmljc1xuY29uc3QgYXV0aFN0YWNrVHlwZSA9ICdhdXRoLUNvZ25pdG8nO1xuXG4vKipcbiAqIEFtcGxpZnkgQXV0aCBDREsgQ29uc3RydWN0XG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5QXV0aFxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcz5cbntcbiAgLyoqXG4gICAqIFRoZSByZXNvdXJjZXMgZ2VuZXJhdGVkIGJ5IHRoZSBjb25zdHJ1Y3QuXG4gICAqL1xuICByZWFkb25seSByZXNvdXJjZXM6IEF1dGhSZXNvdXJjZXM7XG4gIC8qKlxuICAgKiBFeHRlcm5hbCBwcm92aWRlciBzZXR0aW5nc1xuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBwcm92aWRlclNldHVwUmVzdWx0OiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQ7XG5cbiAgcHJpdmF0ZSByZWFkb25seSB1c2VyUG9vbDogVXNlclBvb2w7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjb21wdXRlZFVzZXJQb29sUHJvcHM6IFVzZXJQb29sUHJvcHM7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBkb21haW5QcmVmaXg6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGdyb3Vwczoge1xuICAgIFtrZXk6IHN0cmluZ106IHtcbiAgICAgIGNmblVzZXJHcm91cDogQ2ZuVXNlclBvb2xHcm91cDtcbiAgICAgIHJvbGU6IFJvbGU7XG4gICAgfTtcbiAgfSA9IHt9O1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQXV0aCBjb25zdHJ1Y3Qgd2l0aCBBdXRoUHJvcHMuXG4gICAqIElmIG5vIHByb3BzIGFyZSBwcm92aWRlZCwgZW1haWwgbG9naW4gYW5kIGRlZmF1bHRzIHdpbGwgYmUgdXNlZC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogQXV0aFByb3BzID0gREVGQVVMVFMuSUZfTk9fUFJPUFNfUFJPVklERURcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJyc7XG4gICAgdGhpcy5kb21haW5QcmVmaXggPSBwcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM/LmRvbWFpblByZWZpeDtcblxuICAgIC8vIFVzZXJQb29sXG4gICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMgPSB0aGlzLmdldFVzZXJQb29sUHJvcHMocHJvcHMpO1xuICAgIHRoaXMudXNlclBvb2wgPSBuZXcgY29nbml0by5Vc2VyUG9vbChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9VXNlclBvb2xgLFxuICAgICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHNcbiAgICApO1xuXG4gICAgLy8gVXNlclBvb2wgLSBFeHRlcm5hbCBQcm92aWRlcnMgKE9hdXRoLCBTQU1MLCBPSURDKSBhbmQgVXNlciBQb29sIERvbWFpblxuICAgIHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdCA9IHRoaXMuc2V0dXBFeHRlcm5hbFByb3ZpZGVycyhcbiAgICAgIHRoaXMudXNlclBvb2wsXG4gICAgICBwcm9wcy5sb2dpbldpdGhcbiAgICApO1xuXG4gICAgLy8gVXNlclBvb2wgQ2xpZW50XG4gICAgY29uc3QgdXNlclBvb2xDbGllbnQgPSBuZXcgY29nbml0by5Vc2VyUG9vbENsaWVudChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9VXNlclBvb2xBcHBDbGllbnRgLFxuICAgICAge1xuICAgICAgICB1c2VyUG9vbDogdGhpcy51c2VyUG9vbCxcbiAgICAgICAgYXV0aEZsb3dzOiBERUZBVUxUUy5BVVRIX0ZMT1dTLFxuICAgICAgICBwcmV2ZW50VXNlckV4aXN0ZW5jZUVycm9yczogREVGQVVMVFMuUFJFVkVOVF9VU0VSX0VYSVNURU5DRV9FUlJPUlMsXG4gICAgICAgIG9BdXRoOiB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhTZXR0aW5ncyxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gSWRlbnRpdHkgUG9vbFxuICAgIGNvbnN0IHtcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgcm9sZXM6IHsgYXV0aCwgdW5BdXRoIH0sXG4gICAgfSA9IHRoaXMuc2V0dXBJZGVudGl0eVBvb2woXG4gICAgICB0aGlzLnVzZXJQb29sLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHRcbiAgICApO1xuXG4gICAgLy8gU2V0dXAgVXNlclBvb2wgZ3JvdXBzXG4gICAgdGhpcy5zZXR1cFVzZXJQb29sR3JvdXBzKHByb3BzLmdyb3VwcywgaWRlbnRpdHlQb29sKTtcblxuICAgIGNvbnN0IGNmblVzZXJQb29sID0gdGhpcy51c2VyUG9vbC5ub2RlLmZpbmRDaGlsZCgnUmVzb3VyY2UnKSBhcyBDZm5Vc2VyUG9vbDtcbiAgICBpZiAoIShjZm5Vc2VyUG9vbCBpbnN0YW5jZW9mIENmblVzZXJQb29sKSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIENmblVzZXJQb29sIHJlc291cmNlIGluIHN0YWNrLicpO1xuICAgIH1cbiAgICBjb25zdCBjZm5Vc2VyUG9vbENsaWVudCA9IHVzZXJQb29sQ2xpZW50Lm5vZGUuZmluZENoaWxkKFxuICAgICAgJ1Jlc291cmNlJ1xuICAgICkgYXMgQ2ZuVXNlclBvb2xDbGllbnQ7XG4gICAgaWYgKCEoY2ZuVXNlclBvb2xDbGllbnQgaW5zdGFuY2VvZiBDZm5Vc2VyUG9vbENsaWVudCkpIHtcbiAgICAgIHRocm93IEVycm9yKCdDb3VsZCBub3QgZmluZCBDZm5Vc2VyUG9vbENsaWVudCByZXNvdXJjZSBpbiBzdGFjay4nKTtcbiAgICB9XG4gICAgLy8gZXhwb3NlIHJlc291cmNlc1xuICAgIHRoaXMucmVzb3VyY2VzID0ge1xuICAgICAgdXNlclBvb2w6IHRoaXMudXNlclBvb2wsXG4gICAgICB1c2VyUG9vbENsaWVudCxcbiAgICAgIGF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZTogYXV0aCxcbiAgICAgIHVuYXV0aGVudGljYXRlZFVzZXJJYW1Sb2xlOiB1bkF1dGgsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuVXNlclBvb2wsXG4gICAgICAgIGNmblVzZXJQb29sQ2xpZW50LFxuICAgICAgICBjZm5JZGVudGl0eVBvb2w6IGlkZW50aXR5UG9vbCxcbiAgICAgICAgY2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQ6IGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgfSxcbiAgICAgIGdyb3VwczogdGhpcy5ncm91cHMsXG4gICAgfTtcbiAgICB0aGlzLnN0b3JlT3V0cHV0KHByb3BzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSk7XG5cbiAgICBuZXcgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UoKS5zdG9yZUF0dHJpYnV0aW9uTWV0YWRhdGEoXG4gICAgICBTdGFjay5vZih0aGlzKSxcbiAgICAgIGF1dGhTdGFja1R5cGUsXG4gICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAncGFja2FnZS5qc29uJylcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBBdXRoL1VuQXV0aCBSb2xlc1xuICAgKiBAcmV0dXJucyBEZWZhdWx0Um9sZXNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBBdXRoQW5kVW5BdXRoUm9sZXMgPSAoaWRlbnRpdHlQb29sSWQ6IHN0cmluZyk6IERlZmF1bHRSb2xlcyA9PiB7XG4gICAgY29uc3QgcmVzdWx0OiBEZWZhdWx0Um9sZXMgPSB7XG4gICAgICBhdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9YXV0aGVudGljYXRlZFVzZXJSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sSWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogJ2F1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSdcbiAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgICAgdW5BdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9dW5hdXRoZW50aWNhdGVkVXNlclJvbGVgLCB7XG4gICAgICAgIGFzc3VtZWRCeTogbmV3IEZlZGVyYXRlZFByaW5jaXBhbChcbiAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphdWQnOiBpZGVudGl0eVBvb2xJZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnRm9yQW55VmFsdWU6U3RyaW5nTGlrZSc6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXInOiAndW5hdXRoZW50aWNhdGVkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknXG4gICAgICAgICksXG4gICAgICB9KSxcbiAgICB9O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEF1dG8gZ2VuZXJhdGUgdGhlIHVzZXIgcG9vbCBncm91cHMgYW5kIGdyb3VwIHJvbGVzXG4gICAqL1xuICBwcml2YXRlIHNldHVwVXNlclBvb2xHcm91cHMgPSAoXG4gICAgZ3JvdXBzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCxcbiAgICBpZGVudGl0eVBvb2w6IENmbklkZW50aXR5UG9vbFxuICApID0+IHtcbiAgICAoZ3JvdXBzIHx8IFtdKS5mb3JFYWNoKChncm91cE5hbWUsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBncm91cFJvbGUgPSBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9JHtncm91cE5hbWV9R3JvdXBSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnRm9yQW55VmFsdWU6U3RyaW5nTGlrZSc6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXInOiAnYXV0aGVudGljYXRlZCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ3N0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5J1xuICAgICAgICApLFxuICAgICAgfSk7XG4gICAgICBjb25zdCBjdXJyZW50R3JvdXAgPSBuZXcgQ2ZuVXNlclBvb2xHcm91cChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfSR7Z3JvdXBOYW1lfUdyb3VwYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sSWQ6IHRoaXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgICAgICBncm91cE5hbWU6IGdyb3VwTmFtZSxcbiAgICAgICAgICByb2xlQXJuOiBncm91cFJvbGUucm9sZUFybixcbiAgICAgICAgICBwcmVjZWRlbmNlOiBpbmRleCxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMuZ3JvdXBzW2dyb3VwTmFtZV0gPSB7XG4gICAgICAgIGNmblVzZXJHcm91cDogY3VycmVudEdyb3VwLFxuICAgICAgICByb2xlOiBncm91cFJvbGUsXG4gICAgICB9O1xuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXR1cCBJZGVudGl0eSBQb29sIHdpdGggZGVmYXVsdCByb2xlcy9yb2xlIG1hcHBpbmdzLCBhbmQgcmVnaXN0ZXIgcHJvdmlkZXJzXG4gICAqL1xuICBwcml2YXRlIHNldHVwSWRlbnRpdHlQb29sID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbCxcbiAgICB1c2VyUG9vbENsaWVudDogVXNlclBvb2xDbGllbnQsXG4gICAgcHJvdmlkZXJTZXR1cFJlc3VsdDogSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0XG4gICkgPT4ge1xuICAgIC8vIHNldHVwIGlkZW50aXR5IHBvb2xcbiAgICBjb25zdCByZWdpb24gPSBTdGFjay5vZih0aGlzKS5yZWdpb247XG4gICAgY29uc3QgaWRlbnRpdHlQb29sID0gbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKFxuICAgICAgdGhpcyxcbiAgICAgIGAke3RoaXMubmFtZX1JZGVudGl0eVBvb2xgLFxuICAgICAge1xuICAgICAgICBhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXM6XG4gICAgICAgICAgREVGQVVMVFMuQUxMT1dfVU5BVVRIRU5USUNBVEVEX0lERU5USVRJRVMsXG4gICAgICB9XG4gICAgKTtcbiAgICBjb25zdCByb2xlcyA9IHRoaXMuc2V0dXBBdXRoQW5kVW5BdXRoUm9sZXMoaWRlbnRpdHlQb29sLnJlZik7XG4gICAgY29uc3QgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQgPVxuICAgICAgbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudGAsXG4gICAgICAgIHtcbiAgICAgICAgICBpZGVudGl0eVBvb2xJZDogaWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgICByb2xlczoge1xuICAgICAgICAgICAgdW5hdXRoZW50aWNhdGVkOiByb2xlcy51bkF1dGgucm9sZUFybixcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0ZWQ6IHJvbGVzLmF1dGgucm9sZUFybixcbiAgICAgICAgICB9LFxuICAgICAgICAgIHJvbGVNYXBwaW5nczoge1xuICAgICAgICAgICAgVXNlclBvb2xXZWJDbGllbnRSb2xlTWFwcGluZzoge1xuICAgICAgICAgICAgICB0eXBlOiAnVG9rZW4nLFxuICAgICAgICAgICAgICBhbWJpZ3VvdXNSb2xlUmVzb2x1dGlvbjogJ0F1dGhlbnRpY2F0ZWRSb2xlJyxcbiAgICAgICAgICAgICAgaWRlbnRpdHlQcm92aWRlcjogYGNvZ25pdG8taWRwLiR7cmVnaW9ufS5hbWF6b25hd3MuY29tLyR7dXNlclBvb2wudXNlclBvb2xJZH06JHt1c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkfWAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQuYWRkRGVwZW5kZW5jeShpZGVudGl0eVBvb2wpO1xuICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh1c2VyUG9vbENsaWVudCk7XG4gICAgLy8gYWRkIGNvZ25pdG8gcHJvdmlkZXJcbiAgICBpZGVudGl0eVBvb2wuY29nbml0b0lkZW50aXR5UHJvdmlkZXJzID0gW1xuICAgICAge1xuICAgICAgICBjbGllbnRJZDogdXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgICAgcHJvdmlkZXJOYW1lOiBgY29nbml0by1pZHAuJHtyZWdpb259LmFtYXpvbmF3cy5jb20vJHt1c2VyUG9vbC51c2VyUG9vbElkfWAsXG4gICAgICB9LFxuICAgIF07XG4gICAgLy8gYWRkIG90aGVyIHByb3ZpZGVyc1xuICAgIGlkZW50aXR5UG9vbC5zdXBwb3J0ZWRMb2dpblByb3ZpZGVycyA9IHByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhNYXBwaW5ncztcbiAgICByZXR1cm4ge1xuICAgICAgaWRlbnRpdHlQb29sLFxuICAgICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQsXG4gICAgICByb2xlcyxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBEZWZpbmUgYmluZEN1c3RvbUF0dHJpYnV0ZSB0byBtZWV0IHJlcXVpcmVtZW50cyBvZiB0aGUgQ29nbml0byBBUEkgdG8gY2FsbCB0aGUgYmluZCBtZXRob2RcbiAgICovXG4gIHByaXZhdGUgYmluZEN1c3RvbUF0dHJpYnV0ZSA9IChcbiAgICBrZXk6IHN0cmluZyxcbiAgICBhdHRyaWJ1dGU6IEN1c3RvbUF0dHJpYnV0ZVxuICApOiBDdXN0b21BdHRyaWJ1dGVDb25maWcgJiBJQ3VzdG9tQXR0cmlidXRlID0+IHtcbiAgICBjb25zdCBiYXNlQ29uZmlnOiBDdXN0b21BdHRyaWJ1dGVDb25maWcgPSB7XG4gICAgICBkYXRhVHlwZTogYXR0cmlidXRlLmRhdGFUeXBlLFxuXG4gICAgICBtdXRhYmxlOiBhdHRyaWJ1dGUubXV0YWJsZSA/PyB0cnVlLFxuICAgIH07XG5cbiAgICBsZXQgY29uc3RyYWludHMgPSB7fTtcbiAgICAvLyBDb25kaXRpb25hbGx5IGFkZCBjb25zdHJhaW50IHByb3BlcnRpZXMgYmFzZWQgb24gZGF0YVR5cGUuXG4gICAgaWYgKGF0dHJpYnV0ZS5kYXRhVHlwZSA9PT0gJ1N0cmluZycpIHtcbiAgICAgIGNvbnN0cmFpbnRzID0ge1xuICAgICAgICBzdHJpbmdDb25zdHJhaW50czoge1xuICAgICAgICAgIG1pbkxlbjogYXR0cmlidXRlLm1pbkxlbixcblxuICAgICAgICAgIG1heExlbjogYXR0cmlidXRlLm1heExlbixcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfSBlbHNlIGlmIChhdHRyaWJ1dGUuZGF0YVR5cGUgPT09ICdOdW1iZXInKSB7XG4gICAgICBjb25zdHJhaW50cyA9IHtcbiAgICAgICAgbnVtYmVyQ29uc3RyYWludHM6IHtcbiAgICAgICAgICBtaW46IGF0dHJpYnV0ZS5taW4sXG5cbiAgICAgICAgICBtYXg6IGF0dHJpYnV0ZS5tYXgsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH1cbiAgICAvL1RoZSBmaW5hbCBjb25maWcgb2JqZWN0IGluY2x1ZGVzIGJhc2VDb25maWcgYW5kIGNvbmRpdGlvbmFsbHkgYWRkZWQgY29uc3RyYWludCBwcm9wZXJ0aWVzLlxuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgIC4uLmJhc2VDb25maWcsXG5cbiAgICAgIC4uLmNvbnN0cmFpbnRzLFxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4uY29uZmlnLFxuXG4gICAgICBiaW5kOiAoKSA9PiBjb25maWcsXG4gICAgfTtcbiAgfTtcbiAgLyoqXG4gICAqIFByb2Nlc3MgcHJvcHMgaW50byBVc2VyUG9vbFByb3BzIChzZXQgZGVmYXVsdHMgaWYgbmVlZGVkKVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRVc2VyUG9vbFByb3BzID0gKHByb3BzOiBBdXRoUHJvcHMpOiBVc2VyUG9vbFByb3BzID0+IHtcbiAgICBjb25zdCBlbWFpbEVuYWJsZWQgPSBwcm9wcy5sb2dpbldpdGguZW1haWwgPyB0cnVlIDogZmFsc2U7XG4gICAgY29uc3QgcGhvbmVFbmFibGVkID0gcHJvcHMubG9naW5XaXRoLnBob25lID8gdHJ1ZSA6IGZhbHNlO1xuICAgIGNvbnN0IG9uZU9mRW1haWxPclBob25lID0gZW1haWxFbmFibGVkIHx8IHBob25lRW5hYmxlZDtcbiAgICBpZiAoIW9uZU9mRW1haWxPclBob25lKSB7XG4gICAgICB0aHJvdyBFcnJvcignQXQgbGVhc3Qgb25lIG9mIGVtYWlsIG9yIHBob25lIG11c3QgYmUgZW5hYmxlZC4nKTtcbiAgICB9XG4gICAgbGV0IHVzZXJWZXJpZmljYXRpb25TZXR0aW5nczogY29nbml0by5Vc2VyVmVyaWZpY2F0aW9uQ29uZmlnID0ge307XG4gICAgLy8gZXh0cmFjdCBlbWFpbCBzZXR0aW5ncyBpZiBzZXR0aW5ncyBvYmplY3QgaXMgZGVmaW5lZFxuICAgIGlmICh0eXBlb2YgcHJvcHMubG9naW5XaXRoLmVtYWlsID09PSAnb2JqZWN0Jykge1xuICAgICAgY29uc3QgZW1haWxTZXR0aW5ncyA9IHByb3BzLmxvZ2luV2l0aC5lbWFpbDtcbiAgICAgIC8vIHZlcmlmeSBlbWFpbCBib2R5IGFuZCBpbmplY3QgdGhlIGFjdHVhbCB0ZW1wbGF0ZSB2YWx1ZXMgd2hpY2ggY29nbml0byB1c2VzXG4gICAgICBjb25zdCBlbWFpbEJvZHk6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHRoaXMudmVyaWZ5RW1haWxCb2R5KGVtYWlsU2V0dGluZ3MpO1xuICAgICAgdXNlclZlcmlmaWNhdGlvblNldHRpbmdzID0ge1xuICAgICAgICBlbWFpbEJvZHk6IGVtYWlsQm9keSxcbiAgICAgICAgZW1haWxTdHlsZTogdGhpcy5nZXRFbWFpbFZlcmlmaWNhdGlvblN0eWxlKFxuICAgICAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxTdHlsZVxuICAgICAgICApLFxuICAgICAgICBlbWFpbFN1YmplY3Q6IGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxTdWJqZWN0LFxuICAgICAgfTtcbiAgICB9XG4gICAgLy8gZXh0cmFjdCBwaG9uZSBzZXR0aW5ncyBpZiBzZXR0aW5ncyBvYmplY3QgaXMgZGVmaW5lZFxuICAgIGlmICh0eXBlb2YgcHJvcHMubG9naW5XaXRoLnBob25lID09PSAnb2JqZWN0Jykge1xuICAgICAgY29uc3QgcGhvbmVTZXR0aW5ncyA9IHByb3BzLmxvZ2luV2l0aC5waG9uZTtcbiAgICAgIGxldCBzbXNNZXNzYWdlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICBpZiAoXG4gICAgICAgIHBob25lU2V0dGluZ3MudmVyaWZpY2F0aW9uTWVzc2FnZSAmJlxuICAgICAgICB0eXBlb2YgcGhvbmVTZXR0aW5ncy52ZXJpZmljYXRpb25NZXNzYWdlID09PSAnZnVuY3Rpb24nXG4gICAgICApIHtcbiAgICAgICAgLy8gdmFsaWRhdGUgc21zIG1lc3NhZ2Ugc3RydWN0dXJlXG4gICAgICAgIHNtc01lc3NhZ2UgPSBwaG9uZVNldHRpbmdzLnZlcmlmaWNhdGlvbk1lc3NhZ2UoXG4gICAgICAgICAgKCkgPT4gVkVSSUZJQ0FUSU9OX1NNU19QTEFDRUhPTERFUlMuQ09ERVxuICAgICAgICApO1xuICAgICAgICBpZiAoIXNtc01lc3NhZ2UuaW5jbHVkZXMoVkVSSUZJQ0FUSU9OX1NNU19QTEFDRUhPTERFUlMuQ09ERSkpIHtcbiAgICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICAgIFwiSW52YWxpZCBwaG9uZSBzZXR0aW5ncy4gUHJvcGVydHkgJ3ZlcmlmaWNhdGlvbk1lc3NhZ2UnIG11c3QgdXRpbGl6ZSB0aGUgJ2NvZGUnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gY29kZS5cIlxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyA9IHtcbiAgICAgICAgLi4udXNlclZlcmlmaWNhdGlvblNldHRpbmdzLFxuICAgICAgICBzbXNNZXNzYWdlOiBzbXNNZXNzYWdlLFxuICAgICAgfTtcbiAgICB9XG4gICAgY29uc3QgbWZhVHlwZSA9IHRoaXMuZ2V0TUZBVHlwZShwcm9wcy5tdWx0aWZhY3Rvcik7XG4gICAgY29uc3QgbWZhTW9kZSA9IHRoaXMuZ2V0TUZBTW9kZShwcm9wcy5tdWx0aWZhY3Rvcik7XG5cbiAgICAvLyBJZiBwaG9uZSBsb2dpbiBpcyBlbmFibGVkIGFsb25nIHdpdGggTUZBLCBjb2duaXRvIHJlcXVpcmVzIHRoYXQgbWZhIFNNUyB0eXBlIHRvIGJlIGVuYWJsZWQuXG4gICAgaWYgKHBob25lRW5hYmxlZCAmJiBtZmFNb2RlICYmIG1mYU1vZGUgIT09ICdPRkYnICYmICFtZmFUeXBlPy5zbXMpIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAnSW52YWxpZCBNRkEgc2V0dGluZ3MuIFNNUyBtdXN0IGJlIGVuYWJsZWQgaW4gbXVsdGlGYWN0b3IgaWYgbG9naW5XaXRoIHBob25lIGlzIGVuYWJsZWQnXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHsgc3RhbmRhcmRBdHRyaWJ1dGVzLCBjdXN0b21BdHRyaWJ1dGVzIH0gPSBPYmplY3QuZW50cmllcyhcbiAgICAgIHByb3BzLnVzZXJBdHRyaWJ1dGVzID8/IHt9XG4gICAgKS5yZWR1Y2UoXG4gICAgICAoXG4gICAgICAgIGFjYzoge1xuICAgICAgICAgIHN0YW5kYXJkQXR0cmlidXRlczogeyBba2V5OiBzdHJpbmddOiBTdGFuZGFyZEF0dHJpYnV0ZSB9O1xuICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgIFtrZXk6IHN0cmluZ106IEN1c3RvbUF0dHJpYnV0ZUNvbmZpZyAmIElDdXN0b21BdHRyaWJ1dGU7XG4gICAgICAgICAgfTtcbiAgICAgICAgfSxcbiAgICAgICAgW2tleSwgdmFsdWVdXG4gICAgICApID0+IHtcbiAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCdjdXN0b206JykpIHtcbiAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVLZXkgPSBrZXkucmVwbGFjZSgvXmN1c3RvbTovaSwgJycpO1xuICAgICAgICAgIGFjYy5jdXN0b21BdHRyaWJ1dGVzW2F0dHJpYnV0ZUtleV0gPSB0aGlzLmJpbmRDdXN0b21BdHRyaWJ1dGUoXG4gICAgICAgICAgICBhdHRyaWJ1dGVLZXksXG4gICAgICAgICAgICB2YWx1ZVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYWNjLnN0YW5kYXJkQXR0cmlidXRlc1trZXldID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICB7IHN0YW5kYXJkQXR0cmlidXRlczoge30sIGN1c3RvbUF0dHJpYnV0ZXM6IHt9IH1cbiAgICApO1xuXG4gICAgY29uc3QgdXNlclBvb2xQcm9wczogVXNlclBvb2xQcm9wcyA9IHtcbiAgICAgIHNpZ25JbkNhc2VTZW5zaXRpdmU6IERFRkFVTFRTLlNJR05fSU5fQ0FTRV9TRU5TSVRJVkUsXG4gICAgICBzaWduSW5BbGlhc2VzOiB7XG4gICAgICAgIHBob25lOiBwaG9uZUVuYWJsZWQsXG4gICAgICAgIGVtYWlsOiBlbWFpbEVuYWJsZWQsXG4gICAgICB9LFxuICAgICAga2VlcE9yaWdpbmFsOiB7XG4gICAgICAgIGVtYWlsOiBlbWFpbEVuYWJsZWQsXG4gICAgICAgIHBob25lOiBwaG9uZUVuYWJsZWQsXG4gICAgICB9LFxuICAgICAgYXV0b1ZlcmlmeToge1xuICAgICAgICBlbWFpbDogZW1haWxFbmFibGVkLFxuICAgICAgICBwaG9uZTogcGhvbmVFbmFibGVkLFxuICAgICAgfSxcbiAgICAgIHVzZXJWZXJpZmljYXRpb246IHVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyxcbiAgICAgIHBhc3N3b3JkUG9saWN5OiBERUZBVUxUUy5QQVNTV09SRF9QT0xJQ1ksXG4gICAgICBzdGFuZGFyZEF0dHJpYnV0ZXM6IHtcbiAgICAgICAgZW1haWw6IERFRkFVTFRTLklTX1JFUVVJUkVEX0FUVFJJQlVURS5lbWFpbChlbWFpbEVuYWJsZWQpLFxuICAgICAgICBwaG9uZU51bWJlcjogREVGQVVMVFMuSVNfUkVRVUlSRURfQVRUUklCVVRFLnBob25lTnVtYmVyKHBob25lRW5hYmxlZCksXG4gICAgICAgIC4uLnN0YW5kYXJkQXR0cmlidXRlcyxcbiAgICAgIH0sXG4gICAgICBjdXN0b21BdHRyaWJ1dGVzOiB7XG4gICAgICAgIC4uLmN1c3RvbUF0dHJpYnV0ZXMsXG4gICAgICB9LFxuXG4gICAgICBzZWxmU2lnblVwRW5hYmxlZDogREVGQVVMVFMuQUxMT1dfU0VMRl9TSUdOX1VQLFxuICAgICAgbWZhOiBtZmFNb2RlLFxuICAgICAgbWZhTWVzc2FnZTogdGhpcy5nZXRNRkFNZXNzYWdlKHByb3BzLm11bHRpZmFjdG9yKSxcbiAgICAgIG1mYVNlY29uZEZhY3RvcjogbWZhVHlwZSxcbiAgICAgIGFjY291bnRSZWNvdmVyeTogdGhpcy5nZXRBY2NvdW50UmVjb3ZlcnlTZXR0aW5nKFxuICAgICAgICBlbWFpbEVuYWJsZWQsXG4gICAgICAgIHBob25lRW5hYmxlZCxcbiAgICAgICAgcHJvcHMuYWNjb3VudFJlY292ZXJ5XG4gICAgICApLFxuICAgICAgcmVtb3ZhbFBvbGljeTogUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgdXNlckludml0YXRpb246XG4gICAgICAgIHR5cGVvZiBwcm9wcy5sb2dpbldpdGguZW1haWwgIT09ICdib29sZWFuJ1xuICAgICAgICAgID8gdGhpcy5nZXRVc2VySW52aXRhdGlvblNldHRpbmdzKFxuICAgICAgICAgICAgICBwcm9wcy5sb2dpbldpdGguZW1haWw/LnVzZXJJbnZpdGF0aW9uXG4gICAgICAgICAgICApXG4gICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgfTtcbiAgICByZXR1cm4gdXNlclBvb2xQcm9wcztcbiAgfTtcblxuICAvKipcbiAgICogUGFyc2VzIHRoZSB1c2VyIGludml0YXRpb24gc2V0dGluZ3MgYW5kIGluc2VydHMgY29kZXMvdXNlcm5hbWVzIHdoZXJlIG5lY2Vzc2FyeS5cbiAgICogQHBhcmFtIHNldHRpbmdzIHRoZSBpbnZpdGF0aW9uIHNldHRpbmdzXG4gICAqIEByZXR1cm5zIGNvZ25pdG8uVXNlckludml0YXRpb25Db25maWcgfCB1bmRlZmluZWRcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlckludml0YXRpb25TZXR0aW5ncyhcbiAgICBzZXR0aW5nczogRW1haWxMb2dpblNldHRpbmdzWyd1c2VySW52aXRhdGlvbiddXG4gICk6IGNvZ25pdG8uVXNlckludml0YXRpb25Db25maWcgfCB1bmRlZmluZWQge1xuICAgIGlmICghc2V0dGluZ3MpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBlbWFpbFN1YmplY3Q6IHNldHRpbmdzLmVtYWlsU3ViamVjdCxcbiAgICAgIGVtYWlsQm9keTogc2V0dGluZ3MuZW1haWxCb2R5XG4gICAgICAgID8gc2V0dGluZ3MuZW1haWxCb2R5KFxuICAgICAgICAgICAgKCkgPT4gSU5WSVRBVElPTl9QTEFDRUhPTERFUlMuVVNFUk5BTUUsXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5DT0RFXG4gICAgICAgICAgKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICAgIHNtc01lc3NhZ2U6IHNldHRpbmdzLnNtc01lc3NhZ2VcbiAgICAgICAgPyBzZXR0aW5ncy5zbXNNZXNzYWdlKFxuICAgICAgICAgICAgKCkgPT4gSU5WSVRBVElPTl9QTEFDRUhPTERFUlMuVVNFUk5BTUUsXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5DT0RFXG4gICAgICAgICAgKVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSB0aGUgZW1haWwgYm9keSBkZXBlbmRpbmcgb24gaWYgJ0NPREUnIG9yICdMSU5LJyBzdHlsZSBpcyB1c2VkLlxuICAgKiBUaGlzIGVuc3VyZXMgdGhhdCB0aGUgdGVtcGxhdGUgY29udGFpbnMgdGhlIG5lY2Vzc2FyeSBwbGFjZWhvbGRlcnMgZm9yIENvZ25pdG8gdG8gaW5zZXJ0IHZlcmlmaWNhdGlvbiBjb2RlcyBvciBsaW5rcy5cbiAgICogQHBhcmFtIGVtYWlsU2V0dGluZ3MgdGhlIHByb3ZpZGVkIGVtYWlsIHNldHRpbmdzXG4gICAqIEByZXR1cm5zIGVtYWlsQm9keVxuICAgKi9cbiAgcHJpdmF0ZSB2ZXJpZnlFbWFpbEJvZHkoXG4gICAgZW1haWxTZXR0aW5nczogRW1haWxMb2dpblNldHRpbmdzXG4gICk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgbGV0IGVtYWlsQm9keTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGlmIChcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxCb2R5ICYmXG4gICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgIT09ICdMSU5LJ1xuICAgICkge1xuICAgICAgZW1haWxCb2R5ID0gZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkoXG4gICAgICAgICgpID0+IFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMuQ09ERVxuICAgICAgKTtcbiAgICAgIGlmICghZW1haWxCb2R5LmluY2x1ZGVzKFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMuQ09ERSkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgXCJJbnZhbGlkIGVtYWlsIHNldHRpbmdzLiBQcm9wZXJ0eSAndmVyaWZpY2F0aW9uRW1haWxCb2R5JyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKFxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkgJiZcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxTdHlsZSA9PT0gJ0xJTksnXG4gICAgKSB7XG4gICAgICBsZXQgbGlua1RleHQ6IHN0cmluZyA9ICcnO1xuICAgICAgZW1haWxCb2R5ID0gZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkoKHRleHQ/OiBzdHJpbmcpID0+IHtcbiAgICAgICAgbGlua1RleHQgPSB0ZXh0XG4gICAgICAgICAgPyBgeyMjJHt0ZXh0fSMjfWBcbiAgICAgICAgICA6IFZFUklGSUNBVElPTl9FTUFJTF9QTEFDRUhPTERFUlMuTElOSztcbiAgICAgICAgcmV0dXJuIGxpbmtUZXh0O1xuICAgICAgfSk7XG4gICAgICBpZiAobGlua1RleHQgPT09ICcnIHx8ICFlbWFpbEJvZHkuaW5jbHVkZXMobGlua1RleHQpKSB7XG4gICAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAgIFwiSW52YWxpZCBlbWFpbCBzZXR0aW5ncy4gUHJvcGVydHkgJ3ZlcmlmaWNhdGlvbkVtYWlsQm9keScgbXVzdCB1dGlsaXplIHRoZSAnbGluaycgcGFyYW1ldGVyIGF0IGxlYXN0IG9uY2UgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIHZlcmlmaWNhdGlvbiBsaW5rLlwiXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBlbWFpbEJvZHk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGVtYWlsIHZlcmlmaWNhdGlvbiBzdHlsZSBmcm9tIHVzZXIgcHJvcHNcbiAgICogQHBhcmFtIHZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgLSBzdHJpbmcgdmFsdWVcbiAgICogQHJldHVybnMgdmVyaWZpY2F0aW9uRW1haWxTdHlsZSAtIGVudW0gdmFsdWVcbiAgICovXG4gIHByaXZhdGUgZ2V0RW1haWxWZXJpZmljYXRpb25TdHlsZSA9IChcbiAgICB2ZXJpZmljYXRpb25FbWFpbFN0eWxlOiAnQ09ERScgfCAnTElOSycgfCB1bmRlZmluZWRcbiAgKTogY29nbml0by5WZXJpZmljYXRpb25FbWFpbFN0eWxlIHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAodmVyaWZpY2F0aW9uRW1haWxTdHlsZSA9PT0gJ0NPREUnKSB7XG4gICAgICByZXR1cm4gY29nbml0by5WZXJpZmljYXRpb25FbWFpbFN0eWxlLkNPREU7XG4gICAgfSBlbHNlIGlmICh2ZXJpZmljYXRpb25FbWFpbFN0eWxlID09PSAnTElOSycpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLlZlcmlmaWNhdGlvbkVtYWlsU3R5bGUuTElOSztcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogRGV0ZXJtaW5lIHRoZSBhY2NvdW50IHJlY292ZXJ5IG9wdGlvbiBiYXNlZCBvbiBlbmFibGVkIGxvZ2luIG1ldGhvZHMuXG4gICAqIEBwYXJhbSBlbWFpbEVuYWJsZWQgLSBpcyBlbWFpbCBlbmFibGVkXG4gICAqIEBwYXJhbSBwaG9uZUVuYWJsZWQgLSBpcyBwaG9uZSBlbmFibGVkXG4gICAqIEBwYXJhbSBhY2NvdW50UmVjb3ZlcnlNZXRob2RBc1N0cmluZyAtIHRoZSB1c2VyIHByb3ZpZGVkIGFjY291bnQgcmVjb3Zlcnkgc2V0dGluZ1xuICAgKiBAcmV0dXJucyBhY2NvdW50IHJlY292ZXJ5IHNldHRpbmcgZW51bSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRBY2NvdW50UmVjb3ZlcnlTZXR0aW5nID0gKFxuICAgIGVtYWlsRW5hYmxlZDogYm9vbGVhbixcbiAgICBwaG9uZUVuYWJsZWQ6IGJvb2xlYW4sXG4gICAgYWNjb3VudFJlY292ZXJ5TWV0aG9kQXNTdHJpbmc6IEF1dGhQcm9wc1snYWNjb3VudFJlY292ZXJ5J11cbiAgKTogY29nbml0by5BY2NvdW50UmVjb3ZlcnkgfCB1bmRlZmluZWQgPT4ge1xuICAgIGNvbnN0IGFjY291bnRSZWNvdmVyeSA9IHRoaXMuY29udmVydEFjY291bnRSZWNvdmVyeVN0cmluZ1RvRW51bShcbiAgICAgIGFjY291bnRSZWNvdmVyeU1ldGhvZEFzU3RyaW5nXG4gICAgKTtcbiAgICBpZiAoYWNjb3VudFJlY292ZXJ5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBhY2NvdW50UmVjb3Zlcnk7XG4gICAgfVxuICAgIC8vIHNldCBkZWZhdWx0IGJhc2VkIG9uIGVuYWJsZWQgbG9naW4gbWV0aG9kc1xuICAgIGlmIChwaG9uZUVuYWJsZWQgJiYgZW1haWxFbmFibGVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnkuRU1BSUxfT05MWTtcbiAgICB9XG4gICAgaWYgKHBob25lRW5hYmxlZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LlBIT05FX09OTFlfV0lUSE9VVF9NRkE7XG4gICAgfVxuICAgIGlmIChlbWFpbEVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5FTUFJTF9PTkxZO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0IHVzZXIgZnJpZW5kbHkgTWZhIG1vZGUgdG8gY29nbml0byBNZmEgTW9kZS5cbiAgICogVGhpcyBlbGltaW5hdGVzIHRoZSBuZWVkIGZvciB1c2VycyB0byBpbXBvcnQgY29nbml0by5NZmEuXG4gICAqIEBwYXJhbSBtZmEgLSBNRkEgc2V0dGluZ3NcbiAgICogQHJldHVybnMgY29nbml0byBNRkEgZW5mb3JjZW1lbnQgbW9kZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRNRkFNb2RlID0gKG1mYTogQXV0aFByb3BzWydtdWx0aWZhY3RvciddKTogTWZhIHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAobWZhKSB7XG4gICAgICBzd2l0Y2ggKG1mYS5tb2RlKSB7XG4gICAgICAgIGNhc2UgJ09GRic6XG4gICAgICAgICAgcmV0dXJuIE1mYS5PRkY7XG4gICAgICAgIGNhc2UgJ09QVElPTkFMJzpcbiAgICAgICAgICByZXR1cm4gTWZhLk9QVElPTkFMO1xuICAgICAgICBjYXNlICdSRVFVSVJFRCc6XG4gICAgICAgICAgcmV0dXJuIE1mYS5SRVFVSVJFRDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogQ29udmVydCB1c2VyIGZyaWVuZGx5IE1mYSB0eXBlIHRvIGNvZ25pdG8gTWZhIHR5cGUuXG4gICAqIFRoaXMgZWxpbWluYXRlcyB0aGUgbmVlZCBmb3IgdXNlcnMgdG8gaW1wb3J0IGNvZ25pdG8uTWZhLlxuICAgKiBAcGFyYW0gbWZhIC0gTUZBIHNldHRpbmdzXG4gICAqIEByZXR1cm5zIGNvZ25pdG8gTUZBIHR5cGUgKHNtcyBvciB0b3RwKVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRNRkFUeXBlID0gKFxuICAgIG1mYTogQXV0aFByb3BzWydtdWx0aWZhY3RvciddXG4gICk6IE1mYVNlY29uZEZhY3RvciB8IHVuZGVmaW5lZCA9PiB7XG4gICAgcmV0dXJuIHR5cGVvZiBtZmEgPT09ICdvYmplY3QnICYmIG1mYS5tb2RlICE9PSAnT0ZGJ1xuICAgICAgPyB7XG4gICAgICAgICAgc21zOiBtZmEuc21zID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICAgIG90cDogbWZhLnRvdHAgPyB0cnVlIDogZmFsc2UsXG4gICAgICAgIH1cbiAgICAgIDogdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0IHVzZXIgZnJpZW5kbHkgYWNjb3VudCByZWNvdmVyeSBtZXRob2QgdG8gY29nbml0byBBY2NvdW50UmVjb3ZlciBlbnVtLlxuICAgKiBUaGlzIGVsaW1pbmF0ZXMgdGhlIG5lZWQgZm9yIHVzZXJzIHRvIGltcG9ydCBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5cbiAgICogQHBhcmFtIG1ldGhvZCAtIGFjY291bnQgcmVjb3ZlcnkgbWV0aG9kIGFzIGEgc3RyaW5nIHZhbHVlXG4gICAqIEByZXR1cm5zIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5IGVudW0gdmFsdWVcbiAgICovXG4gIHByaXZhdGUgY29udmVydEFjY291bnRSZWNvdmVyeVN0cmluZ1RvRW51bSA9IChcbiAgICBtZXRob2Q6IEF1dGhQcm9wc1snYWNjb3VudFJlY292ZXJ5J11cbiAgKTogY29nbml0by5BY2NvdW50UmVjb3ZlcnkgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZXRob2QgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5W21ldGhvZF07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgdGhlIE1GQSBtZXNzYWdlIHNldHRpbmdzIGFuZCBwZXJmb3JtIHZhbGlkYXRpb24uXG4gICAqIEBwYXJhbSBtZmEgLSBNRkEgc2V0dGluZ3NcbiAgICogQHJldHVybnMgbWZhIG1lc3NhZ2VcbiAgICovXG4gIHByaXZhdGUgZ2V0TUZBTWVzc2FnZSA9IChcbiAgICBtZmE6IEF1dGhQcm9wc1snbXVsdGlmYWN0b3InXVxuICApOiBzdHJpbmcgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZmEgJiYgbWZhLm1vZGUgIT09ICdPRkYnICYmIHR5cGVvZiBtZmEuc21zID09PSAnb2JqZWN0Jykge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IG1mYS5zbXMuc21zTWVzc2FnZSgoKSA9PiBNRkFfU01TX1BMQUNFSE9MREVSUy5DT0RFKTtcbiAgICAgIGlmICghbWVzc2FnZS5pbmNsdWRlcyhNRkFfU01TX1BMQUNFSE9MREVSUy5DT0RFKSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgTUZBIHNldHRpbmdzLiBQcm9wZXJ0eSAnc21zTWVzc2FnZScgbXVzdCB1dGlsaXplIHRoZSAnY29kZScgcGFyYW1ldGVyIGF0IGxlYXN0IG9uY2UgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIHZlcmlmaWNhdGlvbiBjb2RlLlwiXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbWVzc2FnZTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogU2V0dXAgRXh0ZXJuYWwgUHJvdmlkZXJzIChPQXV0aC9PSURDL1NBTUwpIGFuZCByZWxhdGVkIHNldHRpbmdzXG4gICAqIHN1Y2ggYXMgT0F1dGggc2V0dGluZ3MgYW5kIFVzZXIgUG9vbCBEb21haW5zXG4gICAqL1xuICBwcml2YXRlIHNldHVwRXh0ZXJuYWxQcm92aWRlcnMgPSAoXG4gICAgdXNlclBvb2w6IFVzZXJQb29sLFxuICAgIGxvZ2luT3B0aW9uczogQXV0aFByb3BzWydsb2dpbldpdGgnXVxuICApOiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQgPT4ge1xuICAgIC8qKlxuICAgICAqIElmIGVtYWlsIGlzIGVuYWJsZWQsIGFuZCBpcyB0aGUgb25seSByZXF1aXJlZCBhdHRyaWJ1dGUsIHdlIGFyZSBhYmxlIHRvXG4gICAgICogYXV0b21hdGljYWxseSBtYXAgdGhlIGVtYWlsIGF0dHJpYnV0ZSBmcm9tIGV4dGVybmFsIHByb3ZpZGVycywgZXhjbHVkaW5nIFNBTUwuXG4gICAgICovXG4gICAgY29uc3Qgc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzID0gbG9naW5PcHRpb25zLmVtYWlsICYmICFsb2dpbk9wdGlvbnMucGhvbmU7XG4gICAgY29uc3QgcmVzdWx0OiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQgPSB7XG4gICAgICBvQXV0aE1hcHBpbmdzOiB7fSxcbiAgICAgIG9BdXRoU2V0dGluZ3M6IHtcbiAgICAgICAgZmxvd3M6IERFRkFVTFRTLk9BVVRIX0ZMT1dTLFxuICAgICAgfSxcbiAgICB9O1xuICAgIC8vIGV4dGVybmFsIHByb3ZpZGVyc1xuICAgIGNvbnN0IGV4dGVybmFsID0gbG9naW5PcHRpb25zLmV4dGVybmFsUHJvdmlkZXJzO1xuICAgIGlmICghZXh0ZXJuYWwpIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIC8vIG1ha2Ugc3VyZSBsb2dvdXQvY2FsbGJhY2sgdXJscyBhcmUgbm90IGVtcHR5XG4gICAgaWYgKGV4dGVybmFsLmxvZ291dFVybHMgJiYgZXh0ZXJuYWwubG9nb3V0VXJscy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAnWW91IG11c3QgZGVmaW5lIGxvZ291dFVybHMgd2hlbiBjb25maWd1cmluZyBleHRlcm5hbCBsb2dpbiBwcm92aWRlcnMuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLmNhbGxiYWNrVXJscyAmJiBleHRlcm5hbC5jYWxsYmFja1VybHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgJ1lvdSBtdXN0IGRlZmluZSBjYWxsYmFja1VybHMgd2hlbiBjb25maWd1cmluZyBleHRlcm5hbCBsb2dpbiBwcm92aWRlcnMuJ1xuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLmdvb2dsZSkge1xuICAgICAgY29uc3QgZ29vZ2xlUHJvcHMgPSBleHRlcm5hbC5nb29nbGU7XG4gICAgICByZXN1bHQuZ29vZ2xlID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyR29vZ2xlKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9R29vZ2xlSWRQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIGNsaWVudElkOiBnb29nbGVQcm9wcy5jbGllbnRJZCxcbiAgICAgICAgICBjbGllbnRTZWNyZXRWYWx1ZTogZ29vZ2xlUHJvcHMuY2xpZW50U2VjcmV0LFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDogUHJvdmlkZXJBdHRyaWJ1dGUuR09PR0xFX0VNQUlMLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQpLFxuICAgICAgICAgICAgLi4udGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgICAgZ29vZ2xlUHJvcHMuYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNjb3BlczogZ29vZ2xlUHJvcHMuc2NvcGVzLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9BdXRoTWFwcGluZ3Nbb2F1dGhQcm92aWRlclRvUHJvdmlkZXJEb21haW5NYXAuZ29vZ2xlXSA9XG4gICAgICAgIGV4dGVybmFsLmdvb2dsZS5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLmZhY2Vib29rKSB7XG4gICAgICByZXN1bHQuZmFjZWJvb2sgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJGYWNlYm9vayhcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUZhY2Vib29rSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIC4uLmV4dGVybmFsLmZhY2Vib29rLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDogUHJvdmlkZXJBdHRyaWJ1dGUuRkFDRUJPT0tfRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBleHRlcm5hbC5mYWNlYm9vay5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQub0F1dGhNYXBwaW5nc1tvYXV0aFByb3ZpZGVyVG9Qcm92aWRlckRvbWFpbk1hcC5mYWNlYm9va10gPVxuICAgICAgICBleHRlcm5hbC5mYWNlYm9vay5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbikge1xuICAgICAgcmVzdWx0LmFtYXpvbiA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFtYXpvbihcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfUFtYXpvbklEUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICAuLi5leHRlcm5hbC5sb2dpbldpdGhBbWF6b24sXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzoge1xuICAgICAgICAgICAgLi4uKHNob3VsZE1hcEVtYWlsQXR0cmlidXRlc1xuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiBQcm92aWRlckF0dHJpYnV0ZS5BTUFaT05fRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBleHRlcm5hbC5sb2dpbldpdGhBbWF6b24uYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9BdXRoTWFwcGluZ3Nbb2F1dGhQcm92aWRlclRvUHJvdmlkZXJEb21haW5NYXAuYW1hem9uXSA9XG4gICAgICAgIGV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbi5jbGllbnRJZDtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLnNpZ25JbldpdGhBcHBsZSkge1xuICAgICAgcmVzdWx0LmFwcGxlID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGUoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1BcHBsZUlEUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICAuLi5leHRlcm5hbC5zaWduSW5XaXRoQXBwbGUsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzoge1xuICAgICAgICAgICAgLi4uKHNob3VsZE1hcEVtYWlsQXR0cmlidXRlc1xuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiBQcm92aWRlckF0dHJpYnV0ZS5BUFBMRV9FTUFJTCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgIGV4dGVybmFsLnNpZ25JbldpdGhBcHBsZS5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQub0F1dGhNYXBwaW5nc1tvYXV0aFByb3ZpZGVyVG9Qcm92aWRlckRvbWFpbk1hcC5hcHBsZV0gPVxuICAgICAgICBleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUuY2xpZW50SWQ7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5vaWRjICYmIGV4dGVybmFsLm9pZGMubGVuZ3RoID4gMCkge1xuICAgICAgcmVzdWx0Lm9pZGMgPSBbXTtcbiAgICAgIGV4dGVybmFsLm9pZGMuZm9yRWFjaCgocHJvdmlkZXIsIGluZGV4KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3RNZXRob2QgPVxuICAgICAgICAgIHByb3ZpZGVyLmF0dHJpYnV0ZVJlcXVlc3RNZXRob2QgPT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgPyAnR0VUJyAvLyBkZWZhdWx0IGlmIG5vdCBkZWZpbmVkXG4gICAgICAgICAgICA6IHByb3ZpZGVyLmF0dHJpYnV0ZVJlcXVlc3RNZXRob2Q7XG4gICAgICAgIGNvbnN0IGdlbmVyYXRlZFByb3ZpZGVyID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyT2lkYyhcbiAgICAgICAgICB0aGlzLFxuICAgICAgICAgIGAke3RoaXMubmFtZX0ke3Byb3ZpZGVyLm5hbWUgPz8gaW5kZXh9T2lkY0lEUGAsXG4gICAgICAgICAge1xuICAgICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgICBhdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kOlxuICAgICAgICAgICAgICByZXF1ZXN0TWV0aG9kID09PSAnR0VUJ1xuICAgICAgICAgICAgICAgID8gT2lkY0F0dHJpYnV0ZVJlcXVlc3RNZXRob2QuR0VUXG4gICAgICAgICAgICAgICAgOiBPaWRjQXR0cmlidXRlUmVxdWVzdE1ldGhvZC5QT1NULFxuICAgICAgICAgICAgY2xpZW50SWQ6IHByb3ZpZGVyLmNsaWVudElkLFxuICAgICAgICAgICAgY2xpZW50U2VjcmV0OiBwcm92aWRlci5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgICBlbmRwb2ludHM6IHByb3ZpZGVyLmVuZHBvaW50cyxcbiAgICAgICAgICAgIGlkZW50aWZpZXJzOiBwcm92aWRlci5pZGVudGlmaWVycyxcbiAgICAgICAgICAgIGlzc3VlclVybDogcHJvdmlkZXIuaXNzdWVyVXJsLFxuICAgICAgICAgICAgbmFtZTogcHJvdmlkZXIubmFtZSxcbiAgICAgICAgICAgIHNjb3BlczogcHJvdmlkZXIuc2NvcGVzLFxuICAgICAgICAgICAgYXR0cmlidXRlTWFwcGluZzoge1xuICAgICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICAgIGVtYWlsOiB7XG4gICAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZTogJ2VtYWlsJyxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgICAgcHJvdmlkZXIuYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICAgIHJlc3VsdC5vaWRjPy5wdXNoKGdlbmVyYXRlZFByb3ZpZGVyKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuc2FtbCkge1xuICAgICAgY29uc3Qgc2FtbCA9IGV4dGVybmFsLnNhbWw7XG4gICAgICByZXN1bHQuc2FtbCA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWwoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1TYW1sSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICBzYW1sLmF0dHJpYnV0ZU1hcHBpbmdcbiAgICAgICAgICApLFxuICAgICAgICAgIGlkZW50aWZpZXJzOiBzYW1sLmlkZW50aWZpZXJzLFxuICAgICAgICAgIGlkcFNpZ25vdXQ6IHNhbWwuaWRwU2lnbm91dCxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgbWV0YWRhdGFDb250ZW50OiBzYW1sLm1ldGFkYXRhLm1ldGFkYXRhQ29udGVudCxcbiAgICAgICAgICAgIG1ldGFkYXRhVHlwZTpcbiAgICAgICAgICAgICAgc2FtbC5tZXRhZGF0YS5tZXRhZGF0YVR5cGUgPT09ICdGSUxFJ1xuICAgICAgICAgICAgICAgID8gVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZS5GSUxFXG4gICAgICAgICAgICAgICAgOiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sTWV0YWRhdGFUeXBlLlVSTCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG5hbWU6IHNhbWwubmFtZSxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBBbHdheXMgZ2VuZXJhdGUgYSBkb21haW4gcHJlZml4IGlmIGV4dGVybmFsIHByb3ZpZGVyIGlzIGNvbmZpZ3VyZWRcbiAgICBpZiAodGhpcy5kb21haW5QcmVmaXgpIHtcbiAgICAgIHRoaXMudXNlclBvb2wuYWRkRG9tYWluKGAke3RoaXMubmFtZX1Vc2VyUG9vbERvbWFpbmAsIHtcbiAgICAgICAgY29nbml0b0RvbWFpbjogeyBkb21haW5QcmVmaXg6IHRoaXMuZG9tYWluUHJlZml4IH0sXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQ29nbml0byBEb21haW4gUHJlZml4IGlzIG1pc3Npbmcgd2hlbiBleHRlcm5hbCBwcm92aWRlcnMgYXJlIGNvbmZpZ3VyZWQuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBvYXV0aCBzZXR0aW5ncyBmb3IgdGhlIFVzZXJQb29sIGNsaWVudFxuICAgIHJlc3VsdC5vQXV0aFNldHRpbmdzID0ge1xuICAgICAgY2FsbGJhY2tVcmxzOiBleHRlcm5hbC5jYWxsYmFja1VybHMsXG4gICAgICBsb2dvdXRVcmxzOiBleHRlcm5hbC5sb2dvdXRVcmxzLFxuICAgICAgc2NvcGVzOiBleHRlcm5hbC5zY29wZXNcbiAgICAgICAgPyB0aGlzLmdldE9BdXRoU2NvcGVzKGV4dGVybmFsLnNjb3BlcylcbiAgICAgICAgOiBERUZBVUxUX09BVVRIX1NDT1BFUyxcbiAgICAgIGZsb3dzOiBERUZBVUxUUy5PQVVUSF9GTE9XUyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICAvKipcbiAgICogQ29udmVydHMgdGhlIHNpbXBsaWZpZWQgbWFwcGluZyB0eXBlIHRvIGNvZ25pdG8uQXR0cmlidXRlTWFwcGluZy5cbiAgICogQHBhcmFtIG1hcHBpbmcgdGhlIEF0dHJpYnV0ZU1hcHBpbmcgdG8gY29udmVydCB0byBhIGNvZ25pdG8uQXR0cmlidXRlTWFwcGluZ1xuICAgKiBAcmV0dXJucyBjb2duaXRvLkF0dHJpYnV0ZU1hcHBpbmdcbiAgICovXG4gIHByaXZhdGUgY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcgPSAoXG4gICAgbWFwcGluZz86IEF0dHJpYnV0ZU1hcHBpbmdcbiAgKTogY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nIHwgdW5kZWZpbmVkID0+IHtcbiAgICBpZiAoIW1hcHBpbmcpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdDogUmVjb3JkPFxuICAgICAgc3RyaW5nLFxuICAgICAgfCBQcm92aWRlckF0dHJpYnV0ZVxuICAgICAgfCB7XG4gICAgICAgICAgW2tleTogc3RyaW5nXTogUHJvdmlkZXJBdHRyaWJ1dGU7XG4gICAgICAgIH1cbiAgICA+ID0ge307XG4gICAgZm9yIChjb25zdCBbYXR0ck5hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhtYXBwaW5nKSkge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmVzdWx0W2F0dHJOYW1lXSA9IHtcbiAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiB2YWx1ZSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIGF0dHJOYW1lID09PSAnY3VzdG9tJykge1xuICAgICAgICAvLyBkZWFsaW5nIHdpdGggY3VzdG9tIGF0dHJpYnV0ZXNcbiAgICAgICAgY29uc3QgY3VzdG9tQXR0cmlidXRlczogUmVjb3JkPHN0cmluZywgUHJvdmlkZXJBdHRyaWJ1dGU+ID0ge307XG4gICAgICAgIGZvciAoY29uc3QgW2N1c3RvbUtleSwgYXR0ck5hbWVdIG9mIE9iamVjdC5lbnRyaWVzKHZhbHVlKSkge1xuICAgICAgICAgIGN1c3RvbUF0dHJpYnV0ZXNbY3VzdG9tS2V5XSA9IHtcbiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWU6IGF0dHJOYW1lLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0W2F0dHJOYW1lXSA9IGN1c3RvbUF0dHJpYnV0ZXM7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG4gIC8qKlxuICAgKiBDb252ZXJ0IHNjb3BlcyBmcm9tIHN0cmluZyBsaXN0IHRvIE9BdXRoU2NvcGVzLlxuICAgKiBAcGFyYW0gc2NvcGVzIC0gc2NvcGUgbGlzdFxuICAgKiBAcmV0dXJucyBjb2duaXRvIE9BdXRoU2NvcGVzXG4gICAqL1xuICBwcml2YXRlIGdldE9BdXRoU2NvcGVzID0gKFxuICAgIHNjb3BlczogRXh0ZXJuYWxQcm92aWRlck9wdGlvbnNbJ3Njb3BlcyddXG4gICk6IGNvZ25pdG8uT0F1dGhTY29wZVtdID0+IHtcbiAgICBpZiAoc2NvcGVzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0OiBjb2duaXRvLk9BdXRoU2NvcGVbXSA9IFtdO1xuICAgIGZvciAoY29uc3Qgc2NvcGUgb2Ygc2NvcGVzKSB7XG4gICAgICByZXN1bHQucHVzaChjb2duaXRvLk9BdXRoU2NvcGVbc2NvcGVdKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICAvKipcbiAgICogU3RvcmVzIGF1dGggb3V0cHV0IHVzaW5nIHRoZSBwcm92aWRlZCBzdHJhdGVneVxuICAgKi9cbiAgcHJpdmF0ZSBzdG9yZU91dHB1dCA9IChcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8QXV0aE91dHB1dD4gPSBuZXcgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3koXG4gICAgICBTdGFjay5vZih0aGlzKVxuICAgIClcbiAgKTogdm9pZCA9PiB7XG4gICAgY29uc3QgY2ZuVXNlclBvb2wgPSB0aGlzLnJlc291cmNlcy5jZm5SZXNvdXJjZXMuY2ZuVXNlclBvb2w7XG4gICAgY29uc3QgY2ZuVXNlclBvb2xDbGllbnQgPSB0aGlzLnJlc291cmNlcy5jZm5SZXNvdXJjZXMuY2ZuVXNlclBvb2xDbGllbnQ7XG4gICAgY29uc3QgY2ZuSWRlbnRpdHlQb29sID0gdGhpcy5yZXNvdXJjZXMuY2ZuUmVzb3VyY2VzLmNmbklkZW50aXR5UG9vbDtcbiAgICAvLyB0aGVzZSBwcm9wZXJ0aWVzIGNhbm5vdCBiZSBvdmVyd3JpdHRlblxuICAgIGNvbnN0IG91dHB1dDogQXV0aE91dHB1dFsncGF5bG9hZCddID0ge1xuICAgICAgdXNlclBvb2xJZDogdGhpcy5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgIHdlYkNsaWVudElkOiB0aGlzLnJlc291cmNlcy51c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgaWRlbnRpdHlQb29sSWQ6IGNmbklkZW50aXR5UG9vbC5yZWYsXG4gICAgICBhdXRoUmVnaW9uOiBTdGFjay5vZih0aGlzKS5yZWdpb24sXG4gICAgfTtcblxuICAgIC8vIHRoZSBwcm9wZXJ0aWVzIGJlbG93IHRoaXMgbGluZSBjYW4gYmUgb3ZlcndyaXR0ZW4sIHNvIHRoZXkgYXJlIGV4cG9zZWQgdmlhIGNkayBMQVpZXG4gICAgb3V0cHV0LmFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+XG4gICAgICAgIGNmbklkZW50aXR5UG9vbC5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMgPT09IHRydWVcbiAgICAgICAgICA/ICd0cnVlJ1xuICAgICAgICAgIDogJ2ZhbHNlJyxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3Qgc2lnbnVwQXR0cmlidXRlcyBmcm9tIFVzZXJQb29sIHNjaGVtYSdzIHJlcXVpcmVkIGF0dHJpYnV0ZXNcbiAgICBvdXRwdXQuc2lnbnVwQXR0cmlidXRlcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgaWYgKCFjZm5Vc2VyUG9vbC5zY2hlbWEpIHtcbiAgICAgICAgICByZXR1cm4gJ1tdJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgKGNmblVzZXJQb29sLnNjaGVtYSBhcyBDZm5Vc2VyUG9vbC5TY2hlbWFBdHRyaWJ1dGVQcm9wZXJ0eVtdKVxuICAgICAgICAgICAgLmZpbHRlcigoYXR0cmlidXRlKSA9PiBhdHRyaWJ1dGUucmVxdWlyZWQgJiYgYXR0cmlidXRlLm5hbWUpXG4gICAgICAgICAgICAubWFwKChhdHRyaWJ1dGUpID0+IGF0dHJpYnV0ZS5uYW1lPy50b0xvd2VyQ2FzZSgpKVxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3QgdXNlcm5hbWVBdHRyaWJ1dGVzIGZyb20gVXNlclBvb2wncyB1c2VybmFtZUF0dHJpYnV0ZXNcbiAgICBvdXRwdXQudXNlcm5hbWVBdHRyaWJ1dGVzID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgY2ZuVXNlclBvb2wudXNlcm5hbWVBdHRyaWJ1dGVzPy5tYXAoKGF0dHIpID0+IGF0dHIudG9Mb3dlckNhc2UoKSkgfHxcbiAgICAgICAgICAgIFtdXG4gICAgICAgICk7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gZXh0cmFjdCB2ZXJpZmljYXRpb25NZWNoYW5pc21zIGZyb20gVXNlclBvb2wncyBhdXRvVmVyaWZpZWRBdHRyaWJ1dGVzXG4gICAgb3V0cHV0LnZlcmlmaWNhdGlvbk1lY2hhbmlzbXMgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShjZm5Vc2VyUG9vbC5hdXRvVmVyaWZpZWRBdHRyaWJ1dGVzID8/IFtdKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBleHRyYWN0IHRoZSBwYXNzd29yZFBvbGljeSBmcm9tIHRoZSBVc2VyUG9vbCBwb2xpY2llc1xuICAgIG91dHB1dC5wYXNzd29yZFBvbGljeU1pbkxlbmd0aCA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgaWYgKCFjZm5Vc2VyUG9vbC5wb2xpY2llcykge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwb2xpY3kgPSAoY2ZuVXNlclBvb2wucG9saWNpZXMgYXMgQ2ZuVXNlclBvb2wuUG9saWNpZXNQcm9wZXJ0eSlcbiAgICAgICAgICAucGFzc3dvcmRQb2xpY3kgYXMgQ2ZuVXNlclBvb2wuUGFzc3dvcmRQb2xpY3lQcm9wZXJ0eTtcbiAgICAgICAgcmV0dXJuIHBvbGljeS5taW5pbXVtTGVuZ3RoPy50b1N0cmluZygpO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIG91dHB1dC5wYXNzd29yZFBvbGljeVJlcXVpcmVtZW50cyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgaWYgKCFjZm5Vc2VyUG9vbC5wb2xpY2llcykge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwb2xpY3kgPSAoY2ZuVXNlclBvb2wucG9saWNpZXMgYXMgQ2ZuVXNlclBvb2wuUG9saWNpZXNQcm9wZXJ0eSlcbiAgICAgICAgICAucGFzc3dvcmRQb2xpY3kgYXMgQ2ZuVXNlclBvb2wuUGFzc3dvcmRQb2xpY3lQcm9wZXJ0eTtcbiAgICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gW107XG4gICAgICAgIHBvbGljeS5yZXF1aXJlTnVtYmVycyAmJiByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTlVNQkVSUycpO1xuICAgICAgICBwb2xpY3kucmVxdWlyZUxvd2VyY2FzZSAmJiByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTE9XRVJDQVNFJyk7XG4gICAgICAgIHBvbGljeS5yZXF1aXJlVXBwZXJjYXNlICYmIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19VUFBFUkNBU0UnKTtcbiAgICAgICAgcG9saWN5LnJlcXVpcmVTeW1ib2xzICYmIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19TWU1CT0xTJyk7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShyZXF1aXJlbWVudHMpO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3QgdGhlIE1GQSBjb25maWd1cmF0aW9uIHNldHRpbmcgZnJvbSB0aGUgVXNlclBvb2wgcmVzb3VyY2VcbiAgICBvdXRwdXQubWZhQ29uZmlndXJhdGlvbiA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGNmblVzZXJQb29sLm1mYUNvbmZpZ3VyYXRpb24gPz8gJ09GRic7XG4gICAgICB9LFxuICAgIH0pO1xuICAgIC8vIGV4dHJhY3QgdGhlIE1GQSB0eXBlcyBmcm9tIHRoZSBVc2VyUG9vbCByZXNvdXJjZVxuICAgIG91dHB1dC5tZmFUeXBlcyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgY29uc3QgbWZhVHlwZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIChjZm5Vc2VyUG9vbC5lbmFibGVkTWZhcyA/PyBbXSkuZm9yRWFjaCgodHlwZSkgPT4ge1xuICAgICAgICAgIGlmICh0eXBlID09PSAnU01TX01GQScpIHtcbiAgICAgICAgICAgIG1mYVR5cGVzLnB1c2goJ1NNUycpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodHlwZSA9PT0gJ1NPRlRXQVJFX1RPS0VOX01GQScpIHtcbiAgICAgICAgICAgIG1mYVR5cGVzLnB1c2goJ1RPVFAnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobWZhVHlwZXMpO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIGV4dHJhY3Qgc29jaWFsIHByb3ZpZGVycyBmcm9tIFVzZXJQb29sIHJlc291cmNlXG4gICAgb3V0cHV0LnNvY2lhbFByb3ZpZGVycyA9IExhenkuc3RyaW5nKHtcbiAgICAgIHByb2R1Y2U6ICgpID0+IHtcbiAgICAgICAgY29uc3Qgb3V0cHV0UHJvdmlkZXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBjb25zdCB1c2VyUG9vbFByb3ZpZGVycyA9IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sLmlkZW50aXR5UHJvdmlkZXJzO1xuICAgICAgICBpZiAoIXVzZXJQb29sUHJvdmlkZXJzIHx8IHVzZXJQb29sUHJvdmlkZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIHVzZXJQb29sUHJvdmlkZXJzKSB7XG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJSZXNvdXJjZSA9IHByb3ZpZGVyLm5vZGUuZmluZENoaWxkKFxuICAgICAgICAgICAgJ1Jlc291cmNlJ1xuICAgICAgICAgICkgYXMgQ2ZuVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyO1xuICAgICAgICAgIGlmICghKHByb3ZpZGVyUmVzb3VyY2UgaW5zdGFuY2VvZiBDZm5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXIpKSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICAgICAgJ0NvdWxkIG5vdCBmaW5kIHRoZSBDZm5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXIgcmVzb3VyY2UgaW4gdGhlIHN0YWNrLidcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHByb3ZpZGVyVHlwZSA9IHByb3ZpZGVyUmVzb3VyY2UucHJvdmlkZXJUeXBlO1xuICAgICAgICAgIGNvbnN0IHByb3ZpZGVyTmFtZSA9IHByb3ZpZGVyUmVzb3VyY2UucHJvdmlkZXJOYW1lO1xuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdHb29nbGUnKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaCgnR09PR0xFJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdGYWNlYm9vaycpIHtcbiAgICAgICAgICAgIG91dHB1dFByb3ZpZGVycy5wdXNoKCdGQUNFQk9PSycpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnU2lnbkluV2l0aEFwcGxlJykge1xuICAgICAgICAgICAgb3V0cHV0UHJvdmlkZXJzLnB1c2goJ1NJR05fSU5fV0lUSF9BUFBMRScpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAocHJvdmlkZXJUeXBlID09PSAnTG9naW5XaXRoQW1hem9uJykge1xuICAgICAgICAgICAgb3V0cHV0UHJvdmlkZXJzLnB1c2goJ0xPR0lOX1dJVEhfQU1BWk9OJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChwcm92aWRlclR5cGUgPT09ICdPSURDJykge1xuICAgICAgICAgICAgb3V0cHV0UHJvdmlkZXJzLnB1c2gocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHByb3ZpZGVyVHlwZSA9PT0gJ1NBTUwnKSB7XG4gICAgICAgICAgICBvdXRwdXRQcm92aWRlcnMucHVzaChwcm92aWRlck5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob3V0cHV0UHJvdmlkZXJzKTtcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhDb2duaXRvRG9tYWluID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICBjb25zdCB1c2VyUG9vbERvbWFpbiA9IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sLm5vZGUudHJ5RmluZENoaWxkKFxuICAgICAgICAgIGAke3RoaXMubmFtZX1Vc2VyUG9vbERvbWFpbmBcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCF1c2VyUG9vbERvbWFpbikge1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBpZiAoISh1c2VyUG9vbERvbWFpbiBpbnN0YW5jZW9mIFVzZXJQb29sRG9tYWluKSkge1xuICAgICAgICAgIHRocm93IEVycm9yKCdDb3VsZCBub3QgZmluZCBVc2VyUG9vbERvbWFpbiByZXNvdXJjZSBpbiB0aGUgc3RhY2suJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGAke3VzZXJQb29sRG9tYWluLmRvbWFpbk5hbWV9LmF1dGguJHtcbiAgICAgICAgICBTdGFjay5vZih0aGlzKS5yZWdpb25cbiAgICAgICAgfS5hbWF6b25jb2duaXRvLmNvbWA7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoU2NvcGUgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShjZm5Vc2VyUG9vbENsaWVudC5hbGxvd2VkT0F1dGhTY29wZXMgPz8gW10pO1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIG91dHB1dC5vYXV0aFJlZGlyZWN0U2lnbkluID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gY2ZuVXNlclBvb2xDbGllbnQuY2FsbGJhY2tVckxzXG4gICAgICAgICAgPyBjZm5Vc2VyUG9vbENsaWVudC5jYWxsYmFja1VyTHMuam9pbignLCcpXG4gICAgICAgICAgOiAnJztcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBvdXRwdXQub2F1dGhSZWRpcmVjdFNpZ25PdXQgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5sb2dvdXRVckxzXG4gICAgICAgICAgPyBjZm5Vc2VyUG9vbENsaWVudC5sb2dvdXRVckxzLmpvaW4oJywnKVxuICAgICAgICAgIDogJyc7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoUmVzcG9uc2VUeXBlID0gTGF6eS5zdHJpbmcoe1xuICAgICAgcHJvZHVjZTogKCkgPT4ge1xuICAgICAgICByZXR1cm4gY2ZuVXNlclBvb2xDbGllbnQuYWxsb3dlZE9BdXRoRmxvd3NcbiAgICAgICAgICA/IGNmblVzZXJQb29sQ2xpZW50LmFsbG93ZWRPQXV0aEZsb3dzLmpvaW4oJywnKVxuICAgICAgICAgIDogJyc7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0Lm9hdXRoQ2xpZW50SWQgPSBMYXp5LnN0cmluZyh7XG4gICAgICBwcm9kdWNlOiAoKSA9PiB7XG4gICAgICAgIHJldHVybiBjZm5Vc2VyUG9vbENsaWVudC5yZWY7XG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LmFkZEJhY2tlbmRPdXRwdXRFbnRyeShhdXRoT3V0cHV0S2V5LCB7XG4gICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICBwYXlsb2FkOiBvdXRwdXQsXG4gICAgfSk7XG4gIH07XG59XG4iXX0=