import fs from 'fs';
import fsp from 'fs/promises';
import { AmplifyPrompter, format, printer } from '@aws-amplify/cli-core';
import { ClientConfigFormat, ClientConfigVersionOption, DEFAULT_CLIENT_CONFIG_VERSION, generateEmptyClientConfigToFile, getClientConfigFileName, getClientConfigPath, } from '@aws-amplify/client-config';
import { ClientConfigLifecycleHandler } from '../../client-config/client_config_lifecycle_handler.js';
/**
 * Command that starts sandbox.
 */
export class SandboxCommand {
    sandboxFactory;
    sandboxSubCommands;
    clientConfigGeneratorAdapter;
    commandMiddleware;
    packageManagerController;
    sandboxEventHandlerCreator;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    sandboxIdentifier;
    /**
     * Creates sandbox command.
     */
    constructor(sandboxFactory, sandboxSubCommands, clientConfigGeneratorAdapter, commandMiddleware, packageManagerController, sandboxEventHandlerCreator) {
        this.sandboxFactory = sandboxFactory;
        this.sandboxSubCommands = sandboxSubCommands;
        this.clientConfigGeneratorAdapter = clientConfigGeneratorAdapter;
        this.commandMiddleware = commandMiddleware;
        this.packageManagerController = packageManagerController;
        this.sandboxEventHandlerCreator = sandboxEventHandlerCreator;
        this.command = 'sandbox';
        this.describe =
            'Starts sandbox, watch mode for Amplify backend deployments';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const sandbox = await this.sandboxFactory.getInstance();
        this.sandboxIdentifier = args.identifier;
        // attaching event handlers
        const clientConfigLifecycleHandler = new ClientConfigLifecycleHandler(this.clientConfigGeneratorAdapter, args.outputsVersion, args.outputsOutDir, args.outputsFormat);
        const eventHandlers = this.sandboxEventHandlerCreator?.({
            sandboxIdentifier: this.sandboxIdentifier,
            clientConfigLifecycleHandler,
        });
        if (eventHandlers) {
            Object.entries(eventHandlers).forEach(([event, handlers]) => {
                handlers.forEach((handler) => sandbox.on(event, handler));
            });
        }
        const watchExclusions = args.exclude ?? [];
        const fileName = getClientConfigFileName(args.outputsVersion);
        const clientConfigWritePath = await getClientConfigPath(fileName, args.outputsOutDir, args.outputsFormat);
        if (!fs.existsSync(clientConfigWritePath)) {
            await generateEmptyClientConfigToFile(args.outputsVersion, args.outputsOutDir, args.outputsFormat);
        }
        watchExclusions.push(clientConfigWritePath);
        let functionStreamingOptions = {
            enabled: false,
        };
        if (args.streamFunctionLogs) {
            // turn on function logs streaming
            functionStreamingOptions = {
                enabled: true,
                logsFilters: args.logsFilter,
                logsOutFile: args.logsOutFile,
            };
            if (args.logsOutFile) {
                watchExclusions.push(args.logsOutFile);
            }
        }
        await sandbox.start({
            dir: args.dirToWatch,
            exclude: watchExclusions,
            identifier: args.identifier,
            profile: args.profile,
            watchForChanges: !args.once,
            functionStreamingOptions,
        });
        process.once('SIGINT', () => void this.sigIntHandler());
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return (yargs
            // Cast to erase options types used in internal sub command implementation. Otherwise, compiler fails here.
            .command(this.sandboxSubCommands)
            .version(false)
            .option('dir-to-watch', {
            describe: 'Directory to watch for file changes. All subdirectories and files will be included. Defaults to the amplify directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('exclude', {
            describe: 'An array of paths or glob patterns to ignore. Paths can be relative or absolute and can either be files or directories',
            type: 'string',
            array: true,
            global: false,
        })
            .option('identifier', {
            describe: 'An optional identifier to distinguish between different sandboxes. Default is the name of the system user executing the process',
            type: 'string',
            array: false,
        })
            .option('outputs-format', {
            describe: 'amplify_outputs file format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
            global: false,
        })
            .option('outputs-version', {
            describe: 'Version of the configuration. Version 0 represents classic amplify-cli config file amplify-configuration and 1 represents newer config file amplify_outputs',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigVersionOption),
            global: false,
            default: DEFAULT_CLIENT_CONFIG_VERSION,
        })
            .option('outputs-out-dir', {
            describe: 'A path to directory where amplify_outputs is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('profile', {
            describe: 'An AWS profile name.',
            type: 'string',
            array: false,
        })
            .option('once', {
            describe: 'Execute a single sandbox deployment without watching for future file changes',
            boolean: true,
            global: false,
        })
            .option('stream-function-logs', {
            describe: 'Whether to stream function execution logs. Default: false. Use --logs-filter in addition to this flag to stream specific function logs',
            boolean: true,
            global: false,
            group: 'Logs streaming',
        })
            .option('logs-filter', {
            describe: `Regex pattern to filter logs from only matched functions. E.g. to stream logs for a function, specify it's name, and to stream logs from all functions starting with auth specify 'auth' Default: Stream all logs`,
            array: true,
            type: 'string',
            group: 'Logs streaming',
            implies: ['stream-function-logs'],
            requiresArg: true,
        })
            .option('logs-out-file', {
            describe: 'File to append the streaming logs. The file is created if it does not exist. Default: stdout',
            array: false,
            type: 'string',
            group: 'Logs streaming',
            implies: ['stream-function-logs'],
            requiresArg: true,
        })
            .check(async (argv) => {
            if (argv['dir-to-watch']) {
                await this.validateDirectory('dir-to-watch', argv['dir-to-watch']);
            }
            if (argv.identifier) {
                const identifierRegex = /^[a-zA-Z0-9-]{1,15}$/;
                if (!argv.identifier.match(identifierRegex)) {
                    throw new Error(`--identifier should match [a-zA-Z0-9-] and be less than 15 characters.`);
                }
            }
            return true;
        })
            .conflicts('once', [
            'exclude',
            'dir-to-watch',
            'stream-function-logs',
            'logs-filter',
            'logs-out-file',
        ])
            .middleware([this.commandMiddleware.ensureAwsCredentialAndRegion]));
    };
    sigIntHandler = async () => {
        if (!this.packageManagerController.allowsSignalPropagation()) {
            printer.print(`Stopping the sandbox process. To delete the sandbox, run ${format.normalizeAmpxCommand('sandbox delete')}`);
            return;
        }
        const answer = await AmplifyPrompter.yesOrNo({
            message: 'Would you like to delete all the resources in your sandbox environment (This cannot be undone)?',
            defaultValue: false,
        });
        if (answer)
            await (await this.sandboxFactory.getInstance()).delete({ identifier: this.sandboxIdentifier });
    };
    validateDirectory = async (option, dir) => {
        let stats;
        try {
            stats = await fsp.stat(dir, {});
        }
        catch (e) {
            throw new Error(`--${option} ${dir} does not exist`);
        }
        if (!stats.isDirectory()) {
            throw new Error(`--${option} ${dir} is not a valid directory`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9jb21tYW5kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL3NhbmRib3gvc2FuZGJveF9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUM7QUFDOUIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFLekUsT0FBTyxFQUNMLGtCQUFrQixFQUVsQix5QkFBeUIsRUFDekIsNkJBQTZCLEVBQzdCLCtCQUErQixFQUMvQix1QkFBdUIsRUFDdkIsbUJBQW1CLEdBQ3BCLE1BQU0sNEJBQTRCLENBQUM7QUFDcEMsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sd0RBQXdELENBQUM7QUFzQ3RHOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGNBQWM7SUFtQk47SUFDQTtJQUNUO0lBQ0E7SUFDUztJQUNBO0lBckJuQjs7T0FFRztJQUNNLE9BQU8sQ0FBUztJQUV6Qjs7T0FFRztJQUNNLFFBQVEsQ0FBUztJQUVsQixpQkFBaUIsQ0FBVTtJQUVuQzs7T0FFRztJQUNILFlBQ21CLGNBQXVDLEVBQ3ZDLGtCQUFtQyxFQUM1Qyw0QkFBMEQsRUFDMUQsaUJBQW9DLEVBQzNCLHdCQUFrRCxFQUNsRCwwQkFBdUQ7UUFMdkQsbUJBQWMsR0FBZCxjQUFjLENBQXlCO1FBQ3ZDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBaUI7UUFDNUMsaUNBQTRCLEdBQTVCLDRCQUE0QixDQUE4QjtRQUMxRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQzNCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE2QjtRQUV4RSxJQUFJLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUTtZ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Q1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxLQUFLLE1BQU0sSUFBSSxHQUFHLGlCQUFpQixDQUFDLENBQUM7U0FDdEQ7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQ3hCLE1BQU0sSUFBSSxLQUFLLENBQUMsS0FBSyxNQUFNLElBQUksR0FBRywyQkFBMkIsQ0FBQyxDQUFDO1NBQ2hFO0lBQ0gsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcmd1bWVudHNDYW1lbENhc2UsIEFyZ3YsIENvbW1hbmRNb2R1bGUgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IGZzcCBmcm9tICdmcy9wcm9taXNlcyc7XG5pbXBvcnQgeyBBbXBsaWZ5UHJvbXB0ZXIsIGZvcm1hdCwgcHJpbnRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5pbXBvcnQge1xuICBTYW5kYm94RnVuY3Rpb25TdHJlYW1pbmdPcHRpb25zLFxuICBTYW5kYm94U2luZ2xldG9uRmFjdG9yeSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3NhbmRib3gnO1xuaW1wb3J0IHtcbiAgQ2xpZW50Q29uZmlnRm9ybWF0LFxuICBDbGllbnRDb25maWdWZXJzaW9uLFxuICBDbGllbnRDb25maWdWZXJzaW9uT3B0aW9uLFxuICBERUZBVUxUX0NMSUVOVF9DT05GSUdfVkVSU0lPTixcbiAgZ2VuZXJhdGVFbXB0eUNsaWVudENvbmZpZ1RvRmlsZSxcbiAgZ2V0Q2xpZW50Q29uZmlnRmlsZU5hbWUsXG4gIGdldENsaWVudENvbmZpZ1BhdGgsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGllbnQtY29uZmlnJztcbmltcG9ydCB7IENsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIgfSBmcm9tICcuLi8uLi9jbGllbnQtY29uZmlnL2NsaWVudF9jb25maWdfbGlmZWN5Y2xlX2hhbmRsZXIuanMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlciB9IGZyb20gJy4uLy4uL2NsaWVudC1jb25maWcvY2xpZW50X2NvbmZpZ19nZW5lcmF0b3JfYWRhcHRlci5qcyc7XG5pbXBvcnQgeyBDb21tYW5kTWlkZGxld2FyZSB9IGZyb20gJy4uLy4uL2NvbW1hbmRfbWlkZGxld2FyZS5qcyc7XG5pbXBvcnQgeyBTYW5kYm94Q29tbWFuZEdsb2JhbE9wdGlvbnMgfSBmcm9tICcuL29wdGlvbl90eXBlcy5qcyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuXG5leHBvcnQgdHlwZSBTYW5kYm94Q29tbWFuZE9wdGlvbnNLZWJhYkNhc2UgPSBBcmd1bWVudHNLZWJhYkNhc2U8XG4gIHtcbiAgICBkaXJUb1dhdGNoOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgZXhjbHVkZTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gICAgb3V0cHV0c0Zvcm1hdDogQ2xpZW50Q29uZmlnRm9ybWF0IHwgdW5kZWZpbmVkO1xuICAgIG91dHB1dHNPdXREaXI6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBvdXRwdXRzVmVyc2lvbjogc3RyaW5nO1xuICAgIG9uY2U6IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG4gICAgc3RyZWFtRnVuY3Rpb25Mb2dzOiBib29sZWFuIHwgdW5kZWZpbmVkO1xuICAgIGxvZ3NGaWx0ZXI6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuICAgIGxvZ3NPdXRGaWxlOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIH0gJiBTYW5kYm94Q29tbWFuZEdsb2JhbE9wdGlvbnNcbj47XG5cbmV4cG9ydCB0eXBlIEV2ZW50SGFuZGxlciA9ICguLi5hcmdzOiB1bmtub3duW10pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hFdmVudEhhbmRsZXJzID0ge1xuICBzdWNjZXNzZnVsRGVwbG95bWVudDogRXZlbnRIYW5kbGVyW107XG4gIHN1Y2Nlc3NmdWxEZWxldGlvbjogRXZlbnRIYW5kbGVyW107XG4gIGZhaWxlZERlcGxveW1lbnQ6IEV2ZW50SGFuZGxlcltdO1xufTtcblxuZXhwb3J0IHR5cGUgU2FuZGJveEV2ZW50SGFuZGxlclBhcmFtcyA9IHtcbiAgc2FuZGJveElkZW50aWZpZXI/OiBzdHJpbmc7XG4gIGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXI6IENsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXI7XG59O1xuXG5leHBvcnQgdHlwZSBTYW5kYm94RXZlbnRIYW5kbGVyQ3JlYXRvciA9IChcbiAgcGFyYW1zOiBTYW5kYm94RXZlbnRIYW5kbGVyUGFyYW1zXG4pID0+IFNhbmRib3hFdmVudEhhbmRsZXJzO1xuXG4vKipcbiAqIENvbW1hbmQgdGhhdCBzdGFydHMgc2FuZGJveC5cbiAqL1xuZXhwb3J0IGNsYXNzIFNhbmRib3hDb21tYW5kXG4gIGltcGxlbWVudHMgQ29tbWFuZE1vZHVsZTxvYmplY3QsIFNhbmRib3hDb21tYW5kT3B0aW9uc0tlYmFiQ2FzZT5cbntcbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBjb21tYW5kOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBkZXNjcmliZTogc3RyaW5nO1xuXG4gIHByaXZhdGUgc2FuZGJveElkZW50aWZpZXI/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgc2FuZGJveCBjb21tYW5kLlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW5kYm94RmFjdG9yeTogU2FuZGJveFNpbmdsZXRvbkZhY3RvcnksXG4gICAgcHJpdmF0ZSByZWFkb25seSBzYW5kYm94U3ViQ29tbWFuZHM6IENvbW1hbmRNb2R1bGVbXSxcbiAgICBwcml2YXRlIGNsaWVudENvbmZpZ0dlbmVyYXRvckFkYXB0ZXI6IENsaWVudENvbmZpZ0dlbmVyYXRvckFkYXB0ZXIsXG4gICAgcHJpdmF0ZSBjb21tYW5kTWlkZGxld2FyZTogQ29tbWFuZE1pZGRsZXdhcmUsXG4gICAgcHJpdmF0ZSByZWFkb25seSBwYWNrYWdlTWFuYWdlckNvbnRyb2xsZXI6IFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlcixcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yPzogU2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3JcbiAgKSB7XG4gICAgdGhpcy5jb21tYW5kID0gJ3NhbmRib3gnO1xuICAgIHRoaXMuZGVzY3JpYmUgPVxuICAgICAgJ1N0YXJ0cyBzYW5kYm94LCB3YXRjaCBtb2RlIGZvciBBbXBsaWZ5IGJhY2tlbmQgZGVwbG95bWVudHMnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBoYW5kbGVyID0gYXN5bmMgKFxuICAgIGFyZ3M6IEFyZ3VtZW50c0NhbWVsQ2FzZTxTYW5kYm94Q29tbWFuZE9wdGlvbnNLZWJhYkNhc2U+XG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHNhbmRib3ggPSBhd2FpdCB0aGlzLnNhbmRib3hGYWN0b3J5LmdldEluc3RhbmNlKCk7XG4gICAgdGhpcy5zYW5kYm94SWRlbnRpZmllciA9IGFyZ3MuaWRlbnRpZmllcjtcblxuICAgIC8vIGF0dGFjaGluZyBldmVudCBoYW5kbGVyc1xuICAgIGNvbnN0IGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIgPSBuZXcgQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcihcbiAgICAgIHRoaXMuY2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICAgIGFyZ3Mub3V0cHV0c1ZlcnNpb24gYXMgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgICAgIGFyZ3Mub3V0cHV0c091dERpcixcbiAgICAgIGFyZ3Mub3V0cHV0c0Zvcm1hdFxuICAgICk7XG4gICAgY29uc3QgZXZlbnRIYW5kbGVycyA9IHRoaXMuc2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3I/Lih7XG4gICAgICBzYW5kYm94SWRlbnRpZmllcjogdGhpcy5zYW5kYm94SWRlbnRpZmllcixcbiAgICAgIGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIsXG4gICAgfSk7XG4gICAgaWYgKGV2ZW50SGFuZGxlcnMpIHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKGV2ZW50SGFuZGxlcnMpLmZvckVhY2goKFtldmVudCwgaGFuZGxlcnNdKSA9PiB7XG4gICAgICAgIGhhbmRsZXJzLmZvckVhY2goKGhhbmRsZXIpID0+IHNhbmRib3gub24oZXZlbnQsIGhhbmRsZXIpKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBjb25zdCB3YXRjaEV4Y2x1c2lvbnMgPSBhcmdzLmV4Y2x1ZGUgPz8gW107XG4gICAgY29uc3QgZmlsZU5hbWUgPSBnZXRDbGllbnRDb25maWdGaWxlTmFtZShcbiAgICAgIGFyZ3Mub3V0cHV0c1ZlcnNpb24gYXMgQ2xpZW50Q29uZmlnVmVyc2lvblxuICAgICk7XG4gICAgY29uc3QgY2xpZW50Q29uZmlnV3JpdGVQYXRoID0gYXdhaXQgZ2V0Q2xpZW50Q29uZmlnUGF0aChcbiAgICAgIGZpbGVOYW1lLFxuICAgICAgYXJncy5vdXRwdXRzT3V0RGlyLFxuICAgICAgYXJncy5vdXRwdXRzRm9ybWF0XG4gICAgKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhjbGllbnRDb25maWdXcml0ZVBhdGgpKSB7XG4gICAgICBhd2FpdCBnZW5lcmF0ZUVtcHR5Q2xpZW50Q29uZmlnVG9GaWxlKFxuICAgICAgICBhcmdzLm91dHB1dHNWZXJzaW9uIGFzIENsaWVudENvbmZpZ1ZlcnNpb24sXG4gICAgICAgIGFyZ3Mub3V0cHV0c091dERpcixcbiAgICAgICAgYXJncy5vdXRwdXRzRm9ybWF0XG4gICAgICApO1xuICAgIH1cblxuICAgIHdhdGNoRXhjbHVzaW9ucy5wdXNoKGNsaWVudENvbmZpZ1dyaXRlUGF0aCk7XG5cbiAgICBsZXQgZnVuY3Rpb25TdHJlYW1pbmdPcHRpb25zOiBTYW5kYm94RnVuY3Rpb25TdHJlYW1pbmdPcHRpb25zID0ge1xuICAgICAgZW5hYmxlZDogZmFsc2UsXG4gICAgfTtcbiAgICBpZiAoYXJncy5zdHJlYW1GdW5jdGlvbkxvZ3MpIHtcbiAgICAgIC8vIHR1cm4gb24gZnVuY3Rpb24gbG9ncyBzdHJlYW1pbmdcbiAgICAgIGZ1bmN0aW9uU3RyZWFtaW5nT3B0aW9ucyA9IHtcbiAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgbG9nc0ZpbHRlcnM6IGFyZ3MubG9nc0ZpbHRlcixcbiAgICAgICAgbG9nc091dEZpbGU6IGFyZ3MubG9nc091dEZpbGUsXG4gICAgICB9O1xuXG4gICAgICBpZiAoYXJncy5sb2dzT3V0RmlsZSkge1xuICAgICAgICB3YXRjaEV4Y2x1c2lvbnMucHVzaChhcmdzLmxvZ3NPdXRGaWxlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgc2FuZGJveC5zdGFydCh7XG4gICAgICBkaXI6IGFyZ3MuZGlyVG9XYXRjaCxcbiAgICAgIGV4Y2x1ZGU6IHdhdGNoRXhjbHVzaW9ucyxcbiAgICAgIGlkZW50aWZpZXI6IGFyZ3MuaWRlbnRpZmllcixcbiAgICAgIHByb2ZpbGU6IGFyZ3MucHJvZmlsZSxcbiAgICAgIHdhdGNoRm9yQ2hhbmdlczogIWFyZ3Mub25jZSxcbiAgICAgIGZ1bmN0aW9uU3RyZWFtaW5nT3B0aW9ucyxcbiAgICB9KTtcbiAgICBwcm9jZXNzLm9uY2UoJ1NJR0lOVCcsICgpID0+IHZvaWQgdGhpcy5zaWdJbnRIYW5kbGVyKCkpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8U2FuZGJveENvbW1hbmRPcHRpb25zS2ViYWJDYXNlPiA9PiB7XG4gICAgcmV0dXJuIChcbiAgICAgIHlhcmdzXG4gICAgICAgIC8vIENhc3QgdG8gZXJhc2Ugb3B0aW9ucyB0eXBlcyB1c2VkIGluIGludGVybmFsIHN1YiBjb21tYW5kIGltcGxlbWVudGF0aW9uLiBPdGhlcndpc2UsIGNvbXBpbGVyIGZhaWxzIGhlcmUuXG4gICAgICAgIC5jb21tYW5kKHRoaXMuc2FuZGJveFN1YkNvbW1hbmRzKVxuICAgICAgICAudmVyc2lvbihmYWxzZSlcbiAgICAgICAgLm9wdGlvbignZGlyLXRvLXdhdGNoJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0RpcmVjdG9yeSB0byB3YXRjaCBmb3IgZmlsZSBjaGFuZ2VzLiBBbGwgc3ViZGlyZWN0b3JpZXMgYW5kIGZpbGVzIHdpbGwgYmUgaW5jbHVkZWQuIERlZmF1bHRzIHRvIHRoZSBhbXBsaWZ5IGRpcmVjdG9yeS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdleGNsdWRlJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0FuIGFycmF5IG9mIHBhdGhzIG9yIGdsb2IgcGF0dGVybnMgdG8gaWdub3JlLiBQYXRocyBjYW4gYmUgcmVsYXRpdmUgb3IgYWJzb2x1dGUgYW5kIGNhbiBlaXRoZXIgYmUgZmlsZXMgb3IgZGlyZWN0b3JpZXMnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiB0cnVlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2lkZW50aWZpZXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnQW4gb3B0aW9uYWwgaWRlbnRpZmllciB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIGRpZmZlcmVudCBzYW5kYm94ZXMuIERlZmF1bHQgaXMgdGhlIG5hbWUgb2YgdGhlIHN5c3RlbSB1c2VyIGV4ZWN1dGluZyB0aGUgcHJvY2VzcycsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdvdXRwdXRzLWZvcm1hdCcsIHtcbiAgICAgICAgICBkZXNjcmliZTogJ2FtcGxpZnlfb3V0cHV0cyBmaWxlIGZvcm1hdCcsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICAgIGNob2ljZXM6IE9iamVjdC52YWx1ZXMoQ2xpZW50Q29uZmlnRm9ybWF0KSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdvdXRwdXRzLXZlcnNpb24nLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnVmVyc2lvbiBvZiB0aGUgY29uZmlndXJhdGlvbi4gVmVyc2lvbiAwIHJlcHJlc2VudHMgY2xhc3NpYyBhbXBsaWZ5LWNsaSBjb25maWcgZmlsZSBhbXBsaWZ5LWNvbmZpZ3VyYXRpb24gYW5kIDEgcmVwcmVzZW50cyBuZXdlciBjb25maWcgZmlsZSBhbXBsaWZ5X291dHB1dHMnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBjaG9pY2VzOiBPYmplY3QudmFsdWVzKENsaWVudENvbmZpZ1ZlcnNpb25PcHRpb24pLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgICAgZGVmYXVsdDogREVGQVVMVF9DTElFTlRfQ09ORklHX1ZFUlNJT04sXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ291dHB1dHMtb3V0LWRpcicsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdBIHBhdGggdG8gZGlyZWN0b3J5IHdoZXJlIGFtcGxpZnlfb3V0cHV0cyBpcyB3cml0dGVuLiBJZiBub3QgcHJvdmlkZWQgZGVmYXVsdHMgdG8gY3VycmVudCBwcm9jZXNzIHdvcmtpbmcgZGlyZWN0b3J5LicsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ3Byb2ZpbGUnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6ICdBbiBBV1MgcHJvZmlsZSBuYW1lLicsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdvbmNlJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0V4ZWN1dGUgYSBzaW5nbGUgc2FuZGJveCBkZXBsb3ltZW50IHdpdGhvdXQgd2F0Y2hpbmcgZm9yIGZ1dHVyZSBmaWxlIGNoYW5nZXMnLFxuICAgICAgICAgIGJvb2xlYW46IHRydWUsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignc3RyZWFtLWZ1bmN0aW9uLWxvZ3MnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnV2hldGhlciB0byBzdHJlYW0gZnVuY3Rpb24gZXhlY3V0aW9uIGxvZ3MuIERlZmF1bHQ6IGZhbHNlLiBVc2UgLS1sb2dzLWZpbHRlciBpbiBhZGRpdGlvbiB0byB0aGlzIGZsYWcgdG8gc3RyZWFtIHNwZWNpZmljIGZ1bmN0aW9uIGxvZ3MnLFxuICAgICAgICAgIGJvb2xlYW46IHRydWUsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgICBncm91cDogJ0xvZ3Mgc3RyZWFtaW5nJyxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignbG9ncy1maWx0ZXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6IGBSZWdleCBwYXR0ZXJuIHRvIGZpbHRlciBsb2dzIGZyb20gb25seSBtYXRjaGVkIGZ1bmN0aW9ucy4gRS5nLiB0byBzdHJlYW0gbG9ncyBmb3IgYSBmdW5jdGlvbiwgc3BlY2lmeSBpdCdzIG5hbWUsIGFuZCB0byBzdHJlYW0gbG9ncyBmcm9tIGFsbCBmdW5jdGlvbnMgc3RhcnRpbmcgd2l0aCBhdXRoIHNwZWNpZnkgJ2F1dGgnIERlZmF1bHQ6IFN0cmVhbSBhbGwgbG9nc2AsXG4gICAgICAgICAgYXJyYXk6IHRydWUsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgZ3JvdXA6ICdMb2dzIHN0cmVhbWluZycsXG4gICAgICAgICAgaW1wbGllczogWydzdHJlYW0tZnVuY3Rpb24tbG9ncyddLFxuICAgICAgICAgIHJlcXVpcmVzQXJnOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdsb2dzLW91dC1maWxlJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0ZpbGUgdG8gYXBwZW5kIHRoZSBzdHJlYW1pbmcgbG9ncy4gVGhlIGZpbGUgaXMgY3JlYXRlZCBpZiBpdCBkb2VzIG5vdCBleGlzdC4gRGVmYXVsdDogc3Rkb3V0JyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgZ3JvdXA6ICdMb2dzIHN0cmVhbWluZycsXG4gICAgICAgICAgaW1wbGllczogWydzdHJlYW0tZnVuY3Rpb24tbG9ncyddLFxuICAgICAgICAgIHJlcXVpcmVzQXJnOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgICAuY2hlY2soYXN5bmMgKGFyZ3YpID0+IHtcbiAgICAgICAgICBpZiAoYXJndlsnZGlyLXRvLXdhdGNoJ10pIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMudmFsaWRhdGVEaXJlY3RvcnkoJ2Rpci10by13YXRjaCcsIGFyZ3ZbJ2Rpci10by13YXRjaCddKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGFyZ3YuaWRlbnRpZmllcikge1xuICAgICAgICAgICAgY29uc3QgaWRlbnRpZmllclJlZ2V4ID0gL15bYS16QS1aMC05LV17MSwxNX0kLztcbiAgICAgICAgICAgIGlmICghYXJndi5pZGVudGlmaWVyLm1hdGNoKGlkZW50aWZpZXJSZWdleCkpIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIGAtLWlkZW50aWZpZXIgc2hvdWxkIG1hdGNoIFthLXpBLVowLTktXSBhbmQgYmUgbGVzcyB0aGFuIDE1IGNoYXJhY3RlcnMuYFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNvbmZsaWN0cygnb25jZScsIFtcbiAgICAgICAgICAnZXhjbHVkZScsXG4gICAgICAgICAgJ2Rpci10by13YXRjaCcsXG4gICAgICAgICAgJ3N0cmVhbS1mdW5jdGlvbi1sb2dzJyxcbiAgICAgICAgICAnbG9ncy1maWx0ZXInLFxuICAgICAgICAgICdsb2dzLW91dC1maWxlJyxcbiAgICAgICAgXSlcbiAgICAgICAgLm1pZGRsZXdhcmUoW3RoaXMuY29tbWFuZE1pZGRsZXdhcmUuZW5zdXJlQXdzQ3JlZGVudGlhbEFuZFJlZ2lvbl0pXG4gICAgKTtcbiAgfTtcblxuICBzaWdJbnRIYW5kbGVyID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmICghdGhpcy5wYWNrYWdlTWFuYWdlckNvbnRyb2xsZXIuYWxsb3dzU2lnbmFsUHJvcGFnYXRpb24oKSkge1xuICAgICAgcHJpbnRlci5wcmludChcbiAgICAgICAgYFN0b3BwaW5nIHRoZSBzYW5kYm94IHByb2Nlc3MuIFRvIGRlbGV0ZSB0aGUgc2FuZGJveCwgcnVuICR7Zm9ybWF0Lm5vcm1hbGl6ZUFtcHhDb21tYW5kKFxuICAgICAgICAgICdzYW5kYm94IGRlbGV0ZSdcbiAgICAgICAgKX1gXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBhbnN3ZXIgPSBhd2FpdCBBbXBsaWZ5UHJvbXB0ZXIueWVzT3JObyh7XG4gICAgICBtZXNzYWdlOlxuICAgICAgICAnV291bGQgeW91IGxpa2UgdG8gZGVsZXRlIGFsbCB0aGUgcmVzb3VyY2VzIGluIHlvdXIgc2FuZGJveCBlbnZpcm9ubWVudCAoVGhpcyBjYW5ub3QgYmUgdW5kb25lKT8nLFxuICAgICAgZGVmYXVsdFZhbHVlOiBmYWxzZSxcbiAgICB9KTtcbiAgICBpZiAoYW5zd2VyKVxuICAgICAgYXdhaXQgKFxuICAgICAgICBhd2FpdCB0aGlzLnNhbmRib3hGYWN0b3J5LmdldEluc3RhbmNlKClcbiAgICAgICkuZGVsZXRlKHsgaWRlbnRpZmllcjogdGhpcy5zYW5kYm94SWRlbnRpZmllciB9KTtcbiAgfTtcblxuICBwcml2YXRlIHZhbGlkYXRlRGlyZWN0b3J5ID0gYXN5bmMgKG9wdGlvbjogc3RyaW5nLCBkaXI6IHN0cmluZykgPT4ge1xuICAgIGxldCBzdGF0cztcbiAgICB0cnkge1xuICAgICAgc3RhdHMgPSBhd2FpdCBmc3Auc3RhdChkaXIsIHt9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYC0tJHtvcHRpb259ICR7ZGlyfSBkb2VzIG5vdCBleGlzdGApO1xuICAgIH1cbiAgICBpZiAoIXN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgLS0ke29wdGlvbn0gJHtkaXJ9IGlzIG5vdCBhIHZhbGlkIGRpcmVjdG9yeWApO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==