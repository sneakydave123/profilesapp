import { BackendOutputClientFactory, } from '@aws-amplify/deployed-backend-client';
import { graphqlOutputKey } from '@aws-amplify/backend-output-schemas';
import { AppsyncGraphqlGenerationResult } from './appsync_graphql_generation_result.js';
import { StackMetadataGraphqlModelsGenerator } from './graphql_models_generator.js';
import { S3StringObjectFetcher } from './s3_string_object_fetcher.js';
import { getBackendOutputWithErrorHandling } from './get_backend_output_with_error_handling.js';
/**
 * Factory function to compose a model generator.
 */
export const createGraphqlModelsGenerator = (params) => {
    if ('backendIdentifier' in params) {
        return createGraphqlModelsGeneratorFromBackendIdentifier(params);
    }
    return createGraphqlModelsFromS3UriGenerator(params);
};
/**
 * Factory function to compose a model generator from a backend identifier.
 */
const createGraphqlModelsGeneratorFromBackendIdentifier = ({ backendIdentifier, awsClientProvider, }) => {
    if (!backendIdentifier) {
        throw new Error('`backendIdentifier` must be defined');
    }
    if (!awsClientProvider) {
        throw new Error('`awsClientProvider` must be defined');
    }
    return new StackMetadataGraphqlModelsGenerator(() => getModelSchema(backendIdentifier, awsClientProvider), (fileMap) => new AppsyncGraphqlGenerationResult(fileMap));
};
/**
 * Factory function to compose a model generator from an s3 uri.
 */
export const createGraphqlModelsFromS3UriGenerator = ({ modelSchemaS3Uri, awsClientProvider, }) => {
    if (!modelSchemaS3Uri) {
        throw new Error('`modelSchemaS3Uri` must be defined');
    }
    if (!awsClientProvider) {
        throw new Error('`awsClientProvider` must be defined');
    }
    return new StackMetadataGraphqlModelsGenerator(() => getModelSchemaFromS3Uri(modelSchemaS3Uri, awsClientProvider), (fileMap) => new AppsyncGraphqlGenerationResult(fileMap));
};
const getModelSchema = async (backendIdentifier, awsClientProvider) => {
    const backendOutputClient = BackendOutputClientFactory.getInstance(awsClientProvider);
    const output = await getBackendOutputWithErrorHandling(backendOutputClient, backendIdentifier);
    const modelSchemaS3Uri = output[graphqlOutputKey]?.payload.amplifyApiModelSchemaS3Uri;
    if (!modelSchemaS3Uri) {
        throw new Error(`Cannot find model schema at amplifyApiModelSchemaS3Uri`);
    }
    return await getModelSchemaFromS3Uri(modelSchemaS3Uri, awsClientProvider);
};
const getModelSchemaFromS3Uri = async (modelSchemaS3Uri, awsClientProvider) => {
    const schemaFetcher = new S3StringObjectFetcher(awsClientProvider.getS3Client());
    return await schemaFetcher.fetch(modelSchemaS3Uri);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlX2dyYXBocWxfbW9kZWxzX2dlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9jcmVhdGVfZ3JhcGhxbF9tb2RlbHNfZ2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCwwQkFBMEIsR0FFM0IsTUFBTSxzQ0FBc0MsQ0FBQztBQUU5QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN2RSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUN4RixPQUFPLEVBQUUsbUNBQW1DLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUVwRixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUt0RSxPQUFPLEVBQUUsaUNBQWlDLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQW9CaEc7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSw0QkFBNEIsR0FBRyxDQUMxQyxNQUEyQyxFQUNuQixFQUFFO0lBQzFCLElBQUksbUJBQW1CLElBQUksTUFBTSxFQUFFO1FBQ2pDLE9BQU8saURBQWlELENBQUMsTUFBTSxDQUFDLENBQUM7S0FDbEU7SUFDRCxPQUFPLHFDQUFxQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3ZELENBQUMsQ0FBQztBQVdGOztHQUVHO0FBQ0gsTUFBTSxpREFBaUQsR0FBRyxDQUFDLEVBQ3pELGlCQUFpQixFQUNqQixpQkFBaUIsR0FDd0IsRUFBMEIsRUFBRTtJQUNyRSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7UUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO0tBQ3hEO0lBQ0QsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztLQUN4RDtJQUVELE9BQU8sSUFBSSxtQ0FBbUMsQ0FDNUMsR0FBRyxFQUFFLENBQUMsY0FBYyxDQUFDLGlCQUFpQixFQUFFLGlCQUFpQixDQUFDLEVBQzFELENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxJQUFJLDhCQUE4QixDQUFDLE9BQU8sQ0FBQyxDQUN6RCxDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBV0Y7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxxQ0FBcUMsR0FBRyxDQUFDLEVBQ3BELGdCQUFnQixFQUNoQixpQkFBaUIsR0FDNEIsRUFBMEIsRUFBRTtJQUN6RSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7UUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztLQUN4RDtJQUNELE9BQU8sSUFBSSxtQ0FBbUMsQ0FDNUMsR0FBRyxFQUFFLENBQUMsdUJBQXVCLENBQUMsZ0JBQWdCLEVBQUUsaUJBQWlCLENBQUMsRUFDbEUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksOEJBQThCLENBQUMsT0FBTyxDQUFDLENBQ3pELENBQUM7QUFDSixDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxLQUFLLEVBQzFCLGlCQUE0QyxFQUM1QyxpQkFJRSxFQUNlLEVBQUU7SUFDbkIsTUFBTSxtQkFBbUIsR0FDdkIsMEJBQTBCLENBQUMsV0FBVyxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDNUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxpQ0FBaUMsQ0FDcEQsbUJBQW1CLEVBQ25CLGlCQUFpQixDQUNsQixDQUFDO0lBQ0YsTUFBTSxnQkFBZ0IsR0FDcEIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsT0FBTyxDQUFDLDBCQUEwQixDQUFDO0lBQy9ELElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtRQUNyQixNQUFNLElBQUksS0FBSyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7S0FDM0U7SUFFRCxPQUFPLE1BQU0sdUJBQXVCLENBQUMsZ0JBQWdCLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztBQUM1RSxDQUFDLENBQUM7QUFFRixNQUFNLHVCQUF1QixHQUFHLEtBQUssRUFDbkMsZ0JBQXdCLEVBQ3hCLGlCQUVFLEVBQ2UsRUFBRTtJQUNuQixNQUFNLGFBQWEsR0FBRyxJQUFJLHFCQUFxQixDQUM3QyxpQkFBaUIsQ0FBQyxXQUFXLEVBQUUsQ0FDaEMsQ0FBQztJQUNGLE9BQU8sTUFBTSxhQUFhLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDckQsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dENsaWVudEZhY3RvcnksXG4gIERlcGxveWVkQmFja2VuZElkZW50aWZpZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9kZXBsb3llZC1iYWNrZW5kLWNsaWVudCc7XG5cbmltcG9ydCB7IGdyYXBocWxPdXRwdXRLZXkgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQgeyBBcHBzeW5jR3JhcGhxbEdlbmVyYXRpb25SZXN1bHQgfSBmcm9tICcuL2FwcHN5bmNfZ3JhcGhxbF9nZW5lcmF0aW9uX3Jlc3VsdC5qcyc7XG5pbXBvcnQgeyBTdGFja01ldGFkYXRhR3JhcGhxbE1vZGVsc0dlbmVyYXRvciB9IGZyb20gJy4vZ3JhcGhxbF9tb2RlbHNfZ2VuZXJhdG9yLmpzJztcbmltcG9ydCB7IEdyYXBocWxNb2RlbHNHZW5lcmF0b3IgfSBmcm9tICcuL21vZGVsX2dlbmVyYXRvci5qcyc7XG5pbXBvcnQgeyBTM1N0cmluZ09iamVjdEZldGNoZXIgfSBmcm9tICcuL3MzX3N0cmluZ19vYmplY3RfZmV0Y2hlci5qcyc7XG5pbXBvcnQgeyBBV1NDbGllbnRQcm92aWRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHsgUzNDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgQW1wbGlmeUNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1hbXBsaWZ5JztcbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7IGdldEJhY2tlbmRPdXRwdXRXaXRoRXJyb3JIYW5kbGluZyB9IGZyb20gJy4vZ2V0X2JhY2tlbmRfb3V0cHV0X3dpdGhfZXJyb3JfaGFuZGxpbmcuanMnO1xuXG5leHBvcnQgdHlwZSBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRmFjdG9yeVBhcmFtcyA9XG4gIHwge1xuICAgICAgYmFja2VuZElkZW50aWZpZXI6IERlcGxveWVkQmFja2VuZElkZW50aWZpZXI7XG4gICAgICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgICAgICBnZXRTM0NsaWVudDogUzNDbGllbnQ7XG4gICAgICAgIGdldEFtcGxpZnlDbGllbnQ6IEFtcGxpZnlDbGllbnQ7XG4gICAgICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgICAgIH0+O1xuICAgIH1cbiAgfCB7XG4gICAgICBtb2RlbFNjaGVtYVMzVXJpOiBzdHJpbmc7XG4gICAgICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgICAgICBnZXRTM0NsaWVudDogUzNDbGllbnQ7XG4gICAgICAgIGdldEFtcGxpZnlDbGllbnQ6IEFtcGxpZnlDbGllbnQ7XG4gICAgICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgICAgIH0+O1xuICAgIH07XG5cbi8qKlxuICogRmFjdG9yeSBmdW5jdGlvbiB0byBjb21wb3NlIGEgbW9kZWwgZ2VuZXJhdG9yLlxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlR3JhcGhxbE1vZGVsc0dlbmVyYXRvciA9IChcbiAgcGFyYW1zOiBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRmFjdG9yeVBhcmFtc1xuKTogR3JhcGhxbE1vZGVsc0dlbmVyYXRvciA9PiB7XG4gIGlmICgnYmFja2VuZElkZW50aWZpZXInIGluIHBhcmFtcykge1xuICAgIHJldHVybiBjcmVhdGVHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRnJvbUJhY2tlbmRJZGVudGlmaWVyKHBhcmFtcyk7XG4gIH1cbiAgcmV0dXJuIGNyZWF0ZUdyYXBocWxNb2RlbHNGcm9tUzNVcmlHZW5lcmF0b3IocGFyYW1zKTtcbn07XG5cbmV4cG9ydCB0eXBlIEdyYXBocWxNb2RlbHNGcm9tQmFja2VuZElkZW50aWZpZXJQYXJhbXMgPSB7XG4gIGJhY2tlbmRJZGVudGlmaWVyOiBEZXBsb3llZEJhY2tlbmRJZGVudGlmaWVyO1xuICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgIGdldFMzQ2xpZW50OiBTM0NsaWVudDtcbiAgICBnZXRBbXBsaWZ5Q2xpZW50OiBBbXBsaWZ5Q2xpZW50O1xuICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgfT47XG59O1xuXG4vKipcbiAqIEZhY3RvcnkgZnVuY3Rpb24gdG8gY29tcG9zZSBhIG1vZGVsIGdlbmVyYXRvciBmcm9tIGEgYmFja2VuZCBpZGVudGlmaWVyLlxuICovXG5jb25zdCBjcmVhdGVHcmFwaHFsTW9kZWxzR2VuZXJhdG9yRnJvbUJhY2tlbmRJZGVudGlmaWVyID0gKHtcbiAgYmFja2VuZElkZW50aWZpZXIsXG4gIGF3c0NsaWVudFByb3ZpZGVyLFxufTogR3JhcGhxbE1vZGVsc0Zyb21CYWNrZW5kSWRlbnRpZmllclBhcmFtcyk6IEdyYXBocWxNb2RlbHNHZW5lcmF0b3IgPT4ge1xuICBpZiAoIWJhY2tlbmRJZGVudGlmaWVyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdgYmFja2VuZElkZW50aWZpZXJgIG11c3QgYmUgZGVmaW5lZCcpO1xuICB9XG4gIGlmICghYXdzQ2xpZW50UHJvdmlkZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2Bhd3NDbGllbnRQcm92aWRlcmAgbXVzdCBiZSBkZWZpbmVkJyk7XG4gIH1cblxuICByZXR1cm4gbmV3IFN0YWNrTWV0YWRhdGFHcmFwaHFsTW9kZWxzR2VuZXJhdG9yKFxuICAgICgpID0+IGdldE1vZGVsU2NoZW1hKGJhY2tlbmRJZGVudGlmaWVyLCBhd3NDbGllbnRQcm92aWRlciksXG4gICAgKGZpbGVNYXApID0+IG5ldyBBcHBzeW5jR3JhcGhxbEdlbmVyYXRpb25SZXN1bHQoZmlsZU1hcClcbiAgKTtcbn07XG5cbmV4cG9ydCB0eXBlIEdyYXBocWxNb2RlbHNGcm9tUzNVcmlHZW5lcmF0b3JGYWN0b3J5UGFyYW1zID0ge1xuICBtb2RlbFNjaGVtYVMzVXJpOiBzdHJpbmc7XG4gIGF3c0NsaWVudFByb3ZpZGVyOiBBV1NDbGllbnRQcm92aWRlcjx7XG4gICAgZ2V0UzNDbGllbnQ6IFMzQ2xpZW50O1xuICAgIGdldEFtcGxpZnlDbGllbnQ6IEFtcGxpZnlDbGllbnQ7XG4gICAgZ2V0Q2xvdWRGb3JtYXRpb25DbGllbnQ6IENsb3VkRm9ybWF0aW9uQ2xpZW50O1xuICB9Pjtcbn07XG5cbi8qKlxuICogRmFjdG9yeSBmdW5jdGlvbiB0byBjb21wb3NlIGEgbW9kZWwgZ2VuZXJhdG9yIGZyb20gYW4gczMgdXJpLlxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlR3JhcGhxbE1vZGVsc0Zyb21TM1VyaUdlbmVyYXRvciA9ICh7XG4gIG1vZGVsU2NoZW1hUzNVcmksXG4gIGF3c0NsaWVudFByb3ZpZGVyLFxufTogR3JhcGhxbE1vZGVsc0Zyb21TM1VyaUdlbmVyYXRvckZhY3RvcnlQYXJhbXMpOiBHcmFwaHFsTW9kZWxzR2VuZXJhdG9yID0+IHtcbiAgaWYgKCFtb2RlbFNjaGVtYVMzVXJpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdgbW9kZWxTY2hlbWFTM1VyaWAgbXVzdCBiZSBkZWZpbmVkJyk7XG4gIH1cbiAgaWYgKCFhd3NDbGllbnRQcm92aWRlcikge1xuICAgIHRocm93IG5ldyBFcnJvcignYGF3c0NsaWVudFByb3ZpZGVyYCBtdXN0IGJlIGRlZmluZWQnKTtcbiAgfVxuICByZXR1cm4gbmV3IFN0YWNrTWV0YWRhdGFHcmFwaHFsTW9kZWxzR2VuZXJhdG9yKFxuICAgICgpID0+IGdldE1vZGVsU2NoZW1hRnJvbVMzVXJpKG1vZGVsU2NoZW1hUzNVcmksIGF3c0NsaWVudFByb3ZpZGVyKSxcbiAgICAoZmlsZU1hcCkgPT4gbmV3IEFwcHN5bmNHcmFwaHFsR2VuZXJhdGlvblJlc3VsdChmaWxlTWFwKVxuICApO1xufTtcblxuY29uc3QgZ2V0TW9kZWxTY2hlbWEgPSBhc3luYyAoXG4gIGJhY2tlbmRJZGVudGlmaWVyOiBEZXBsb3llZEJhY2tlbmRJZGVudGlmaWVyLFxuICBhd3NDbGllbnRQcm92aWRlcjogQVdTQ2xpZW50UHJvdmlkZXI8e1xuICAgIGdldFMzQ2xpZW50OiBTM0NsaWVudDtcbiAgICBnZXRBbXBsaWZ5Q2xpZW50OiBBbXBsaWZ5Q2xpZW50O1xuICAgIGdldENsb3VkRm9ybWF0aW9uQ2xpZW50OiBDbG91ZEZvcm1hdGlvbkNsaWVudDtcbiAgfT5cbik6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gIGNvbnN0IGJhY2tlbmRPdXRwdXRDbGllbnQgPVxuICAgIEJhY2tlbmRPdXRwdXRDbGllbnRGYWN0b3J5LmdldEluc3RhbmNlKGF3c0NsaWVudFByb3ZpZGVyKTtcbiAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgZ2V0QmFja2VuZE91dHB1dFdpdGhFcnJvckhhbmRsaW5nKFxuICAgIGJhY2tlbmRPdXRwdXRDbGllbnQsXG4gICAgYmFja2VuZElkZW50aWZpZXJcbiAgKTtcbiAgY29uc3QgbW9kZWxTY2hlbWFTM1VyaSA9XG4gICAgb3V0cHV0W2dyYXBocWxPdXRwdXRLZXldPy5wYXlsb2FkLmFtcGxpZnlBcGlNb2RlbFNjaGVtYVMzVXJpO1xuICBpZiAoIW1vZGVsU2NoZW1hUzNVcmkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kIG1vZGVsIHNjaGVtYSBhdCBhbXBsaWZ5QXBpTW9kZWxTY2hlbWFTM1VyaWApO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IGdldE1vZGVsU2NoZW1hRnJvbVMzVXJpKG1vZGVsU2NoZW1hUzNVcmksIGF3c0NsaWVudFByb3ZpZGVyKTtcbn07XG5cbmNvbnN0IGdldE1vZGVsU2NoZW1hRnJvbVMzVXJpID0gYXN5bmMgKFxuICBtb2RlbFNjaGVtYVMzVXJpOiBzdHJpbmcsXG4gIGF3c0NsaWVudFByb3ZpZGVyOiBBV1NDbGllbnRQcm92aWRlcjx7XG4gICAgZ2V0UzNDbGllbnQ6IFMzQ2xpZW50O1xuICB9PlxuKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgY29uc3Qgc2NoZW1hRmV0Y2hlciA9IG5ldyBTM1N0cmluZ09iamVjdEZldGNoZXIoXG4gICAgYXdzQ2xpZW50UHJvdmlkZXIuZ2V0UzNDbGllbnQoKVxuICApO1xuICByZXR1cm4gYXdhaXQgc2NoZW1hRmV0Y2hlci5mZXRjaChtb2RlbFNjaGVtYVMzVXJpKTtcbn07XG4iXX0=