import { CloudFormationServiceException, DescribeStacksCommand, GetTemplateSummaryCommand, } from '@aws-sdk/client-cloudformation';
import { backendOutputStackMetadataSchema } from '@aws-amplify/backend-output-schemas';
import { BackendOutputClientError, BackendOutputClientErrorType, } from './index.js';
/**
 * Gets Amplify backend outputs from stack metadata and outputs
 */
export class StackMetadataBackendOutputRetrievalStrategy {
    cfnClient;
    stackNameResolver;
    /**
     * Instantiate with a CloudFormationClient and a StackNameResolver
     */
    constructor(cfnClient, stackNameResolver) {
        this.cfnClient = cfnClient;
        this.stackNameResolver = stackNameResolver;
    }
    /**
     * Resolves the stackName, then queries CFN for the stack metadata and outputs
     *
     * It combines the metadata and outputs to reconstruct the data object that was provided by the Amplify constructs when writing the output.
     * Except now the data contains the resolved values of the deployed resources rather than CFN references
     */
    fetchBackendOutput = async () => {
        const stackName = await this.stackNameResolver.resolveMainStackName();
        let metadataObject;
        try {
            // GetTemplateSummary includes the template metadata as a string
            const templateSummary = await this.cfnClient.send(new GetTemplateSummaryCommand({ StackName: stackName }));
            if (typeof templateSummary.Metadata !== 'string') {
                throw new BackendOutputClientError(BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR, 'Stack template metadata is not a string');
            }
            metadataObject = JSON.parse(templateSummary.Metadata);
        }
        catch (error) {
            if (error instanceof CloudFormationServiceException &&
                error.message.startsWith('Stack with id') &&
                error.message.endsWith('does not exist')) {
                throw new BackendOutputClientError(BackendOutputClientErrorType.NO_STACK_FOUND, `Stack with id ${stackName} does not exist`);
            }
            throw error;
        }
        // parse and validate the metadata object
        const backendOutputMetadata = backendOutputStackMetadataSchema.parse(metadataObject);
        // DescribeStacks includes the template output
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const outputs = stackDescription?.Stacks?.[0]?.Outputs;
        if (stackDescription.Stacks?.[0].StackStatus?.endsWith('_IN_PROGRESS')) {
            const deploymentType = stackDescription.Stacks?.[0].Tags?.find((tag) => tag.Key === 'amplify:deployment-type')?.Value ?? 'sandbox';
            throw new BackendOutputClientError(BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS, `This ${deploymentType} deployment is in progress. Re-run this command once the deployment completes.`);
        }
        if (outputs === undefined) {
            throw new BackendOutputClientError(BackendOutputClientErrorType.NO_OUTPUTS_FOUND, 'Stack outputs are undefined');
        }
        // outputs is a list of output entries. here we turn that into a Record<name, value> object
        const stackOutputRecord = outputs
            .filter((output) => !!output.OutputValue && !!output.OutputKey)
            .reduce((accumulator, outputEntry) => ({
            ...accumulator,
            // it's safe to disable this rule because we've already filtered out potentially undefined outputs
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            [outputEntry.OutputKey]: outputEntry.OutputValue,
        }), {});
        // now we iterate over the metadata entries and reconstruct the data object based on the stackOutputs that each construct package set
        const result = {};
        Object.entries(backendOutputMetadata).forEach(([outputKeyName, entry]) => {
            const outputData = entry.stackOutputs.reduce((accumulator, outputName) => {
                if (stackOutputRecord[outputName] === undefined ||
                    stackOutputRecord[outputName] === '') {
                    return accumulator;
                }
                return {
                    ...accumulator,
                    [outputName]: stackOutputRecord[outputName],
                };
            }, {});
            result[outputKeyName] = {
                version: entry.version,
                payload: outputData,
            };
        });
        return result;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfbWV0YWRhdGFfb3V0cHV0X3JldHJpZXZhbF9zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdGFja19tZXRhZGF0YV9vdXRwdXRfcmV0cmlldmFsX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCw4QkFBOEIsRUFDOUIscUJBQXFCLEVBQ3JCLHlCQUF5QixHQUMxQixNQUFNLGdDQUFnQyxDQUFDO0FBTXhDLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3ZGLE9BQU8sRUFDTCx3QkFBd0IsRUFDeEIsNEJBQTRCLEdBQzdCLE1BQU0sWUFBWSxDQUFDO0FBRXBCOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJDQUEyQztJQU9uQztJQUNBO0lBTG5COztPQUVHO0lBQ0gsWUFDbUIsU0FBK0IsRUFDL0IsaUJBQXdDO1FBRHhDLGNBQVMsR0FBVCxTQUFTLENBQXNCO1FBQy9CLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBdUI7SUFDeEQsQ0FBQztJQUVKOzs7OztPQUtHO0lBQ0gsa0JBQWtCLEdBQUcsS0FBSyxJQUE0QixFQUFFO1FBQ3RELE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFFdEUsSUFBSSxjQUFjLENBQUM7UUFFbkIsSUFBSTtZQUNGLGdFQUFnRTtZQUNoRSxNQUFNLGVBQWUsR0FBRyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUMvQyxJQUFJLHlCQUF5QixDQUFDLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQ3hELENBQUM7WUFFRixJQUFJLE9BQU8sZUFBZSxDQUFDLFFBQVEsS0FBSyxRQUFRLEVBQUU7Z0JBQ2hELE1BQU0sSUFBSSx3QkFBd0IsQ0FDaEMsNEJBQTRCLENBQUMsd0JBQXdCLEVBQ3JELHlDQUF5QyxDQUMxQyxDQUFDO2FBQ0g7WUFFRCxj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LEVBQ0QsRUFBNEIsQ0FDN0IsQ0FBQztZQUNGLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRztnQkFDdEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixPQUFPLEVBQUUsVUFBVTthQUNwQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBDbG91ZEZvcm1hdGlvblNlcnZpY2VFeGNlcHRpb24sXG4gIERlc2NyaWJlU3RhY2tzQ29tbWFuZCxcbiAgR2V0VGVtcGxhdGVTdW1tYXJ5Q29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXQsXG4gIEJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneSxcbiAgTWFpblN0YWNrTmFtZVJlc29sdmVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IGJhY2tlbmRPdXRwdXRTdGFja01ldGFkYXRhU2NoZW1hIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dENsaWVudEVycm9yLFxuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLFxufSBmcm9tICcuL2luZGV4LmpzJztcblxuLyoqXG4gKiBHZXRzIEFtcGxpZnkgYmFja2VuZCBvdXRwdXRzIGZyb20gc3RhY2sgbWV0YWRhdGEgYW5kIG91dHB1dHNcbiAqL1xuZXhwb3J0IGNsYXNzIFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0UmV0cmlldmFsU3RyYXRlZ3lcbiAgaW1wbGVtZW50cyBCYWNrZW5kT3V0cHV0UmV0cmlldmFsU3RyYXRlZ3lcbntcbiAgLyoqXG4gICAqIEluc3RhbnRpYXRlIHdpdGggYSBDbG91ZEZvcm1hdGlvbkNsaWVudCBhbmQgYSBTdGFja05hbWVSZXNvbHZlclxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBjZm5DbGllbnQ6IENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3RhY2tOYW1lUmVzb2x2ZXI6IE1haW5TdGFja05hbWVSZXNvbHZlclxuICApIHt9XG5cbiAgLyoqXG4gICAqIFJlc29sdmVzIHRoZSBzdGFja05hbWUsIHRoZW4gcXVlcmllcyBDRk4gZm9yIHRoZSBzdGFjayBtZXRhZGF0YSBhbmQgb3V0cHV0c1xuICAgKlxuICAgKiBJdCBjb21iaW5lcyB0aGUgbWV0YWRhdGEgYW5kIG91dHB1dHMgdG8gcmVjb25zdHJ1Y3QgdGhlIGRhdGEgb2JqZWN0IHRoYXQgd2FzIHByb3ZpZGVkIGJ5IHRoZSBBbXBsaWZ5IGNvbnN0cnVjdHMgd2hlbiB3cml0aW5nIHRoZSBvdXRwdXQuXG4gICAqIEV4Y2VwdCBub3cgdGhlIGRhdGEgY29udGFpbnMgdGhlIHJlc29sdmVkIHZhbHVlcyBvZiB0aGUgZGVwbG95ZWQgcmVzb3VyY2VzIHJhdGhlciB0aGFuIENGTiByZWZlcmVuY2VzXG4gICAqL1xuICBmZXRjaEJhY2tlbmRPdXRwdXQgPSBhc3luYyAoKTogUHJvbWlzZTxCYWNrZW5kT3V0cHV0PiA9PiB7XG4gICAgY29uc3Qgc3RhY2tOYW1lID0gYXdhaXQgdGhpcy5zdGFja05hbWVSZXNvbHZlci5yZXNvbHZlTWFpblN0YWNrTmFtZSgpO1xuXG4gICAgbGV0IG1ldGFkYXRhT2JqZWN0O1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldFRlbXBsYXRlU3VtbWFyeSBpbmNsdWRlcyB0aGUgdGVtcGxhdGUgbWV0YWRhdGEgYXMgYSBzdHJpbmdcbiAgICAgIGNvbnN0IHRlbXBsYXRlU3VtbWFyeSA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICAgIG5ldyBHZXRUZW1wbGF0ZVN1bW1hcnlDb21tYW5kKHsgU3RhY2tOYW1lOiBzdGFja05hbWUgfSlcbiAgICAgICk7XG5cbiAgICAgIGlmICh0eXBlb2YgdGVtcGxhdGVTdW1tYXJ5Lk1ldGFkYXRhICE9PSAnc3RyaW5nJykge1xuICAgICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTUVUQURBVEFfUkVUUklFVkFMX0VSUk9SLFxuICAgICAgICAgICdTdGFjayB0ZW1wbGF0ZSBtZXRhZGF0YSBpcyBub3QgYSBzdHJpbmcnXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIG1ldGFkYXRhT2JqZWN0ID0gSlNPTi5wYXJzZSh0ZW1wbGF0ZVN1bW1hcnkuTWV0YWRhdGEpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQ2xvdWRGb3JtYXRpb25TZXJ2aWNlRXhjZXB0aW9uICYmXG4gICAgICAgIGVycm9yLm1lc3NhZ2Uuc3RhcnRzV2l0aCgnU3RhY2sgd2l0aCBpZCcpICYmXG4gICAgICAgIGVycm9yLm1lc3NhZ2UuZW5kc1dpdGgoJ2RvZXMgbm90IGV4aXN0JylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTk9fU1RBQ0tfRk9VTkQsXG4gICAgICAgICAgYFN0YWNrIHdpdGggaWQgJHtzdGFja05hbWV9IGRvZXMgbm90IGV4aXN0YFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG5cbiAgICAvLyBwYXJzZSBhbmQgdmFsaWRhdGUgdGhlIG1ldGFkYXRhIG9iamVjdFxuICAgIGNvbnN0IGJhY2tlbmRPdXRwdXRNZXRhZGF0YSA9XG4gICAgICBiYWNrZW5kT3V0cHV0U3RhY2tNZXRhZGF0YVNjaGVtYS5wYXJzZShtZXRhZGF0YU9iamVjdCk7XG5cbiAgICAvLyBEZXNjcmliZVN0YWNrcyBpbmNsdWRlcyB0aGUgdGVtcGxhdGUgb3V0cHV0XG4gICAgY29uc3Qgc3RhY2tEZXNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuY2ZuQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgRGVzY3JpYmVTdGFja3NDb21tYW5kKHsgU3RhY2tOYW1lOiBzdGFja05hbWUgfSlcbiAgICApO1xuXG4gICAgY29uc3Qgb3V0cHV0cyA9IHN0YWNrRGVzY3JpcHRpb24/LlN0YWNrcz8uWzBdPy5PdXRwdXRzO1xuICAgIGlmIChzdGFja0Rlc2NyaXB0aW9uLlN0YWNrcz8uWzBdLlN0YWNrU3RhdHVzPy5lbmRzV2l0aCgnX0lOX1BST0dSRVNTJykpIHtcbiAgICAgIGNvbnN0IGRlcGxveW1lbnRUeXBlID1cbiAgICAgICAgc3RhY2tEZXNjcmlwdGlvbi5TdGFja3M/LlswXS5UYWdzPy5maW5kKFxuICAgICAgICAgICh0YWcpID0+IHRhZy5LZXkgPT09ICdhbXBsaWZ5OmRlcGxveW1lbnQtdHlwZSdcbiAgICAgICAgKT8uVmFsdWUgPz8gJ3NhbmRib3gnO1xuICAgICAgdGhyb3cgbmV3IEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvcihcbiAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5ERVBMT1lNRU5UX0lOX1BST0dSRVNTLFxuICAgICAgICBgVGhpcyAke2RlcGxveW1lbnRUeXBlfSBkZXBsb3ltZW50IGlzIGluIHByb2dyZXNzLiBSZS1ydW4gdGhpcyBjb21tYW5kIG9uY2UgdGhlIGRlcGxveW1lbnQgY29tcGxldGVzLmBcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChvdXRwdXRzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IG5ldyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuTk9fT1VUUFVUU19GT1VORCxcbiAgICAgICAgJ1N0YWNrIG91dHB1dHMgYXJlIHVuZGVmaW5lZCdcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gb3V0cHV0cyBpcyBhIGxpc3Qgb2Ygb3V0cHV0IGVudHJpZXMuIGhlcmUgd2UgdHVybiB0aGF0IGludG8gYSBSZWNvcmQ8bmFtZSwgdmFsdWU+IG9iamVjdFxuICAgIGNvbnN0IHN0YWNrT3V0cHV0UmVjb3JkID0gb3V0cHV0c1xuICAgICAgLmZpbHRlcigob3V0cHV0KSA9PiAhIW91dHB1dC5PdXRwdXRWYWx1ZSAmJiAhIW91dHB1dC5PdXRwdXRLZXkpXG4gICAgICAucmVkdWNlKFxuICAgICAgICAoYWNjdW11bGF0b3IsIG91dHB1dEVudHJ5KSA9PiAoe1xuICAgICAgICAgIC4uLmFjY3VtdWxhdG9yLFxuICAgICAgICAgIC8vIGl0J3Mgc2FmZSB0byBkaXNhYmxlIHRoaXMgcnVsZSBiZWNhdXNlIHdlJ3ZlIGFscmVhZHkgZmlsdGVyZWQgb3V0IHBvdGVudGlhbGx5IHVuZGVmaW5lZCBvdXRwdXRzXG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgICAgICBbb3V0cHV0RW50cnkuT3V0cHV0S2V5IV06IG91dHB1dEVudHJ5Lk91dHB1dFZhbHVlISxcbiAgICAgICAgfSksXG4gICAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbiAgICAgICk7XG5cbiAgICAvLyBub3cgd2UgaXRlcmF0ZSBvdmVyIHRoZSBtZXRhZGF0YSBlbnRyaWVzIGFuZCByZWNvbnN0cnVjdCB0aGUgZGF0YSBvYmplY3QgYmFzZWQgb24gdGhlIHN0YWNrT3V0cHV0cyB0aGF0IGVhY2ggY29uc3RydWN0IHBhY2thZ2Ugc2V0XG4gICAgY29uc3QgcmVzdWx0OiBCYWNrZW5kT3V0cHV0ID0ge307XG4gICAgT2JqZWN0LmVudHJpZXMoYmFja2VuZE91dHB1dE1ldGFkYXRhKS5mb3JFYWNoKChbb3V0cHV0S2V5TmFtZSwgZW50cnldKSA9PiB7XG4gICAgICBjb25zdCBvdXRwdXREYXRhID0gZW50cnkuc3RhY2tPdXRwdXRzLnJlZHVjZShcbiAgICAgICAgKGFjY3VtdWxhdG9yLCBvdXRwdXROYW1lKSA9PiB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgc3RhY2tPdXRwdXRSZWNvcmRbb3V0cHV0TmFtZV0gPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAgICAgc3RhY2tPdXRwdXRSZWNvcmRbb3V0cHV0TmFtZV0gPT09ICcnXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gYWNjdW11bGF0b3I7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5hY2N1bXVsYXRvcixcbiAgICAgICAgICAgIFtvdXRwdXROYW1lXTogc3RhY2tPdXRwdXRSZWNvcmRbb3V0cHV0TmFtZV0sXG4gICAgICAgICAgfTtcbiAgICAgICAgfSxcbiAgICAgICAge30gYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICAgICAgKTtcbiAgICAgIHJlc3VsdFtvdXRwdXRLZXlOYW1lXSA9IHtcbiAgICAgICAgdmVyc2lvbjogZW50cnkudmVyc2lvbixcbiAgICAgICAgcGF5bG9hZDogb3V0cHV0RGF0YSxcbiAgICAgIH07XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcbn1cbiJdfQ==